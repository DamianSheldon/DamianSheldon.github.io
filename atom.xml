<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Hello World]]></title>
  <link href="http://DamianSheldon.github.io/atom.xml" rel="self"/>
  <link href="http://DamianSheldon.github.io/"/>
  <updated>2017-04-10T14:32:04+08:00</updated>
  <id>http://DamianSheldon.github.io/</id>
  <author>
    <name><![CDATA[Sheldon]]></name>
    <email><![CDATA[dongmeilianghy@sina.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[输出自定义尺寸视频]]></title>
    <link href="http://DamianSheldon.github.io/blog/how-to-specify-a-resolution-for-output-video.html"/>
    <updated>2017-04-10T10:12:09+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/how-to-specify-a-resolution-for-output-video</id>
    <content type="html"><![CDATA[<p>最近要做的一个项目中要拍摄视频，于是就开始来研究视频。看了几遍 AVFoundation Programming Guide 之后也写了个 Demo，把基本功能都过了一遍。这其中有意思的一件事情是我发现微信拍摄短视频的尺寸是 540x944, 这尺寸很奇怪，不是任何一个预设值。不清楚微信为什么用这么一个尺寸，但我想搞清楚怎么输出自定义尺寸的视频。</p>

<p>AVFoundation 捕获数据输出时，各组件的关系如下：</p>

<div style="text-align:center" markdown="1">
                                                                                           <img name="Capture Detail" src="http://DamianSheldon.github.io/images/captureDetail_2x.png">
                                                                                        </div>


<p>要想输出自定义尺寸的视频，我们可以从输入端和输出端着手。但是从文档来看，并没有提供可以自定捕获尺寸的方法，所以只能从输出端着手。</p>

<!--more-->


<p>首先我用 AVCaptureMovieFileOutput 做输出，然后调用 <code>setOutputSettings(_ outputSettings: [AnyHashable : Any]!, for connection: AVCaptureConnection!)</code> 来达到目标。但是很不幸，控制台输出了异常，查看 AVCaptureMovieFileOutput 的头文件，</p>

<blockquote><p>On iOS, you may only specify the AVVideoCodecKey in the outputSettings. If you specify any other key, an NSInvalidArgumentException will be thrown. See the availableVideoCodecTypes property.</p></blockquote>

<p>所以这个方法行不通。</p>

<p>于是我又尝试用 AVAssetWriter 来接收每一帧捕获的数据，然后按配置输出，理论上来讲这是可行的，实际上只有第一帧数据能成功被接收，之后的数据都会接收失败，具体原因不详。</p>

<p>直接处理每一帧数据失败之后，我又反复翻阅文档，发现编辑章节中提到可以修改 renderSize, 于是又一个想法冒出来，也许可以通过修改 renderSize 来输出自定义尺寸。按照文档编写好相关代码，激动地运行测试。结果得到的是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Optional(Error Domain=AVFoundationErrorDomain Code=-11800 "The operation could not be completed" UserInfo={NSUnderlyingError=0x1700505c0 {Error Domain=NSOSStatusErrorDomain Code=-12108 "(null)"}, NSLocalizedFailureReason=An unknown error occurred (-12108), NSLocalizedDescription=The operation could not be completed})</span></code></pre></td></tr></table></div></figure>


<p>说实话，内心是崩溃的。但对这件事情还是耿耿于怀，又浏览了一下官方示例列表，发现了 AVSimpleEditoriOS,</p>

<blockquote><p>AVSimpleEditor is a simple AVFoundation based movie editing application which exercises the APIs of AVVideoComposition, AVAudioMix and demonstrates how they can be used for simple video editing tasks. It also demonstrates how they interact with playback (AVPlayerItem) and export (AVAssetExportSession). The application performs trim, rotate, crop, add music, add watermark and export. This sample is ARC-enabled.</p></blockquote>

<p>嗯，看到里面提到可以裁剪，于是就想它是怎么做？可以剪成我想要的大小吗？阅读相关的代码片断，原来它就是用的 renderSize 来实现裁剪的，跟我第三种方法的代码基本一致，差别是它是 Objc 写的，我用 Swift 写的。既然它能正常工作，那我就用这份代码来输出自定义尺寸吧。把代码移进来，运行测试，居然输出了指定的尺寸，难道代码用 Objc 和 Swift 写还有这种差别，整个人是懵的，这个原因暂时是不清楚的。</p>

<p>虽然输出的尺寸对了，但是画面没有铺满尺寸，而且方向错了。这有点太虐了，既然都走到这一步，就想那我再试试能不手动把它纠正吧。纠正的方法是使用 transform, 但是文档对它的介绍不详细，我先参考了 QuartZ 2D Programming Guide 中 Transforms 来变换，发现不对，整个画面全变成了黑色，又在 AVSimpleEditoriOS 的注释中发现了新的线索，</p>

<blockquote><p>Note: the point of origin for rotation is the upper left corner of the composition, t3 is to compensate for origin</p></blockquote>

<p>这么说它用的坐标和 QuartZ 2D 还不一样啊，这么坑爹，好吧，只能先确定好它们是怎么变换的。于是我先输出一段没变换的视频，之后每次测试一个变换，用这个办法确认了它们的变换是这样的，变换的原点是屏幕的左上角，Translation 向右是 X 轴的正方向，向下是 Y 轴的正方向; Rotation 的度数为正是按顺时针方向旋转，为负则是逆时针方向旋转；Scaling 的值大于1为放大，小于1则是缩小。</p>

<p>这样我就做了这么一个变换：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>t1 = CGAffineTransformScale(asset.preferredTransform, sx, sy);
</span><span class='line'>
</span><span class='line'>t1 = CGAffineTransformRotate(t1, degreesToRadians(90));
</span><span class='line'>
</span><span class='line'>t1 = CGAffineTransformTranslate(t1, 540, 0);</span></code></pre></td></tr></table></div></figure>


<p>控制台报错了，说这个视频不支持编辑，这是个什么鬼？完全没有道理啊！于是我又把这段代码从下往上一行一行注释，看是谁导致的问题，发现是 <code>t1 = CGAffineTransformRotate(t1, degreesToRadians(90));</code> ，这样我又试着调整变换的顺序，改成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>t1 = CGAffineTransformTranslate(asset.preferredTransform, 540, 0);
</span><span class='line'>
</span><span class='line'>t1 = CGAffineTransformScale(t1, sx, sy);
</span><span class='line'>
</span><span class='line'>t1 = CGAffineTransformRotate(t1, degreesToRadians(90));</span></code></pre></td></tr></table></div></figure>


<p>运行测试，苍天啊，居然可以了。经历这么一出，感觉写代码都成了玄学了, 无力吐槽!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AVFoundation 使用笔记]]></title>
    <link href="http://DamianSheldon.github.io/blog/notes-of-using-avfoundation.html"/>
    <updated>2017-04-06T15:09:30+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/notes-of-using-avfoundation</id>
    <content type="html"><![CDATA[<p>使用一个框架时，我们可能有这么三个问题：</p>

<ol>
<li>这个框架是做什么的？</li>
<li>为什么要使用这个框架而不是其他的框架？</li>
<li>怎么用这个框架？</li>
</ol>


<h3>这个框架是做什么的？</h3>

<p>Apple 在 iOS Technology Overview 中的 Audio Technologies 和 Video Technologies 分别是这么介绍 AVFoundation 的：</p>

<blockquote><p>AV Foundation is an Objective-C interface for managing the recording and playback of audio and video. Use this framework for recording audio and when you need fine-grained control over the audio playback process.</p>

<p>AV Foundation provides advanced video playback and recording capabilities. Use this framework in situations where you need more control over the presentation or recording of video. For example, augmented reality apps could use this framework to layer live video content with other app-provided content.</p></blockquote>

<p>从这两个介绍中我们可以知道 AVFoundation 是用来播放和录制音频和视频的。</p>

<p>在 AVFoundation Programming Guide 中则是这么介绍的：</p>

<blockquote><p>AVFoundation is one of several frameworks that you can use to play and create time-based audiovisual media. It provides an Objective-C interface you use to work on a detailed level with time-based audiovisual data. For example, you can use it to examine, create, edit, or reencode media files. You can also get input streams from devices and manipulate video during realtime capture and playback.</p></blockquote>

<p>从这里我们可以知道它不仅可以播放和创建基于时间的视听媒体，还可以让我们在很细微的层面去操作这些视听数据。例如，你可以使用它检查、创建、编辑或者重编码媒体文件。你还可以用它从设备那里拿到输出流，并且可以在实时的捕获和播放过程中操作视频。</p>

<p>所以结论就是：这个框架是处理音频和视频的，而且处理的粒度可以非常细。</p>

<!--more-->


<h3>为什么要用这个框架而不是其他的框架？</h3>

<p>在选择框架时我们的原则应该首先是使用 Apple 自己提供的框架，其次才是第三方框架。在 Apple 自带的框架中选择时，又应该按抽象程度从高到低去选择。在音频技术中，抽象程度是这样的：Media Player framework > AVFoundation > OpenAL > Core Audio; 在视频技术中：UIImagePickerController > AVKit > AVFoundation > Core Media.</p>

<p>在音视频技术中，抽象程度高于 AVFoundation 的技术多侧重于简单的播放和录制，要进行其他的操作时则要使用 AVFoundation，而且它的能力也比较强，所以通常要对媒体数据进行处理时，我们会经常使用到它，它不满足要求时才去寻找其他的技术。</p>

<h3>怎么用这个框架？</h3>

<p>前面提到 AVFoundation 是用来播放、录制和操作视听数据的，操作视听数据则可以细分为 Editing 和 Exporting，所以我们这里会介绍这个框架:Playback, Capture, Editing 和 Exporting 四个大方面的使用。</p>

<h4>Playback</h4>

<p>在介绍怎么使用 AVFoundation 播放视听媒体之前，我们还要聊聊在 AVFoundation 中是怎么表示媒体的。AVFoundation 中用来代表媒体最主要的类是 AVAsset, 一个 AVAsset 实例是一片或多片媒体数据(音频曲目和视频轨迹)集合的综合代表。它提供关于这个集合的信息，例如它的标题，持续时间，本身的展示尺寸等等。AVAsset 没有绑定特定的数据类型。它是其他用来从指定 URL 媒体创建资产实例和创建新构成的父类。</p>

<p>资产中每片单独的媒体数据是统一的类型称为track. 在经典的简单场景，一个轨迹代表音频组件，另一个轨迹代表视频组件；在一个复杂的构成中，这里可能有多个重叠的音视频轨迹。</p>

<p>你为播放配置资产的方法取决于你想要播放资产的种类，广义上来讲，这里有两大类型：基于文件的资产和基于流的资产。</p>

<ol>
<li><p>加载和播放基于文件的资产。</p>

<ul>
<li>Create an asset using AVURLAsset.</li>
<li>Create an instance of AVPlayerItem using the asset.</li>
<li>Associate the item with an instance of AVPlayer.</li>
<li>Wait until the item’s status property indicates that it’s ready to play (typically you use key-value observing to receive a notification when the status changes).</li>
</ul>
</li>
<li><p>为播放创建和准备一个 HTTP 实时流。</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSURL *url = [NSURL URLWithString:@"&lt;#Live stream URL#&gt;];
</span><span class='line'>// You may find a test stream at &lt;http://devimages.apple.com/iphone/samples/bipbop/bipbopall.m3u8&gt;.
</span><span class='line'>self.playerItem = [AVPlayerItem playerItemWithURL:url];
</span><span class='line'>[playerItem addObserver:self forKeyPath:@"status" options:0 context:&ItemStatusContext];
</span><span class='line'>self.player = [AVPlayer playerWithPlayerItem:playerItem];</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>如果你不知道你拥有的 URL 是什么类型。</p>

<p> 1)Try to initialize an AVURLAsset using the URL, then load its tracks key.
 If the tracks load successfully, then you create a player item for the asset.</p>

<p> 2)If 1 fails, create an AVPlayerItem directly from the URL.
 Observe the player’s status property to determine whether it becomes playable.</p></li>
</ol>


<h4>Capture</h4>

<p>为了管理来自相机、麦克风的捕获，你组装对象去表示输入和输出，使用 AVCaptureSession 的实例来协调它们之间的数据流。你最少需要：</p>

<ul>
<li>一个 AVCaptureDevice 的实例来表示输入设备，例如相机或麦克风</li>
<li>一个 AVCaptureInput 具体子类的实例去配置来自输入设备的端口</li>
<li>一个 AVCaptureOutput 具体子类的实例去管理到电影或静态图片的输出</li>
<li>一个 AVCaptureSession 的实例来协调从输入到输出的数据流</li>
</ul>


<p>Capturing Video Frames as UIImage Objects</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1. Create and Configure a Capture Session
</span><span class='line'>AVCaptureSession *session = [[AVCaptureSession alloc] init];
</span><span class='line'>session.sessionPreset = AVCaptureSessionPresetMedium;
</span><span class='line'>
</span><span class='line'>// 2. Create and Configure the Device and Device Input
</span><span class='line'>AVCaptureDevice *device =
</span><span class='line'>[AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];
</span><span class='line'>
</span><span class='line'>NSError *error = nil;
</span><span class='line'>AVCaptureDeviceInput *input =
</span><span class='line'>[AVCaptureDeviceInput deviceInputWithDevice:device error:&error];
</span><span class='line'>if (!input) {
</span><span class='line'>    // Handle the error appropriately.
</span><span class='line'>}
</span><span class='line'>[session addInput:input];
</span><span class='line'>
</span><span class='line'>// 3. Create and Configure the Video Data Output
</span><span class='line'>AVCaptureVideoDataOutput *output = [[AVCaptureVideoDataOutput alloc] init];
</span><span class='line'>[session addOutput:output];
</span><span class='line'>output.videoSettings =
</span><span class='line'>@{ (NSString *)kCVPixelBufferPixelFormatTypeKey : @(kCVPixelFormatType_32BGRA) };
</span><span class='line'>output.minFrameDuration = CMTimeMake(1, 15);
</span><span class='line'>
</span><span class='line'>dispatch_queue_t queue = dispatch_queue_create("MyQueue", NULL);
</span><span class='line'>[output setSampleBufferDelegate:self queue:queue];
</span><span class='line'>dispatch_release(queue);
</span><span class='line'>
</span><span class='line'>// 4. Implement the Sample Buffer Delegate Method
</span><span class='line'>- (void)captureOutput:(AVCaptureOutput *)captureOutput
</span><span class='line'>didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer
</span><span class='line'>fromConnection:(AVCaptureConnection *)connection {
</span><span class='line'>
</span><span class='line'>    UIImage *image = imageFromSampleBuffer(sampleBuffer);
</span><span class='line'>    // Add your code here that uses the image.
</span><span class='line'>}
</span><span class='line'>// 5. Starting and Stopping Recording
</span><span class='line'>NSString *mediaType = AVMediaTypeVideo;
</span><span class='line'>
</span><span class='line'>[AVCaptureDevice requestAccessForMediaType:mediaType completionHandler:^(BOOL granted) {
</span><span class='line'>    if (granted)
</span><span class='line'>    {
</span><span class='line'>        //Granted access to mediaType
</span><span class='line'>        [self setDeviceAuthorized:YES];
</span><span class='line'>    }
</span><span class='line'>    else
</span><span class='line'>    {
</span><span class='line'>        //Not granted access to mediaType
</span><span class='line'>        dispatch_async(dispatch_get_main_queue(), ^{
</span><span class='line'>                [[[UIAlertView alloc] initWithTitle:@"AVCam!"
</span><span class='line'>                message:@"AVCam doesn't have permission to use Camera, please change privacy settings"
</span><span class='line'>                delegate:self
</span><span class='line'>                cancelButtonTitle:@"OK"
</span><span class='line'>                otherButtonTitles:nil] show];
</span><span class='line'>                [self setDeviceAuthorized:NO];
</span><span class='line'>                });
</span><span class='line'>    }
</span><span class='line'>}];
</span><span class='line'>
</span><span class='line'>[session startRunning];
</span><span class='line'>
</span><span class='line'>// To stop recording, you send the session a stopRunning message.</span></code></pre></td></tr></table></div></figure>


<h4>Editing</h4>

<p>AVFoundation 框架提供了丰富的类来方便编辑音视资产。编辑 API 的核心是 composition. 一个 Compostion 是简单的来自一个或多个不同媒体资产的聚合。AVMutableCompostion 类提供插入和移除轨迹的接口，并且管理它们的时间顺序。图 3-1 展示了一个新的 composition
是如何用由现存资产联合形成的新资产拼装在一起的。如果你所有想要做的就是将多个资产按顺序的合成到一个单一的文件，那么这就是你得知道的所有细节。如果你想对你 compostion 里面的轨迹进行自定义的音频或视频处理，你相应地需要引入一个 audio mix 或 video compostion.</p>

<div style="text-align:center" markdown="1">
    <img name="AVMutableComposition" src="http://DamianSheldon.github.io/images/avmutablecomposition_2x.png">
</div>


<p>使用 AVMutableAudioMix 类， 你可以在你的 composition 的音频轨迹上进行自定义音频处理，像图 3-2 显示的。你现在可以指定一个最大的音量或者设置 volume ramp.</p>

<div style="text-align:center" markdown="1">
    <img name="AVMutableAudioMix" src="http://DamianSheldon.github.io/images/avmutableaudiomix_2x.png">
</div>


<p>你为了编辑可以像图 3-3 那样使用 AVMutableVideoCompostion 类来直接操作你 compostion 里的视频轨迹. 拥有一个 video composition, 你可以为输出视频指定想要的渲染尺寸,缩放以及帧率。通过一个 video composition&rsquo;s instruction(由 AVMutableVideoCompositionInstruction 类代表)，你可以修改你视频的背景颜色和应用 layer instructions. 这些 layer instructions（由 AVMutableVideoCompositionLayerInstruction 类代表) 可以用来应用 transforms, transform ramps, opacity and opacity ramps。Video
composition 类使用 animationTool 属性赋予你引入来自 Core Animation 框架效果的能力。</p>

<div style="text-align:center" markdown="1">
    <img name="AVMutableVideoCompostion" src="http://DamianSheldon.github.io/images/avmutablevideocomposition_2x.png">
</div>


<p>为了把你的 compostion 和 audio mix, video compostion 混合，你使用一个 AVAssetExportSession 对象，像 图 3-4 那样。你用你的 compostion 初始化 export session, 然后简单地把你的 audio mix 和 video composition 相应地赋值给 audioMix 和 videoComposition 属性。</p>

<div style="text-align:center" markdown="1">
    <img name="AVAssetExportSession" src="http://DamianSheldon.github.io/images/puttingitalltogether_2x.png">
</div>


<p>Combining Multiple Assets and Saving the Result to the Camera Roll</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1. Creating the Composition
</span><span class='line'>AVMutableComposition *mutableComposition = [AVMutableComposition composition];
</span><span class='line'>AVMutableCompositionTrack *videoCompositionTrack = [mutableComposition addMutableTrackWithMediaType:AVMediaTypeVideo preferredTrackID:kCMPersistentTrackID_Invalid];
</span><span class='line'>AVMutableCompositionTrack *audioCompositionTrack = [mutableComposition addMutableTrackWithMediaType:AVMediaTypeAudio preferredTrackID:kCMPersistentTrackID_Invalid];
</span><span class='line'>
</span><span class='line'>// 2. Adding the Assets
</span><span class='line'>AVAssetTrack *firstVideoAssetTrack = [[firstVideoAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
</span><span class='line'>AVAssetTrack *secondVideoAssetTrack = [[secondVideoAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
</span><span class='line'>[videoCompositionTrack insertTimeRange:CMTimeRangeMake(kCMTimeZero, firstVideoAssetTrack.timeRange.duration) ofTrack:firstVideoAssetTrack atTime:kCMTimeZero error:nil];
</span><span class='line'>[videoCompositionTrack insertTimeRange:CMTimeRangeMake(kCMTimeZero, secondVideoAssetTrack.timeRange.duration) ofTrack:secondVideoAssetTrack atTime:firstVideoAssetTrack.timeRange.duration error:nil];
</span><span class='line'>[audioCompositionTrack insertTimeRange:CMTimeRangeMake(kCMTimeZero, CMTimeAdd(firstVideoAssetTrack.timeRange.duration, secondVideoAssetTrack.timeRange.duration)) ofTrack:[[audioAsset tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0] atTime:kCMTimeZero error:nil];
</span><span class='line'>
</span><span class='line'>// 3. Checking the Video Orientations
</span><span class='line'>BOOL isFirstVideoPortrait = NO;
</span><span class='line'>CGAffineTransform firstTransform = firstVideoAssetTrack.preferredTransform;
</span><span class='line'>// Check the first video track's preferred transform to determine if it was recorded in portrait mode.
</span><span class='line'>if (firstTransform.a == 0 && firstTransform.d == 0 && (firstTransform.b == 1.0 || firstTransform.b == -1.0) && (firstTransform.c == 1.0 || firstTransform.c == -1.0)) {
</span><span class='line'>        isFirstVideoPortrait = YES;
</span><span class='line'>}
</span><span class='line'>BOOL isSecondVideoPortrait = NO;
</span><span class='line'>CGAffineTransform secondTransform = secondVideoAssetTrack.preferredTransform;
</span><span class='line'>// Check the second video track's preferred transform to determine if it was recorded in portrait mode.
</span><span class='line'>if (secondTransform.a == 0 && secondTransform.d == 0 && (secondTransform.b == 1.0 || secondTransform.b == -1.0) && (secondTransform.c == 1.0 || secondTransform.c == -1.0)) {
</span><span class='line'>        isSecondVideoPortrait = YES;
</span><span class='line'>}
</span><span class='line'>if ((isFirstVideoAssetPortrait && !isSecondVideoAssetPortrait) || (!isFirstVideoAssetPortrait && isSecondVideoAssetPortrait)) {
</span><span class='line'>        UIAlertView *incompatibleVideoOrientationAlert = [[UIAlertView alloc] initWithTitle:@"Error!" message:@"Cannot combine a video shot in portrait mode with a video shot in landscape mode." delegate:self cancelButtonTitle:@"Dismiss" otherButtonTitles:nil];
</span><span class='line'>            [incompatibleVideoOrientationAlert show];
</span><span class='line'>                return;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// 4. Applying the Video Composition Layer Instructions
</span><span class='line'>AVMutableVideoCompositionInstruction *firstVideoCompositionInstruction = [AVMutableVideoCompositionInstruction videoCompositionInstruction];
</span><span class='line'>// Set the time range of the first instruction to span the duration of the first video track.
</span><span class='line'>firstVideoCompositionInstruction.timeRange = CMTimeRangeMake(kCMTimeZero, firstVideoAssetTrack.timeRange.duration);
</span><span class='line'>AVMutableVideoCompositionInstruction * secondVideoCompositionInstruction = [AVMutableVideoCompositionInstruction videoCompositionInstruction];
</span><span class='line'>// Set the time range of the second instruction to span the duration of the second video track.
</span><span class='line'>secondVideoCompositionInstruction.timeRange = CMTimeRangeMake(firstVideoAssetTrack.timeRange.duration, CMTimeAdd(firstVideoAssetTrack.timeRange.duration, secondVideoAssetTrack.timeRange.duration));
</span><span class='line'>AVMutableVideoCompositionLayerInstruction *firstVideoLayerInstruction = [AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:videoCompositionTrack];
</span><span class='line'>// Set the transform of the first layer instruction to the preferred transform of the first video track.
</span><span class='line'>[firstVideoLayerInstruction setTransform:firstTransform atTime:kCMTimeZero];
</span><span class='line'>AVMutableVideoCompositionLayerInstruction *secondVideoLayerInstruction = [AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:videoCompositionTrack];
</span><span class='line'>// Set the transform of the second layer instruction to the preferred transform of the second video track.
</span><span class='line'>[secondVideoLayerInstruction setTransform:secondTransform atTime:firstVideoAssetTrack.timeRange.duration];
</span><span class='line'>firstVideoCompositionInstruction.layerInstructions = @[firstVideoLayerInstruction];
</span><span class='line'>secondVideoCompositionInstruction.layerInstructions = @[secondVideoLayerInstruction];
</span><span class='line'>AVMutableVideoComposition *mutableVideoComposition = [AVMutableVideoComposition videoComposition];
</span><span class='line'>mutableVideoComposition.instructions = @[firstVideoCompositionInstruction, secondVideoCompositionInstruction];
</span><span class='line'>
</span><span class='line'>// 5. Setting the Render Size and Frame Duration
</span><span class='line'>CGSize naturalSizeFirst, naturalSizeSecond;
</span><span class='line'>// If the first video asset was shot in portrait mode, then so was the second one if we made it here.
</span><span class='line'>if (isFirstVideoAssetPortrait) {
</span><span class='line'>    // Invert the width and height for the video tracks to ensure that they display properly.
</span><span class='line'>        naturalSizeFirst = CGSizeMake(firstVideoAssetTrack.naturalSize.height, firstVideoAssetTrack.naturalSize.width);
</span><span class='line'>            naturalSizeSecond = CGSizeMake(secondVideoAssetTrack.naturalSize.height, secondVideoAssetTrack.naturalSize.width);
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>    // If the videos weren't shot in portrait mode, we can just use their natural sizes.
</span><span class='line'>        naturalSizeFirst = firstVideoAssetTrack.naturalSize;
</span><span class='line'>            naturalSizeSecond = secondVideoAssetTrack.naturalSize;
</span><span class='line'>}
</span><span class='line'>float renderWidth, renderHeight;
</span><span class='line'>// Set the renderWidth and renderHeight to the max of the two videos widths and heights.
</span><span class='line'>if (naturalSizeFirst.width &gt; naturalSizeSecond.width) {
</span><span class='line'>        renderWidth = naturalSizeFirst.width;
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>        renderWidth = naturalSizeSecond.width;
</span><span class='line'>}
</span><span class='line'>if (naturalSizeFirst.height &gt; naturalSizeSecond.height) {
</span><span class='line'>        renderHeight = naturalSizeFirst.height;
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>        renderHeight = naturalSizeSecond.height;
</span><span class='line'>}
</span><span class='line'>mutableVideoComposition.renderSize = CGSizeMake(renderWidth, renderHeight);
</span><span class='line'>// Set the frame duration to an appropriate value (i.e. 30 frames per second for video).
</span><span class='line'>mutableVideoComposition.frameDuration = CMTimeMake(1,30);
</span><span class='line'>
</span><span class='line'>// 6. Exporting the Composition and Saving it to the Camera Roll
</span><span class='line'>// Create a static date formatter so we only have to initialize it once.
</span><span class='line'>static NSDateFormatter *kDateFormatter;
</span><span class='line'>if (!kDateFormatter) {
</span><span class='line'>        kDateFormatter = [[NSDateFormatter alloc] init];
</span><span class='line'>            kDateFormatter.dateStyle = NSDateFormatterMediumStyle;
</span><span class='line'>                kDateFormatter.timeStyle = NSDateFormatterShortStyle;
</span><span class='line'>}
</span><span class='line'>// Create the export session with the composition and set the preset to the highest quality.
</span><span class='line'>AVAssetExportSession *exporter = [[AVAssetExportSession alloc] initWithAsset:mutableComposition presetName:AVAssetExportPresetHighestQuality];
</span><span class='line'>// Set the desired output URL for the file created by the export process.
</span><span class='line'>exporter.outputURL = [[[[NSFileManager defaultManager] URLForDirectory:NSDocumentDirectory inDomain:NSUserDomainMask appropriateForURL:nil create:@YES error:nil] URLByAppendingPathComponent:[kDateFormatter stringFromDate:[NSDate date]]] URLByAppendingPathExtension:CFBridgingRelease(UTTypeCopyPreferredTagWithClass((CFStringRef)AVFileTypeQuickTimeMovie, kUTTagClassFilenameExtension))];
</span><span class='line'>// Set the output file type to be a QuickTime movie.
</span><span class='line'>exporter.outputFileType = AVFileTypeQuickTimeMovie;
</span><span class='line'>exporter.shouldOptimizeForNetworkUse = YES;
</span><span class='line'>exporter.videoComposition = mutableVideoComposition;
</span><span class='line'>// Asynchronously export the composition to a video file and save this file to the camera roll once export completes.
</span><span class='line'>[exporter exportAsynchronouslyWithCompletionHandler:^{
</span><span class='line'>        dispatch_async(dispatch_get_main_queue(), ^{
</span><span class='line'>                    if (exporter.status == AVAssetExportSessionStatusCompleted) {
</span><span class='line'>                                    ALAssetsLibrary *assetsLibrary = [[ALAssetsLibrary alloc] init];
</span><span class='line'>                                                if ([assetsLibrary videoAtPathIsCompatibleWithSavedPhotosAlbum:exporter.outputURL]) {
</span><span class='line'>                                                                    [assetsLibrary writeVideoAtPathToSavedPhotosAlbum:exporter.outputURL completionBlock:NULL];
</span><span class='line'>                                                                                }
</span><span class='line'>                                                                                        }
</span><span class='line'>                                                                                            });
</span><span class='line'>}];
</span></code></pre></td></tr></table></div></figure>


<h4>Exporting</h4>

<p>为了读写视听资产，你必须使用 AVFoundation 框架提供的导出 API. AVAssetExportSession 类为简单的导出需求提供接口，例如修改文件格式或者裁剪资产的长度。对于更深的导出需求，使用 AVAssetReader 和 AVAssetWriter 类。</p>

<p>当你想要操作资产的内容时使用 AVAssetReader. 例如，你可能读取资产中的音频轨迹去生成表示声波的图形。使用 AVAssetWriter 从像 sample buffers 或 still images 的媒体中生成资产。</p>

<p>Reading an Asset</p>

<p>每个 AVAssetReader 对象一次只能关联单个的资产， 但是这个资产可能包含多个轨迹。基于这个原因，为了配置如何去读取媒体数据，你必须在读取前给你的 asset reader 赋予 AVAssetReaderOutput 的具体子类。这里有三个具体的子类：AVAssetReaderTrackOutput, AVAssetReaderAudioMixOutput 和 AVAssetReaderVideoCompositionOutput.</p>

<ol>
<li>Creating the Asset Reader</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSError *outError;
</span><span class='line'>AVAsset *someAsset = &lt;#AVAsset that you want to read#&gt;;
</span><span class='line'>AVAssetReader *assetReader = [AVAssetReader assetReaderWithAsset:someAsset error:&outError];
</span><span class='line'>BOOL success = (assetReader != nil);</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Setting Up the Asset Reader Outputs</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>AVAsset *localAsset = assetReader.asset;
</span><span class='line'>// Get the audio track to read.
</span><span class='line'>AVAssetTrack *audioTrack = [[localAsset tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0];
</span><span class='line'>// Decompression settings for Linear PCM
</span><span class='line'>NSDictionary *decompressionAudioSettings = @{ AVFormatIDKey : [NSNumber numberWithUnsignedInt:kAudioFormatLinearPCM] };
</span><span class='line'>// Create the output with the audio track and decompression settings.
</span><span class='line'>AVAssetReaderOutput *trackOutput = [AVAssetReaderTrackOutput assetReaderTrackOutputWithTrack:audioTrack outputSettings:decompressionAudioSettings];
</span><span class='line'>// Add the output to the reader if possible.
</span><span class='line'>if ([assetReader canAddOutput:trackOutput])
</span><span class='line'>        [assetReader addOutput:trackOutput];</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Reading the Asset’s Media Data</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Start the asset reader up.
</span><span class='line'>[self.assetReader startReading];
</span><span class='line'>BOOL done = NO;
</span><span class='line'>while (!done)
</span><span class='line'>{
</span><span class='line'>    // Copy the next sample buffer from the reader output.
</span><span class='line'>    CMSampleBufferRef sampleBuffer = [self.assetReaderOutput copyNextSampleBuffer];
</span><span class='line'>    if (sampleBuffer)
</span><span class='line'>    {
</span><span class='line'>        // Do something with sampleBuffer here.
</span><span class='line'>        CFRelease(sampleBuffer);
</span><span class='line'>        sampleBuffer = NULL;
</span><span class='line'>    }
</span><span class='line'>    else
</span><span class='line'>    {
</span><span class='line'>        // Find out why the asset reader output couldn't copy another sample buffer.
</span><span class='line'>        if (self.assetReader.status == AVAssetReaderStatusFailed)
</span><span class='line'>        {
</span><span class='line'>            NSError *failureError = self.assetReader.error;
</span><span class='line'>            // Handle the error here.
</span><span class='line'>        }
</span><span class='line'>        else
</span><span class='line'>        {
</span><span class='line'>            // The asset reader output has read all of its samples.
</span><span class='line'>            done = YES;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Writing an Asset</p>

<p>AVAssetWriter 类将多个来源的媒体数据按指定的文件格式写出到单一的文件。你不需要将你的 asset writer 对象和指定的资产关联起来，但是你必须为你想要创建的输出文件使用一个 asset writer. 因为一个 asset writer 可以写出来自多个源的媒体数据，你必须为你想要写出到输出文件的单独轨迹创建一个 AVAssetWriterInput 对象。每个 AVAssetWriterInput 对象期望收到 CMSampleBufferRef 对象格式的数据，但是如果你想追加 CVPixelBufferRef 对象到你的 asset writer input, 使用 AVAssetWriterInputPixelBufferAdaptor 类。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1. Creating the Asset Writer
</span><span class='line'>NSError *outError;
</span><span class='line'>NSURL *outputURL = &lt;#NSURL object representing the URL where you want to save the video#&gt;;
</span><span class='line'>AVAssetWriter *assetWriter = [AVAssetWriter assetWriterWithURL:outputURL
</span><span class='line'>fileType:AVFileTypeQuickTimeMovie
</span><span class='line'>error:&outError];
</span><span class='line'>BOOL success = (assetWriter != nil);
</span><span class='line'>
</span><span class='line'>// 2. Setting Up the Asset Writer Inputs
</span><span class='line'>// Configure the channel layout as stereo.
</span><span class='line'>AudioChannelLayout stereoChannelLayout = {
</span><span class='line'>    .mChannelLayoutTag = kAudioChannelLayoutTag_Stereo,
</span><span class='line'>    .mChannelBitmap = 0,
</span><span class='line'>    .mNumberChannelDescriptions = 0
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>// Convert the channel layout object to an NSData object.
</span><span class='line'>NSData *channelLayoutAsData = [NSData dataWithBytes:&stereoChannelLayout length:offsetof(AudioChannelLayout, mChannelDescriptions)];
</span><span class='line'>
</span><span class='line'>// Get the compression settings for 128 kbps AAC.
</span><span class='line'>NSDictionary *compressionAudioSettings = @{
</span><span class='line'>AVFormatIDKey         : [NSNumber numberWithUnsignedInt:kAudioFormatMPEG4AAC],
</span><span class='line'>                        AVEncoderBitRateKey   : [NSNumber numberWithInteger:128000],
</span><span class='line'>                        AVSampleRateKey       : [NSNumber numberWithInteger:44100],
</span><span class='line'>                        AVChannelLayoutKey    : channelLayoutAsData,
</span><span class='line'>                        AVNumberOfChannelsKey : [NSNumber numberWithUnsignedInteger:2]
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>// Create the asset writer input with the compression settings and specify the media type as audio.
</span><span class='line'>AVAssetWriterInput *assetWriterInput = [AVAssetWriterInput assetWriterInputWithMediaType:AVMediaTypeAudio outputSettings:compressionAudioSettings];
</span><span class='line'>// Add the input to the writer if possible.
</span><span class='line'>if ([assetWriter canAddInput:assetWriterInput])
</span><span class='line'>    [assetWriter addInput:assetWriterInput];
</span><span class='line'>
</span><span class='line'>// 3. Writing Media Data
</span><span class='line'>// Prepare the asset writer for writing.
</span><span class='line'>    [self.assetWriter startWriting];
</span><span class='line'>    // Start a sample-writing session.
</span><span class='line'>    [self.assetWriter startSessionAtSourceTime:kCMTimeZero];
</span><span class='line'>    // Specify the block to execute when the asset writer is ready for media data and the queue to call it on.
</span><span class='line'>    [self.assetWriterInput requestMediaDataWhenReadyOnQueue:myInputSerialQueue usingBlock:^{
</span><span class='line'>        while ([self.assetWriterInput isReadyForMoreMediaData])
</span><span class='line'>        {
</span><span class='line'>            // Get the next sample buffer.
</span><span class='line'>            CMSampleBufferRef nextSampleBuffer = [self copyNextSampleBufferToWrite];
</span><span class='line'>            if (nextSampleBuffer)
</span><span class='line'>            {
</span><span class='line'>                // If it exists, append the next sample buffer to the output file.
</span><span class='line'>                [self.assetWriterInput appendSampleBuffer:nextSampleBuffer];
</span><span class='line'>                CFRelease(nextSampleBuffer);
</span><span class='line'>                nextSampleBuffer = nil;
</span><span class='line'>            }
</span><span class='line'>            else
</span><span class='line'>            {
</span><span class='line'>                // Assume that lack of a next sample buffer means the sample buffer source is out of samples and mark the input as finished.
</span><span class='line'>                [self.assetWriterInput markAsFinished];
</span><span class='line'>                break;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }];</span></code></pre></td></tr></table></div></figure>


<p>Reference:<br/>
iOS Technology Overview<br/>
AVFoundation Programming Guide</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android开发问题汇总(三)]]></title>
    <link href="http://DamianSheldon.github.io/blog/problems-of-android-development-part-3.html"/>
    <updated>2017-04-05T08:48:36+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/problems-of-android-development-part-3</id>
    <content type="html"><![CDATA[<h3>1. How to define custom attributes?</h3>

<p>A:Currently the best documentation is the source. You can take a look at it <a href="https://github.com/android/platform_frameworks_base/blob/master/core/res/res/values/attrs.xml">here(arrts.xml)</a>.</p>

<p>You can define attributes in the top <code>&lt;resources&gt;</code> element or inside of a <code>&lt;declare-styleable&gt;</code> element. If I&rsquo;m going to use an attr in more than on place I put it in the root element. Note , all attributes share the same global namespace. That means that even if you create a new attribute inside of a <code>&lt;declare-styleable&gt;</code> element it can be used outside of it and you cannot create another attribute with the same name of a different type.</p>

<p>An <code>&lt;attr&gt;</code> element has two xml attributes <code>name</code> and <code>format</code>. <code>name</code> lets you call it something and this how you end up refering to it in code, e.g., R.attr.my_attribute. The <code>format</code> attribute can have different values depending on the type of attribute you want.</p>

<ul>
<li>reference - if it references another resource id(e.g, &ldquo;@color/my_color&rdquo;, &ldquo;@layout/my_layout&rdquo;)</li>
<li>color</li>
<li>boolean</li>
<li>dimension</li>
<li>float</li>
<li>integer</li>
<li>string</li>
<li>fraction</li>
<li>enum - normally implicitly defined</li>
<li>flag - normally implicitly defined</li>
</ul>


<p>You can set the format to multiple types by using |, e.g., <code>format="reference|color"</code>.</p>

<p>enum attributes can be defined as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;attr name="my_enum_attr"&gt; 
</span><span class='line'>    &lt;enmu name="value1" value="1" /&gt;
</span><span class='line'>    &lt;enmu name="value2" value="2" /&gt;
</span><span class='line'>&lt;/attr&gt;</span></code></pre></td></tr></table></div></figure>


<p>flag attributes are similar except the values need to defined so they can be bit ored together:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;attr name="my_flag_attr"&gt;
</span><span class='line'>    &lt;flag name="fuzzy" value="0x01" /&gt;
</span><span class='line'>    &lt;flag name="cold" value="0x02" /&gt;
</span><span class='line'>&lt;/attr&gt;</span></code></pre></td></tr></table></div></figure>


<p>In addition to attributes there is the <code>&lt;declare-styleable&gt;</code> element. This allows you to define attributes a custom view can use. You do this by specifying an <code>&lt;attr&gt;</code> element, if it was previously defined you do not specify the format. If you wish to reuse an android attr, for example android:gravity, then you can do that in the name, as follows.</p>

<p>An example of a custom view <code>&lt;declare-styleable&gt;</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;declare-styleable name="MyCustomView"&gt; 
</span><span class='line'>    &lt;attr name="my_custom_attribute" /&gt;
</span><span class='line'>    &lt;attr name="android:gravity" /&gt;
</span><span class='line'>&lt;/declare-styleable&gt;</span></code></pre></td></tr></table></div></figure>


<p>When defining you custom attributes in XML on you need to do a few things.</p>

<p>First you must declare a namespace to find your attributes. You do this on the root layout element. Normal there is only <code>xmlns:android="http//schemas.android.com/apk/res/android"</code>. You must now also add <code>xmlns:app="http://schemas.android.com/apk/res-auto"</code>.</p>

<p>Example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;LinearLayout
</span><span class='line'>xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>xmlns:whatever="http://schemas.android.com/apk/res-auto"
</span><span class='line'>android:orientation="vertical"
</span><span class='line'>android:layout_width="fill_parent"
</span><span class='line'>android:layout_height="fill_parent"&gt;
</span><span class='line'>
</span><span class='line'>&lt;org.example.mypackage.MyCustomView
</span><span class='line'>android:layout_width="fill_parent"
</span><span class='line'>android:layout_height="wrap_content"
</span><span class='line'>android:gravity="center"
</span><span class='line'>whatever:my_custom_attribute="Hello, world!" /&gt;
</span><span class='line'>&lt;/LinearLayout&gt;</span></code></pre></td></tr></table></div></figure>


<p>Finally, to access that custom attribute you normally do so in the constructor of you custom view as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public MyCustomView(Context context, AttributeSet attrs, int defStyle) {
</span><span class='line'>    super(context, attrs, defStyle);
</span><span class='line'>
</span><span class='line'>    TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.MyCustomView, defStyle, 0);
</span><span class='line'>
</span><span class='line'>    String str = a.getString(R.styleable.MyCustomView_my_custom_attribute);
</span><span class='line'>
</span><span class='line'>    //do something with str
</span><span class='line'>
</span><span class='line'>    a.recycle();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/3441396/defining-custom-attrs">Defining custom attrs</a></p>

<h3>2. How to get Uri from raw file?</h3>

<p>A: <code>Uri url = Uri.parse("android.resource://" + getPackageName() + "/" + R.raw.usa_for_africa_we_are_the_world);</code></p>

<p>Reference:<a href="http://stackoverflow.com/questions/16791439/android-how-to-get-uri-from-raw-file">Android - How to get Uri from raw file?</a></p>

<h3>3. How to display all music on SD card?</h3>

<p>A: We can use loader perform this work,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
</span><span class='line'>    return new CursorLoader(getActivity(), MediaStore.Audio.Media.EXTERNAL_CONTENT_URI, new String[] { MediaStore.Audio.Media.DISPLAY_NAME }, null, null,
</span><span class='line'>      "LOWER(" + MediaStore.Audio.Media.TITLE + ") ASC");    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/8994625/display-all-music-on-sd-card">Display all music on SD card</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android 真机抓包]]></title>
    <link href="http://DamianSheldon.github.io/blog/capturing-android-physic-device-traffic-on-tcpdump.html"/>
    <updated>2017-03-11T17:04:33+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/capturing-android-physic-device-traffic-on-tcpdump</id>
    <content type="html"><![CDATA[<p>在 Android 开发过程中，可能会遇到和服务端交互有问题的情况，这时候就得拿出证据来和服务端撕逼, 而最有力的证据自然是抓取的网络数据包；又或者是遇到很诡异的网络问题，这时候就可以借助抓包来分析和定位问题。</p>

<p>如果我们和服务端的交互没有通过 VPN, 而且也不是视频流这种网络性能要求苛刻的情况，我们可以通过 tPacketCapture 这种应用来抓包；</p>

<p>其他情况我们可以通过 root 手机，然后安装 tcpdump 来抓包。</p>

<p>下面我们详细介绍下 通过 tcpdump 抓包这种方法：</p>

<ul>
<li>Root 手机</li>
</ul>


<p>Root 手机的原理是利用系统存在的漏洞来获得 root 权限，<a href="https://forum.xda-developers.com/">XDA Developers</a> 上有不少 root 工具，很多手机都可以用它们 root。</p>

<ul>
<li>安装 tcpdump</li>
</ul>


<p>可以到网上搜索为 Android 编译好的 tcpdump 二进制包，例如<a href="http://www.strazzere.com/android/tcpdump">这里</a>就有一个。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Copy tcpdump to device
</span><span class='line'>$ adb -d push /path/to/tcpdump /sdcard/tcpdump
</span><span class='line'>
</span><span class='line'>// Device shell
</span><span class='line'>$ adb -d shell
</span><span class='line'>
</span><span class='line'>// Switch to root
</span><span class='line'>$ su
</span><span class='line'>
</span><span class='line'>// Copy tcpdump to /data/local/
</span><span class='line'># cat /sdcard/tcpdump /data/local/tcpdump</span></code></pre></td></tr></table></div></figure>


<!--more-->


<ul>
<li>抓包</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/# cd /data/local
</span><span class='line'>/# ./tcpdump -i any -p -s 0 -w /sdcard/capture.pcap
</span><span class='line'>
</span><span class='line'>//  Options
</span><span class='line'>    # "-i any": listen on any network interface
</span><span class='line'>
</span><span class='line'>　　# "-p": disable promiscuous mode (doesn't work anyway)
</span><span class='line'>
</span><span class='line'>　　# "-s 0": capture the entire packet
</span><span class='line'>
</span><span class='line'>　　# "-w": write packets to a file (rather than printing to stdout)
</span><span class='line'>
</span><span class='line'>　　... do whatever you want to capture, then ^C to stop it ...</span></code></pre></td></tr></table></div></figure>


<ul>
<li>分析</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Copy capture.pcap to computer
</span><span class='line'>$ adb -d pull /sdcard/capture.pcap /path/to/capture.pcap
</span><span class='line'>
</span><span class='line'>Analyze with Wireshark.</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Shell Commands</li>
</ul>


<p>Android 手机上的命令通常不全，我们可以通过安装 BusyBox 来提供一个相对完成 Shell 命令集方便我们的开发工作。</p>

<p>1,Download <a href="http://www.busybox.net/downloads/binaries">BusyBox</a> 的压缩包;<br/>
2,获取设备 CPU 的架构版本 <code>adb -d shell cat /proc/cpuinfo</code><br/>
3,解开压缩包，把对应 CPU 架构版本的二进制包生命名为 busybox,例如 <code>mv busybox-armv7l busybox</code>;<br/>
4,安装 busybox 到设备上，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Copy busybox to device
</span><span class='line'>$adb -d push /path/to/busybox /sdcard/busybox
</span><span class='line'>
</span><span class='line'>// Switch to device shell
</span><span class='line'>$adb -d shell
</span><span class='line'>
</span><span class='line'>// Install busybox
</span><span class='line'>$ su
</span><span class='line'>
</span><span class='line'>\# cat /sdcard/busybox /system/xbin/busybox
</span><span class='line'>
</span><span class='line'>// Check install result
</span><span class='line'># busybox 
</span><span class='line'>
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h2>Reference</h2>

<ul>
<li><a href="http://www.cnblogs.com/likwo/archive/2012/09/06/2673944.html">Android通过tcpdump抓包</a></li>
<li><a href="http://www.cnblogs.com/blues_/p/3582097.html">转adb Shell root 权限</a></li>
<li><a href="http://www.cnblogs.com/xiaowenji/archive/2011/03/12/1982309.html">为Android安装BusyBox —— 完整的bash shell</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何搭建一个带 Dovecot 的 Postfix 邮件服务器]]></title>
    <link href="http://DamianSheldon.github.io/blog/how-to-set-up-a-postfix-e-mail-server-with-dovecot.html"/>
    <updated>2017-02-15T16:29:42+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/how-to-set-up-a-postfix-e-mail-server-with-dovecot</id>
    <content type="html"><![CDATA[<p>不知道从什么时候开始，也不知道是什么原因，我一直觉得有个自己域名的邮箱很酷，所以我决定自己动手搭建一个邮件服务器。本文记录了我搭建一个自己域名的邮件服务器，并让这个邮箱可以通过 Mac 和 iPhone 自由收发邮件的过程。</p>

<h2>准备材料</h2>

<ul>
<li>VPS</li>
<li>域名</li>
</ul>


<p>VPS 我用的 DigitalOcean，打个小广告，如果你也想买个他们家的VPS,可以用我的优惠码：<a href="https://m.do.co/c/537dc7bd8a78">https://m.do.co/c/537dc7bd8a78</a></p>

<p>我服务器跑的是 Debian 8 Jessie.</p>

<h2>配置 DNS</h2>

<h3>添加 MX 记录</h3>

<p>添加从域名到 VPS IP 的 MX 记录，它指定了负责处理这个域名邮件收发的服务器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Type    Hostname        Value         TTL
</span><span class='line'>MX      tenneshop.com   1.2.3.4.      1800</span></code></pre></td></tr></table></div></figure>


<h3>验证 DNS</h3>

<p>DNS 需要几个小时才能蔓延到整个互联网，但是在你的 DNS 服务器上几分钟之后就会生效，你可以用 dig 和 host 来验证。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@yourbase] ~# dig MX mydomain.com +short @ns1.digitalocean.com
</span><span class='line'>50 mail.mydomain.com.
</span><span class='line'>[root@yourbase] ~# host mail.mydomain.com ns1.digitalocean.com
</span><span class='line'>Using domain server:
</span><span class='line'>Name: ns1.digitalocean.com
</span><span class='line'>Address: 198.199.120.125#53
</span><span class='line'>Aliases:
</span><span class='line'>
</span><span class='line'>mail.mydomain.com has address 82.196.9.119</span></code></pre></td></tr></table></div></figure>


<!--more-->


<h2>邮件系统是怎么工作</h2>

<p>开始之前我觉得有必要了解下邮件系统是怎么工作的，Dovecot 上有篇文章介绍的很好，值得看下：<a href="http://wiki.dovecot.org/MailServerOverview">Overview of how everything works together</a>,
我简单地说一下我的理解，先看发邮件，以使用 Mac 的 Mail 为例，用户用 Mail 写了封邮件，邮件包含收件人地址和信件内容，然后点击发送，Mail 在这里就是 MUA(Mail User Agent), MUA 把邮件发送到 Mail Server, Mail Server 称之为 MTA(Mail Transfer Agent), MTA 根据收件人地址去查询 DNS 记录，然后把邮件发送到目标MTA, 目标MTA则负责把邮件传送给MDA(Mail Delivery Agent), MDA则负责把邮件存储到邮件服务器上。</p>

<p>再看收邮件，用户打开 Mail 之后会触发收件操作，通常是通过 IMAP 或 POP3 协议去获取 MDA 存储在 Mail Server 上的邮件。</p>

<p>我们这里 MTA 用的 Postfix, IMAP/POP3 Server 用的 Dovecot.</p>

<h2>Postfix</h2>

<h3>安装</h3>

<p>Debian 默认的邮件服务程序是 exim，我们需要卸载它。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo aptitude remove exim4 && aptitude install postfix && postfix stop</span></code></pre></td></tr></table></div></figure>


<h3>配置</h3>

<p>Postfix 有两个主要配置文件 /etc/postfix/main.cf 和 /etc/postfix/master.cf, main.cf 指定配置项；master.cf 指定 postfix 要运行哪些服务。</p>

<p>配置的主要工作自然是编辑 main.cf 这个文件里的配置项，安全起见我们可以先把默认的配置文件做个备份:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp /etc/postfix/main.cf /etc/postfix/main.cf.orig</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置发送邮件使用的域名;</li>
</ul>


<p>我们可能希望别人收到我们的邮件时显示的收件人是user@example.com这种形式而不是user@mail.example.com,这可以通过设置myorigin来实现:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf
</span><span class='line'>myorigin = $mydomain</span></code></pre></td></tr></table></div></figure>


<ul>
<li>希望收到哪些域名的邮件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>domain-wide mail server
</span><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>    mydestination = $myhostname localhost.$mydomain localhost $mydomain
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置哪些终端可以中继邮件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>mynetworks_style = host
</span><span class='line'>mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 </span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置邮件服务器的基本账号，例如 postmaster, 这是必须要有的账号，这样别人才能反馈邮件投递的问题。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/aliases:
</span><span class='line'>mailer-daemon: postmaster
</span><span class='line'>postmaster: root
</span><span class='line'>nobody: root
</span><span class='line'>hostmaster: root
</span><span class='line'>usenet: root
</span><span class='line'>news: root
</span><span class='line'>webmaster: root
</span><span class='line'>www: root
</span><span class='line'>ftp: root
</span><span class='line'>abuse: root
</span><span class='line'>root: yourname</span></code></pre></td></tr></table></div></figure>


<p>更新完了/etc/aliases，还需要运行命令去生效:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ newaliases</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置邮件用户账号</li>
</ul>


<p>Postfix 使用数据库文件来控制权限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>    virtual_alias_maps = hash:/etc/postfix/virtual
</span><span class='line'>
</span><span class='line'>/etc/postfix/virtual:
</span><span class='line'>// Map Mail Addresses to Linux Accounts
</span><span class='line'>contact@example.com sammy
</span><span class='line'>admin@example.com sammy</span></code></pre></td></tr></table></div></figure>


<p>我们可以通过如下命令来让映射生效:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo postmap /etc/postfix/virtual</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置邮件的存储文件格式</li>
</ul>


<blockquote><p>There are two primary storage options of mail in the *NIX world: mbox and Maildir. mbox stores multiple messages - sometimes hundreds or thousands of messages - in a single file. Maildir stores each message a separate file.</p></blockquote>

<p>Postfix 默认是 mbox 的格式，这里我们决定使用 Maildir 的格式，可以用 postconf 命令来配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo postconf -e 'home_mailbox= Maildir/'</span></code></pre></td></tr></table></div></figure>


<p>更新环境变量 MAIL 的值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 'export MAIL=~/Maildir' | sudo tee -a /etc/bash.bashrc | sudo tee -a /etc/profile.d/mail.sh</span></code></pre></td></tr></table></div></figure>


<p>让变量在当前的会话中生效：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source /etc/profile.d/mail.sh</span></code></pre></td></tr></table></div></figure>


<h3>测试</h3>

<p>本地测试之前需要初始化 Maildir 的目录结构，在我们 home 目录中创建 Maildir 目录结构最简单的方法是向我们自己发一封邮件，可以使用 mail 命令:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 安装 mail 命令
</span><span class='line'>$ sudo apt-get install mailutils
</span><span class='line'>
</span><span class='line'>// 发送邮件
</span><span class='line'>$ echo 'init' | mail -s 'init' sammy
</span><span class='line'>
</span><span class='line'>// 确认 Maildir 目录结构初始化好了
</span><span class='line'>$ ls -R ~/Maildir
</span><span class='line'>
</span><span class='line'>// 输出的结果： 
</span><span class='line'>/home/sammy/Maildir/:
</span><span class='line'>cur  new  tmp
</span><span class='line'>
</span><span class='line'>/home/sammy/Maildir/cur:
</span><span class='line'>
</span><span class='line'>/home/sammy/Maildir/new:
</span><span class='line'>1463177269.Vfd01I40e4dM691221.mail.example.com
</span><span class='line'>
</span><span class='line'>/home/sammy/Maildir/tmp:</span></code></pre></td></tr></table></div></figure>


<p>使用 mail 命令发送邮件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mail -s "Hello World" someone@example.com
</span><span class='line'>Cc: 
</span><span class='line'>Hi Peter
</span><span class='line'>How are you
</span><span class='line'>I am fine
</span><span class='line'>Good Bye
</span><span class='line'>&lt;Ctrl+D&gt;</span></code></pre></td></tr></table></div></figure>


<p>使用 mail 命令查看邮件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mail
</span><span class='line'>Heirloom mailx version 12.5 6/20/10.  Type ? for help.
</span><span class='line'>"/var/mail/enlightened": 7 messages 3 unread
</span><span class='line'>O  1 Enlightened        Sat Dec  6 11:33   21/658   This is the subject
</span><span class='line'>O  2 Enlightened        Sat Dec  6 11:34  773/25549 This is the subject
</span><span class='line'>O  3 Enlightened        Sat Dec  6 16:43   20/633   This is the subject
</span><span class='line'>O  4 Enlightened        Sat Dec  6 16:44   20/633   This is the subject
</span><span class='line'>U  5 Mail Delivery Syst Sat Dec  6 16:50   74/2425  Undelivered Mail Returned to Sender
</span><span class='line'>U  6 Enlightened        Sat Dec  6 16:51   19/632   This is mutts subject
</span><span class='line'>U  7 Enlightened        Sat Dec  6 16:52   19/647   This is mutts subject
</span><span class='line'>?</span></code></pre></td></tr></table></div></figure>


<p>我们可以使用 ? 来查看帮助，例如查看下一封邮件是n, 退出是q。</p>

<p>日常生活工作中我们可能不会是通过 mail 来收发邮件，但它在我们配置邮件服务器时很有用，我们可以知道 postfix 是否是正常工作的。</p>

<p>如果postfix并没有按我们预期那样正常工作，我们可以通过查看系统日志和邮件日志来定位问题:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// system log
</span><span class='line'>$ sudo tail -f /var/log/syslog
</span><span class='line'>
</span><span class='line'>// mail log
</span><span class='line'>$ suod tail -f /var/log/mail.log</span></code></pre></td></tr></table></div></figure>


<h2>Dovecot</h2>

<h3>安装</h3>

<p>Dovecot 支持 imap 和 pop3，这里我用的 imap,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aptitude install dovecot-core dovecot-imapd</span></code></pre></td></tr></table></div></figure>


<h3>配置</h3>

<p>Dovecot 的配置文档要比 postfix 好得多，只需要参考它的 Dovecot installation。</p>

<ul>
<li>Checking where mail is delivered to</li>
</ul>


<p>我们的邮件地址是 ~/Maildir, 更新到配置文件中:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/dovecot/conf.d/10-mail.conf:
</span><span class='line'>mail_location = maildir:~/Maildir</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Configuring Dovecot</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Find Dovecot configuration file location using:
</span><span class='line'>$ doveconf -n | head -n1
</span><span class='line'>/etc/dovecot/dovecot.conf
</span><span class='line'>
</span><span class='line'>// Authentication
</span><span class='line'>// 由于我们打算使用虚拟用户，所以我们这里创建一个类似密码的文件:
</span><span class='line'>$ echo "$USER:{PLAIN}password:$UID:$GID::$HOME" &gt; users
</span><span class='line'>$ sudo mv users /etc/dovecot/
</span><span class='line'>
</span><span class='line'>$GID 这个环境变量可能没值，我们可以手动编辑，首先找出gid：
</span><span class='line'>id $USER
</span><span class='line'>
</span><span class='line'>然后把gid 加到对应的字段里面:
</span><span class='line'>$ sudo vim /etc/dovecot/users
</span><span class='line'>
</span><span class='line'>// /etc/dovecot/conf.d/10-auth.conf
</span><span class='line'>// Add '#' to comment out the system user login for now:
</span><span class='line'>    #!include auth-system.conf.ext
</span><span class='line'>
</span><span class='line'>// Remove '#' to use passwd-file:
</span><span class='line'>!include auth-passwdfile.conf.ext
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/auth-passwdfile.conf.ext
</span><span class='line'>passdb {
</span><span class='line'>      driver = passwd-file
</span><span class='line'>        args = scheme=CRYPT username_format=%u /etc/dovecot/users
</span><span class='line'>}
</span><span class='line'>userdb {
</span><span class='line'>      driver = passwd-file
</span><span class='line'>        args = username_format=%u /etc/dovecot/users
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// Verify with doveconf -n passdb userdb that the output looks like above (and there are no other passdbs or userdbs).
</span><span class='line'>
</span><span class='line'>// Plaintext Authentication
</span><span class='line'>To allow any Authentication without SSL, disable SSL in the conf.d/10-ssl.conf file.
</span><span class='line'>/etc/dovecot/conf.d/10-ssl.conf:
</span><span class='line'>ssl = no
</span><span class='line'>
</span><span class='line'>Until SSL is configured, allow plaintext authentication in the conf.d/10-auth.conf file. You probably want to switch this back to "yes" afterward.
</span><span class='line'>/etc/dovecot/conf.d/10-auth.conf:
</span><span class='line'>disable_plaintext_auth = no</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Running Dovecot</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Start Dovecot
</span><span class='line'>$ sudo service dovecot start
</span><span class='line'>
</span><span class='line'>// Stop Dovecot
</span><span class='line'>$sudo service dovecot stop
</span><span class='line'>
</span><span class='line'>// Restart 
</span><span class='line'>$sudo service dovecot restart
</span><span class='line'>
</span><span class='line'>// Verify
</span><span class='line'>$ sudo ps auxw|grep "dovecot"</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Testing that everything works</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Check that it's listening
</span><span class='line'>$ telnet localhost 143
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to localhost.
</span><span class='line'>Escape character is '^]'.
</span><span class='line'>* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE STARTTLS AUTH=PLAIN] Dovecot ready.
</span><span class='line'>
</span><span class='line'>If you got "connection refused", make sure that Dovecot is configured to serve the imap protocol and listening on the expected interfaces/addresses. The simplest way to do that would be using doveconf(1):
</span><span class='line'>$ sudo doveconf protocols listen
</span><span class='line'>protocols = imap pop3 lmtp sieve
</span><span class='line'>listen = *, ::
</span><span class='line'>
</span><span class='line'>Next check that it also works from remote host:
</span><span class='line'>$ telnet imap.example.com 143
</span><span class='line'>Trying 1.2.3.4...
</span><span class='line'>Connected to imap.example.com.
</span><span class='line'>Escape character is '^]'.
</span><span class='line'>* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE STARTTLS AUTH=PLAIN] Dovecot ready.
</span><span class='line'>
</span><span class='line'>Check that it's allowing logins
</span><span class='line'>% telnet localhost 143
</span><span class='line'>a login "username" "password"
</span><span class='line'>a OK Logged in.
</span><span class='line'>
</span><span class='line'>Check that it's allowing remote logins
</span><span class='line'>$ telnet imap.example.com 143
</span><span class='line'>a login "username" "password"
</span><span class='line'>
</span><span class='line'>Check that it finds INBOX
</span><span class='line'>b select inbox
</span><span class='line'>* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
</span><span class='line'>* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
</span><span class='line'>* 1 EXISTS
</span><span class='line'>* 1 RECENT
</span><span class='line'>* OK [UIDVALIDITY 1106186941] UIDs valid
</span><span class='line'>* OK [UIDNEXT 2] Predicted next UID
</span><span class='line'>b OK [READ-WRITE] Select completed.
</span><span class='line'>
</span><span class='line'>Make a graceful exit
</span><span class='line'>e logout
</span><span class='line'>* BYE Logging out
</span><span class='line'>e OK Logout completed.
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Finishing the test installation</li>
</ul>


<p>最后我们要开启 ssl, 关闭明文密码验证, <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>可以提供免费的 SSL 证书:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Enable the Jessie backports repo
</span><span class='line'>For jessie add this line
</span><span class='line'>deb http://ftp.debian.org/debian jessie-backports main
</span><span class='line'>to your source.list(/etc/sources.list)
</span><span class='line'>
</span><span class='line'>Run apt-get update
</span><span class='line'>
</span><span class='line'>// Temporarily stop apache
</span><span class='line'>$ sudo service apache2 stop
</span><span class='line'>
</span><span class='line'>// sudo certbot certonly --standalone -d example.com
</span><span class='line'>
</span><span class='line'>All generated keys and issued certificates can be found in /etc/letsencrypt/live/$domain.
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/10-ssl.conf:
</span><span class='line'>ssl = yes 
</span><span class='line'>
</span><span class='line'>ssl_cert = &lt;/etc/letsencrypt/live/mail.tennshop.com/fullchain.pem
</span><span class='line'>ssl_key = &lt;/etc/letsencrypt/live/mail.tenneshop.com/privkey.pem
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/10-auth.conf:
</span><span class='line'>disable_plaintext_auth = yes 
</span><span class='line'>
</span><span class='line'>Test using imaps port (assuming you haven't disabled imaps port):
</span><span class='line'>$ openssl s_client -connect imap.example.com:993
</span><span class='line'>* OK Dovecot ready.
</span><span class='line'>
</span><span class='line'>Test using imap port and STARTTLS command (works also with imap port):
</span><span class='line'>$ openssl s_client -connect imap.example.com:143 -starttls imap
</span><span class='line'>* OK Dovecot ready.</span></code></pre></td></tr></table></div></figure>


<h2>Mail</h2>

<p>现在我们可以在 Mac 上使用 Mail.app 来收信了，但还是不能发信，postfix 默认不支持外域发信，我们需要一种方法获取内域相同的权限。为了解决这个问题， Postfix 支持 SASL.</p>

<p>Configure SASL authentication in the Postfix SMTP server</p>

<p>由于 SASL 的实现和 Postfix 是分开的，所以在 Postfix SMTP 服务器上配置 SASL 授权会有两个不同的内容：</p>

<ul>
<li>配置 SASL 实现来提供一系列合适的机制来进行 SASL 认证，决定好使用哪个 SASL 实现后，配置认证的后端，它通过系统的密码文件或其他数据库来认证远端的 SMTP 终端；</li>
<li>配置 Postfix SMTP 服务器使能 SASL 认证，去授权终端中继邮件或控制终端可以使用哪些邮件发送地址;</li>
</ul>


<p>Which SASL Implementations are supported?</p>

<p>Currently the Postfix SMTP server supports the Cyrus SASL and Dovecot SASL implementations.</p>

<p>To find out what SASL implementations are compiled into Postfix, use the following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% postconf -a (SASL support in the SMTP server)
</span><span class='line'>% postconf -A (SASL support in the SMTP+LMTP client)</span></code></pre></td></tr></table></div></figure>


<p>Configuring Dovecot SASL</p>

<p>Dovecot 独立地去认证它的 POP/IMAP 终端，Postfix 使用 Dovecot SASL 时会复用这部分配置。</p>

<p>Postfix 到 Dovecot SASL 的通信有两种途径:UNIX-domain socket or TCP socket。从更好的安全性角度出发，我们选择使用 UNIX-domain socket.</p>

<p>The following fragment for Dovecot version 2 assumes that the Postfix queue is under /var/spool/postfix/.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/dovecot/conf.d/10-master.conf:
</span><span class='line'>service auth {
</span><span class='line'>    ...
</span><span class='line'>    unix_listener /var/spool/postfix/private/auth {
</span><span class='line'>        mode = 0660
</span><span class='line'>        # Aussuming the default postfix user and group
</span><span class='line'>        user = postfix
</span><span class='line'>        group = postfix
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/10-auth.conf
</span><span class='line'>auth_mechanisms = plain login</span></code></pre></td></tr></table></div></figure>


<p>Enabling SASL authentication and authorization in the Postfix SMTP server</p>

<p>默认 postfix 是使用 Cyrus SASL 实现，我们需要改成 dovecot</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_type = dovecot</span></code></pre></td></tr></table></div></figure>


<p>指定 Postfix 怎么和 Dovecot 认证服务器通信, 这里我们使用 UNIX-domain socket:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_path = private/auth</span></code></pre></td></tr></table></div></figure>


<p>开启 SASL 认证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_auth_enable = yes</span></code></pre></td></tr></table></div></figure>


<p>重启下 postfix, 使用 SMTP 命令验证配置是否生效:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% telnet server.example.com 25
</span><span class='line'>...
</span><span class='line'>220 server.example.com ESMTP Postfix
</span><span class='line'>EHLO client.example.com
</span><span class='line'>250-server.example.com
</span><span class='line'>250-PIPELINING
</span><span class='line'>250-SIZE 10240000
</span><span class='line'>250-AUTH DIGEST-MD5 PLAIN CRAM-MD5
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>配置 Postfix SMTP 服务器的安全原则：</p>

<p>Unencrypted SMTP session</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_security_options = noanonymous</span></code></pre></td></tr></table></div></figure>


<p>Encrypted SMTP session</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_tls_security_options = $smtpd_sasl_security_options</span></code></pre></td></tr></table></div></figure>


<p>To offer SASL authentication only after a TLS-encrypted session has been established specify this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_tls_auth_only = yes</span></code></pre></td></tr></table></div></figure>


<p>After the client has authenticated with SASL, the Postfix SMTP server decides what the remote SMTP client will be authorized for. Examples of possible SMTP clients authorizations are:</p>

<ul>
<li>Send a message to a remote recipient.</li>
<li>Use a specific envelope sender in the MAIL FROM command.</li>
</ul>


<p>These permissions are not enabled by default.</p>

<p>Mail relay authorization</p>

<p>With permit_sasl_authenticated the Postfix SMTP server can allow SASL-authenticated SMTP clients to send mail to remote destinations. Examples:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># With Postfix 2.10 and later, the mail relay policy is
</span><span class='line'># preferably specified under smtpd_relay_restrictions.
</span><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_relay_restrictions =
</span><span class='line'>permit_mynetworks
</span><span class='line'>permit_sasl_authenticated
</span><span class='line'>reject_unauth_destination
</span><span class='line'># Older configurations combine relay control and spam control under
</span><span class='line'># smtpd_recipient_restrictions. To use this example with Postfix ≥
</span><span class='line'># 2.10 specify "smtpd_relay_restrictions=".
</span><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_recipient_restrictions =
</span><span class='line'>permit_mynetworks
</span><span class='line'>permit_sasl_authenticated
</span><span class='line'>reject_unauth_destination
</span><span class='line'>...other rules...</span></code></pre></td></tr></table></div></figure>


<p>Envelope sender address authorization</p>

<p>By default an SMTP client may specify any envelope sender address in the MAIL FROM command. That is because the Postfix SMTP server only knows the remote SMTP client hostname and IP address, but not the user who controls the remote SMTP client.</p>

<p>This changes the moment an SMTP client uses SASL authentication. Now, the Postfix SMTP server knows who the sender is. Given a table of envelope sender addresses and SASL login names, the Postfix SMTP server can decide if the SASL authenticated client is allowed to use a particular envelope sender address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sender_login_maps = hash:/etc/postfix/controlled_envelope_senders
</span><span class='line'>
</span><span class='line'>smtpd_recipient_restrictions =
</span><span class='line'>...
</span><span class='line'>reject_sender_login_mismatch
</span><span class='line'>permit_sasl_authenticated
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>The controlled_envelope_senders table specifies the binding between a sender envelope address and the SASL login names that own that address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/controlled_envelope_senders
</span><span class='line'>    # envelope sender           owners (SASL login names)
</span><span class='line'>john@example.com            john@example.com
</span><span class='line'>helpdesk@example.com        john@example.com, mary@example.com
</span><span class='line'>postmaster                  admin@example.com
</span><span class='line'>@example.net                barney, fred, john@example.com, mary@example.com</span></code></pre></td></tr></table></div></figure>


<p>With this, the reject_sender_login_mismatch restriction above will reject the sender address in the MAIL FROM command if smtpd_sender_login_maps does not specify the SMTP client&rsquo;s login name as an owner of that address.</p>

<p>Testing SASL authentication in the Postfix SMTP server</p>

<p>To test the server side, connect (for example, with telnet) to the Postfix SMTP server port and you should be able to have a conversation as shown below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% telnet server.example.com 25
</span><span class='line'>...
</span><span class='line'>220 server.example.com ESMTP Postfix
</span><span class='line'>EHLO client.example.com
</span><span class='line'>250-server.example.com
</span><span class='line'>250-PIPELINING
</span><span class='line'>250-SIZE 10240000
</span><span class='line'>250-ETRN
</span><span class='line'>250-AUTH DIGEST-MD5 PLAIN CRAM-MD5
</span><span class='line'>250 8BITMIME
</span><span class='line'>AUTH PLAIN AHRlc3QAdGVzdHBhc3M=
</span><span class='line'>235 Authentication successful</span></code></pre></td></tr></table></div></figure>


<p>To test this over a connection that is encrypted with TLS, use openssl s_client instead of telnet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% openssl s_client -connect server.example.com:25 -starttls smtp
</span><span class='line'>...
</span><span class='line'>220 server.example.com ESMTP Postfix
</span><span class='line'>EHLO client.example.com
</span><span class='line'>...see above example for more...</span></code></pre></td></tr></table></div></figure>


<p>PLAIN 的授权方式要求用户名和密码一起base64编码提交， LOGIN 的话则是先提交base64编码的用户名，然后是base64编码的密码, base64编码的话可以找个<a href="https://www.base64encode.org/">在线编码工具</a>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth login 
</span><span class='line'>334 VXNlcm5hbWU6
</span><span class='line'>c2VydmljZUBoZWVwLmNx
</span><span class='line'>334 UGFzc3dvcmQ6
</span><span class='line'>xxxxxxxx
</span><span class='line'>235 Authentication successful</span></code></pre></td></tr></table></div></figure>


<p>SMTP 命令列表如下：</p>

<p>HELO</p>

<p>客户端为标识自己的身份而发送的命令（通常带域名）</p>

<p>EHLO</p>

<p>使服务器可以表明自己支持扩展简单邮件传输协议 (ESMTP) 命令。</p>

<p>MAIL FROM</p>

<p>标识邮件的发件人；以 MAIL FROM: 的形式使用。</p>

<p>RCPT TO</p>

<p>标识邮件的收件人；以 RCPT TO: 的形式使用。</p>

<p>TURN</p>

<p>允许客户端和服务器交换角色，并在相反的方向发送邮件，而不必建立新的连接。</p>

<p>ATRN</p>

<p>ATRN (Authenticated TURN) 命令可以选择将一个或多个域作为参数。如果该会话已通过身份验证，则ATRN 命令一定会被拒绝。</p>

<p>SIZE</p>

<p>提供一种使 SMTP 服务器可以指出所支持的最大邮件大小的机制。兼容的服务器必须提供大小范围，以指出可以接受的最大邮件大小。客户端发送的邮件不应大于服务器所指出的这一大小。</p>

<p>ETRN</p>

<p>SMTP 的扩展。SMTP 服务器可以发送 ETRN 以请求另一台服务器发送它所拥有的任何电子邮件。</p>

<p>PIPELINING</p>

<p>提供发送命令流（而无需在每个命令之后都等待响应）的能力。</p>

<p>CHUNKING</p>

<p>替换 DATA 命令的 ESMTP 命令。该命令使 SMTP 主机不必持续地扫描数据的末尾，它发送带参数的 BDAT 命令，该参数包含邮件的总字节数。接收方服务器计算邮件的字节数，如果邮件大小等于 BDAT 命令发送的值时，则该服务器假定它收到了全部的邮件数据。</p>

<p>DATA</p>

<p>客户端发送的、用于启动邮件内容传输的命令。</p>

<p>DSN</p>

<p>启用传递状态通知的 ESMTP 命令。</p>

<p>RSET</p>

<p>使整个邮件的处理无效，并重置缓冲区。</p>

<p>VRFY</p>

<p>确认在邮件传递过程中可以使用邮箱；例如，vrfy ted 确认在本地服务器上驻留 Ted 的邮箱。该命令在 Exchange 实现中默认关闭。</p>

<p>HELP</p>

<p>返回 SMTP 服务所支持的命令列表。</p>

<p>QUIT</p>

<p>终止会话。</p>

<p>我们可以用 SMTP 命令来测试是否能在外域正常发送邮件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;MAIL FROM: sender@example.com
</span><span class='line'>
</span><span class='line'>&gt;250 sender &lt;sender@example.com&gt; ok
</span><span class='line'>
</span><span class='line'>&gt;RCPT to: recipient@domain.com
</span><span class='line'>
</span><span class='line'>&gt;250 recipient &lt;recipient@domain.com&gt; ok
</span><span class='line'>
</span><span class='line'>&gt;DATA
</span><span class='line'>
</span><span class='line'>&gt;354 go ahead
</span><span class='line'>
</span><span class='line'>&gt;Subject: Hi smtp mail
</span><span class='line'>
</span><span class='line'>&gt;hello mail
</span><span class='line'>
</span><span class='line'>&gt;.
</span><span class='line'>
</span><span class='line'>&gt;250 ok:  Message 1763097690 accepted</span></code></pre></td></tr></table></div></figure>


<p>一切都正常工作之后，我们就可以在 Mac 和 iPhone 上配置 Mail 来收发邮件了，由于我们只让 Dovecot 支持了 IMAP,所以收件服务器我们选择 imap。用户名和密码就是我们为 Dovecot 在 /etc/dovecot/users 中配置的用户名密码。邮件地址则是我们为 Postfix 添加的邮件地址，而且这些邮件邮件地址应该在/etc/postfix/controlled_envelop_senders中和SASL 用户做了关联，这个很好理解，就是登录成功的用户他可以用那几个邮件地址发送邮件。</p>

<h2>Reference:</h2>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-postfix-e-mail-server-with-dovecot#postfix">How To Set Up a Postfix E-Mail Server with Dovecot</a><br/>
<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-16-04#conclusion">How To Install and Configure Postfix on Ubuntu 16.04</a><br/>
<a href="http://www.postfix.org/">Postfix</a><br/>
<a href="http://wiki.dovecot.org/">Dovecot</a><br/>
<a href="http://www.binarytides.com/linux-mail-command-examples/">Linux mail command examples – send mails from command line</a><br/>
<a href="http://www.cnblogs.com/cocowool/archive/2012/03/14/2395390.html">SMTP的相关命令</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Photos 框架的基本使用]]></title>
    <link href="http://DamianSheldon.github.io/blog/photos-framework-usage.html"/>
    <updated>2016-12-23T14:23:33+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/photos-framework-usage</id>
    <content type="html"><![CDATA[<p>从 iOS 9 开始 Apple 把 Asset Library 标记为废弃状态，并建议开发者使用 Photos 框架。</p>

<blockquote><p>The Assets Library framework is deprecated as of iOS 9.0. Instead, use the Photos framework instead, which in iOS 8.0 and later provides more features and better performance for working with a user’s photo library.</p></blockquote>

<p>不幸的是 Apple 并没有发布相关的使用指导文档，只有一个相关 Demo。使用的时候固然可以回头参考这个 Demo，但这样的效率不是很高，很多概念也容易忘记，所以这里做个简单的总结。</p>

<p>Photos 中有不少类，其中几个犹为关键。PHPhotoLibary 是我们操作 Photo Library 里面资源的入口对象，所有的操作都通过它完成。PHCollectionList 表示相册中的专题列表；PHAssetCollection 表示专题；PHAsset 表示资源，如 images, videos, and Live Photos.</p>

<p>我们基本的需求就是 CRUD, 这些操作是需要用户授权的，记得先获取权限再操作， 下面我们展示相关的代码片段。</p>

<h3>Create</h3>

<ol>
<li>创建一个资源</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PHPhotoLibrary.shared().performChanges({
</span><span class='line'>            PHAssetChangeRequest.creationRequestForAsset(from: image)
</span><span class='line'>        }, completionHandler: {success, error in
</span><span class='line'>            if !success { print("error creating asset: \(error)") }
</span><span class='line'>        })</span></code></pre></td></tr></table></div></figure>


<ol>
<li>创建一个资源到指定的专题</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PHPhotoLibrary.shared().performChanges({
</span><span class='line'>            let creationRequest = PHAssetChangeRequest.creationRequestForAsset(from: image)
</span><span class='line'>            if let assetCollection = self.assetCollection {
</span><span class='line'>            let addAssetRequest = PHAssetCollectionChangeRequest(for: assetCollection)
</span><span class='line'>            addAssetRequest?.addAssets([creationRequest.placeholderForCreatedAsset!] as NSArray)
</span><span class='line'>            }
</span><span class='line'>        }, completionHandler: {success, error in
</span><span class='line'>            if !success { print("error creating asset: \(error)") }
</span><span class='line'>        })</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h3>Read (Fetch)</h3>

<p>获取资源是通过 PHAsset 提供的一系列以 fetchXXX 开头的类方法，选择哪个方法取决于需求，这里示例其中两个我觉得常用的方法。</p>

<ol>
<li><code>class func fetchAssets(with options: PHFetchOptions?) -&gt; PHFetchResult&lt;PHAsset&gt;</code></li>
</ol>


<p>我们可以用这个方法获取 Photo Library 里面所有的资源。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let allPhotosOptions = PHFetchOptions()
</span><span class='line'>    allPhotosOptions.sortDescriptors = [NSSortDescriptor(key: "creationDate", ascending: true)]
</span><span class='line'>self.fetchResult = PHAsset.fetchAssets(with: allPhotosOptions)</span></code></pre></td></tr></table></div></figure>


<ol>
<li><code>class func fetchAssets(in assetCollection: PHAssetCollection, options: PHFetchOptions?) -&gt; PHFetchResult&lt;PHAsset&gt;</code></li>
</ol>


<p>我们可以用这个方法获取指定专题里面的资源。例如我们想获取 Camera Roll 这个专题里面的资源：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let cameraRoll: PHFetchResult&lt;PHAssetCollection&gt; = PHAssetCollection.fetchAssetCollections(with: .smartAlbum, subtype: .smartAlbumUserLibrary, options: nil).firstObject
</span><span class='line'>let fetchResult = PHAsset.fetchAssets(in: cameraRoll, options: nil)</span></code></pre></td></tr></table></div></figure>


<h3>Update (Edit)</h3>

<p>编辑的基本的做法是先用资源请求一个 PHContentEditingInput，然后编辑资源，为了方便用户之后继续编辑或撤销可以实例化一个 PHAdjustmentData 对象来持有相关信息。编辑完成之后对于图片和视频需要实例化一个 PHContentEditingOutput 来完成输出，PHContentEditingOutput 的 adjustmentData 属性关联之前的 PHAdjustmentData, 并把编辑完成的内容输出到 PHContentEditingOutput 的 renderedContentURL。最后创建一个 PHAssetChangeRequest 对象，设置它的 contentEditingOutput 为
之前实例化的 PHContentEditingOutput。</p>

<p>这部分的代码会多点，具体可以查看 <a href="https://github.com/DamianSheldon/PhotosFrameworkUsage">Demo</a>.</p>

<h3>Delete</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PHPhotoLibrary.shared().performChanges({ 
</span><span class='line'>        PHAssetChangeRequest.deleteAssets([self.asset] as NSArray)
</span><span class='line'>        }) { (success, error) in
</span><span class='line'>    DispatchQueue.main.sync {
</span><span class='line'>        self.trashButton.isEnabled = success ? false : true
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    if success {
</span><span class='line'>        print("delete asset successfully")
</span><span class='line'>    }
</span><span class='line'>    else {
</span><span class='line'>        print("can't delete asset: \(error)")
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>完整 Demo</h3>

<p><a href="https://github.com/DamianSheldon/PhotosFrameworkUsage">PhotosFrameworkUsage</a></p>

<h3>Caveat</h3>

<p>使用过程中遇到一个坑，这里记一下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>guard let inputImage = CIImage(contentsOf: input.fullSizeImageURL!)
</span><span class='line'>            else { fatalError("can't load input image to edit") }
</span><span class='line'>
</span><span class='line'>// Apply the filter.
</span><span class='line'>let outputImage = inputImage
</span><span class='line'>    .applyingOrientation(input.fullSizeImageOrientation)
</span><span class='line'>.applyingFilter(filterName, withInputParameters: nil)
</span><span class='line'>
</span><span class='line'>// List 1.
</span><span class='line'>let uiImage = UIImage(ciImage: outputImage)
</span><span class='line'>
</span><span class='line'>// List 2.
</span><span class='line'>if let cgImage = CIContext(options: nil).createCGImage(outputImage, from: outputImage.extent) {
</span><span class='line'>    let uiImage = UIImage(cgImage:cgImage)
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>    print("instance UIImage from CGImage failed!")    
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// Ouput
</span><span class='line'>if let data = UIImageJPEGRepresentation(uiImage, 0.7) {
</span><span class='line'>    // NSData - (BOOL)writeToURL:(NSURL *)url atomically:(BOOL)atomically;
</span><span class='line'>    do {
</span><span class='line'>        try data.write(to: output.renderedContentURL)
</span><span class='line'>
</span><span class='line'>    } catch let error {
</span><span class='line'>        print("output filtered image to specify URL failed: \(error)")
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>    print("generate JPEG representation data failed")
</span><span class='line'>        return
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这里的问题是直接用 CIImage 实例化  UIImage 会失败，得转成 CGImage 然后实例化 UIImage. 至于它的原因我暂时还不清楚。</p>

<p>Reference:<a href="http://stackoverflow.com/questions/29732886/uiimagejpegrepresentation-returns-nil">UIImageJPEGRepresentation returns nil</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS 开发问题汇总(九)]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-development-problems-part-9.html"/>
    <updated>2016-11-15T14:49:17+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-development-problems-part-9</id>
    <content type="html"><![CDATA[<h3>1.Curried functions in Swift</h3>

<p>A:There’s a difference between self.methodname (which you are using), and Classname.methodname.</p>

<p>The former, when called within a class’s method, will give you a function bound with that class instance. So if you call it, it will be called on that instance.</p>

<p>The latter gives you a curried function that takes as an argument any instance of Classname, and returns a new function that is bound to that instance. At this point, that function is like the first case (only you can bind it to any instance you like).</p>

<p>Here’s an example to try and show that a bit better:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class C {
</span><span class='line'>    private let _msg: String
</span><span class='line'>        init(msg: String) { _msg = msg }
</span><span class='line'>
</span><span class='line'>    func c_print() { print(_msg) }
</span><span class='line'>
</span><span class='line'>    func getPrinter() -&gt; ()-&gt;() { return self.c_print }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>let c = C(msg: "woo-hoo")
</span><span class='line'>let f = c.getPrinter()
</span><span class='line'>// f is of type (())-&gt;()
</span><span class='line'>f() // prints "woo-hoo"
</span><span class='line'>
</span><span class='line'>let d = C(msg: "way-hey")
</span><span class='line'>
</span><span class='line'>let g = C.c_print
</span><span class='line'>// g is of type (C) -&gt; (()) -&gt; (),
</span><span class='line'>// you need to feed it a C:
</span><span class='line'>g(c)() // prints "woo-hoo"
</span><span class='line'>g(d)() // prints "way-hey"
</span><span class='line'>
</span><span class='line'>// instead of calling immediately,
</span><span class='line'>// you could store the return of g:
</span><span class='line'>let h = g(c)
</span><span class='line'>// at this point, f and h amount to the same thing:
</span><span class='line'>// h is of type (())-&gt;()
</span><span class='line'>h() // prints "woo-hoo"</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/27644702/curried-functions-in-swift">Curried functions in SWIFT</a></p>

<h3>2.NSLog on devices in iOS 10 / Xcode 8 will truncate.</h3>

<p>A:A temporary solution, just redefine all NSLOG to printf in a global header file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define NSLog(FORMAT, ...) printf("%s\n", [[NSString stringWithFormat:FORMAT, ##__VA_ARGS__] UTF8String]);</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/39584707/nslog-on-devices-in-ios-10-xcode-8-seems-to-truncate-why">NSLog on devices in iOS 10 / Xcode 8 seems to truncate? Why？</a></p>

<!--more-->


<h3>3.UIImagePickerViewController is black doesn&rsquo;t work for selecting photo or taking picture.</h3>

<p>A:I instance it via <code>UIImagePickerViewController(nibName:nil, boundle:nil)</code> that doesn&rsquo;t work, and change to <code>UIImagePickerViewController()</code> it works.</p>

<h3>4.How to create dispatch queue in Swift?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Concurrent dispatch queue
</span><span class='line'>let concurrentQueue = DispatchQueue(label: "queuename", attributes:.concurrent)
</span><span class='line'>
</span><span class='line'>// Serial dispatch queue
</span><span class='line'>let serialQueue = DispatchQueue(label: "queuename")</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/37805885/how-to-create-dispatch-queue-in-swift-3">How to create dispatch queue in Swift 3</a></p>

<h3>5.How to create a bitmap graphics context in Swift 3?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Create a bitmap graphics context with the sample buffer data
</span><span class='line'>guard let context = CGContext(data: baseAddress, width: width, height: height, bitsPerComponent: 8,
</span><span class='line'>        bytesPerRow: bytesPerRow, space: colorSpace, bitmapInfo: CGImageAlphaInfo.premultipliedFirst.rawValue | CGBitmapInfo.byteOrder32Little.rawValue) else {
</span><span class='line'>    return nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference: <a href="http://stackoverflow.com/questions/24109149/cgbitmapcontextcreate-error-with-swift">CGBitmapContextCreate error with swift</a></p>

<h3>6.Required plug-in compatibility UUID 37B30044-3B14-46BA-ABAA-F01000C27B63 for plug-in at path &lsquo;~/Library/Application Support/Developer/Shared/Xcode/Plug-ins/Unity4XC.xcplugin&rsquo; not present in DVTPlugInCompatibilityUUIDs</h3>

<p>A:There isn&rsquo;t official document about developing plugin for Xcode, so we can only attempt to solve it. Thanks to the internet, we can get a solution by other figure out.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>XCODEUUID=`defaults read /Applications/Xcode.app/Contents/Info DVTPlugInCompatibilityUUID`
</span><span class='line'>for f in ~/Library/Application\ Support/Developer/Shared/Xcode/Plug-ins/*; do defaults write "$f/Contents/Info" DVTPlugInCompatibilityUUIDs -array-add $XCODEUUID; done</span></code></pre></td></tr></table></div></figure>


<p>The reason probably is plugin developed compate with old Xcode, so it of course don&rsquo;t contain the lastest Xcode&rsquo;s UUID, we can manual add it if it really compate with the latest Xcode.</p>

<p>Reference: <a href="http://stackoverflow.com/questions/20732327/xcode-5-required-plug-in-not-present-in-dvtplugincompatibilityuuids?rq=1">Xcode 5 - Required plug-in not present in DVTPlugInCompatibilityUUIDs?</a></p>

<h3>7.Why AVCaptureSession output a wrong orientation?</h3>

<p>A:AVCaptureVideoPreviewLayer and AVCaptureOutput are different output destination, so we have to set oritentation for them each.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let captureConnection = videoDataOutput.connection(withMediaType: AVMediaTypeVideo)
</span><span class='line'>
</span><span class='line'>if captureConnection!.isVideoOrientationSupported {
</span><span class='line'>captureConnection!.videoOrientation = AVCaptureVideoOrientation.portrait
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>print("capture connection\(captureConnection!) doesn't support video orientation")
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/3561738/why-avcapturesession-output-a-wrong-orientation?rq=1">Why AVCaptureSession output a wrong orientation?</a><br/>
<a href="https://developer.apple.com/library/content/qa/qa1744/_index.html">Technical Q&amp;A QA1744 Setting the orientation of video with AV Foundation</a></p>

<h3>8.Operation stopped, the video could not be composed.</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Domain=AVFoundationErrorDomain Code=-11841 "Operation Stopped" UserInfo=0x1912c320 {NSLocalizedDescription=Operation Stopped, NSLocalizedFailureReason=The video could not be composed.}</span></code></pre></td></tr></table></div></figure>


<p>A: We should instance AVMutableComposition, AVMutableCompositionTrack every time when edit.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mutableComposition = AVMutableComposition()
</span><span class='line'>
</span><span class='line'>videoCompositionTrack = mutableComposition.addMutableTrack(withMediaType: AVMediaTypeVideo, preferredTrackID: kCMPersistentTrackID_Invalid)
</span><span class='line'>
</span><span class='line'>audioCompositionTrack = mutableComposition.addMutableTrack(withMediaType: AVMediaTypeAudio, preferredTrackID: kCMPersistentTrackID_Invalid)</span></code></pre></td></tr></table></div></figure>


<h3>9. How to get photos from iPhone simulator?</h3>

<p>A: Photo files are located at :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~/Library/Developer/CoreSimulator/Devices/&lt;device UDID&gt;/data/Media/DCIM/100APPLE/</span></code></pre></td></tr></table></div></figure>


<p>with Xcode 8.2. You can get <device UDID> from Devices window or using command:<code>xcrun simctl list devvices</code>.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/5488915/getting-images-from-iphone-simulator">getting images from iPhone simulator</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[音频和视频格式]]></title>
    <link href="http://DamianSheldon.github.io/blog/audio-and-video-file-format.html"/>
    <updated>2016-10-21T15:15:53+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/audio-and-video-file-format</id>
    <content type="html"><![CDATA[<h2>音频格式</h2>

<p>我们通常说的音频格式准确地讲应该是音频文件格式，它是计算机系统上用于存放数字音频数据的文件格式，也可以看作一个容器。</p>

<p>音频数据的比特分布我们称为音频编码格式，它可以非压缩编码或压缩编码。压缩编码又分为无损压缩和有损压缩。</p>

<p>编码器(codec)就是来编解码原始音频数据的。</p>

<p>声音源 &ndash;ADC&ndash;> raw audio data &ndash;codec&ndash;> audio data(uncompressed/compressed) &ndash;packed&ndash;> audio file format(container format)</p>

<blockquote><p>An audio file format is a file format for storing digital audio data on a computer system. The bit layout of the audio data (excluding metadata) is called the audio coding format and can be uncompressed, or compressed to reduce the file size, often using lossy compression. The data can be a raw bitstream in an audio coding format, but it is usually embedded in a container format or an audio data format with defined storage layer.</p>

<p>It is important to distinguish between the audio coding format, the container containing the raw audio data, and an audio codec. A codec performs the encoding and decoding of the raw audio data while this encoded data is (usually) stored in a container file. Although most audio file formats support only one type of audio coding data (created with an audio coder), a multimedia container format (as Matroska or AVI) may support multiple types of audio and video data.</p>

<p>There are three major groups of audio file formats:
    • Uncompressed audio formats, such as WAV, AIFF, AU or raw header-less PCM;
    • Formats with lossless compression, such as FLAC, Monkey&rsquo;s Audio (filename extension .ape), WavPack (filename extension .wv), TTA, ATRAC Advanced Lossless, ALAC (filename extension .m4a), MPEG-4 SLS, MPEG-4 ALS, MPEG-4 DST, Windows Media Audio Lossless (WMA Lossless), and Shorten (SHN).
    • Formats with lossy compression, such as Opus, MP3, Vorbis, Musepack, AAC, ATRAC and Windows Media Audio Lossy (WMA lossy).</p></blockquote>

<!--more-->


<h2>视频格式</h2>

<p>视频文件格式是计算机系统上一种用来存放数字视频数据的文件格式。视频几乎都是以压缩格式的形式存储的以便减小文件大小。</p>

<p>视频文件格式也是一个容器，里面包含编码完的视频和音频数据，同样是使用编码器来完成编解码工作。</p>

<blockquote><p>A video file format is a type of file format for storing digital video data on a computer system. Video is almost always stored in compressed form to reduce the file size.</p>

<p>A video file normally consists of a container format (e.g. Matroska) containing video data in a video coding format (e.g. VP9) alongside audio data in an audio coding format (e.g. Opus). The container format can also contain synchronization information, subtitles, and metadata such as title. A standardized (or in some cases de facto standard) video file type such as .webm is a profilespecified by a restriction on which container format and which video and audio compression formats are allowed.</p>

<p>The coded video and audio inside a video file container (i.e. not headers, footers and metadata) is called the essence. A program (or hardware) which can decode video or audio is called a codec; playing or encoding a video file will sometimes require the user to install a codec library corresponding to the type of video and audio coding used in the file.</p></blockquote>

<h2>iOS and Android supported audio &amp; video codec formats</h2>

<h3>iOS</h3>

<p>iOS supports many industry-standard and Apple-specific audio formats, including the following:</p>

<ul>
<li>AAC</li>
<li>Apple Lossless (ALAC)</li>
<li>A-law</li>
<li>IMA/ADPCM (IMA4)</li>
<li>Linear PCM</li>
<li>µ-law</li>
<li>DVI/Intel IMA ADPCM</li>
<li>Microsoft GSM 6.10</li>
<li>AES3-2003</li>
</ul>


<p>Preferred Audio Formats in iOS</p>

<ul>
<li><p>For uncompressed (highest quality) audio, use 16-bit, little endian, linear PCM audio data packaged in a CAF file.</p></li>
<li><p>For compressed audio when playing one sound at a time, and when you don’t need to play audio simultaneously with the iPod application, use the AAC format packaged in a CAF or m4a file.</p></li>
<li>For less memory usage when you need to play multiple sounds simultaneously, use IMA4 (IMA/ADPCM) compression. This reduces file size but entails minimal CPU impact during decompression. As with linear PCM data, package IMA4 data in a CAF file.</li>
</ul>


<p>iOS supports many industry-standard video formats and compression standards, including the following:</p>

<ul>
<li>H.264 video, up to 1.5 Mbps, 640 by 480 pixels, 30 frames per second, Low-Complexity version of the H.264 Baseline Profile with AAC-LC audio up to 160 Kbps, 48 kHz, stereo audio in .m4v, .mp4, and .mov file formats</li>
<li>H.264 video, up to 768 Kbps, 320 by 240 pixels, 30 frames per second, Baseline Profile up to Level 1.3 with AAC-LC audio up to 160 Kbps, 48 kHz, stereo audio in .m4v, .mp4, and .mov file formats</li>
<li>MPEG-4 video, up to 2.5 Mbps, 640 by 480 pixels, 30 frames per second, Simple Profile with AAC-LC audio up to 160 Kbps, 48 kHz, stereo audio in .m4v, .mp4, and .mov file formats</li>
<li>Numerous audio formats, including the ones listed in Audio Technologies</li>
</ul>


<h3>Android</h3>

<p>Audio</p>

<ul>
<li>AAC LC</li>
<li>HE-AACv1 (AAC+)</li>
<li>HE-AACv2 (enhanced AAC+)</li>
<li>AAC ELD (enhanced low delay AAC)</li>
<li>AMR-NB</li>
<li>AMR-WB</li>
<li>FLAC</li>
<li>MP3</li>
<li>MIDI</li>
<li>Vorbis</li>
<li>PCM/WAVE</li>
<li>Opus</li>
</ul>


<p>Video</p>

<ul>
<li>H.263</li>
<li>H.264 AVC</li>
<li>H.265 HEVC</li>
<li>MPEG-4 SP</li>
<li>VP8</li>
<li>VP9</li>
</ul>


<h3>iOS 和 Android 都支持的音频、视频格式</h3>

<p>Audio</p>

<ul>
<li>AAC LC (Low-Complexity profile)</li>
<li>Linear PCM</li>
</ul>


<p>Video</p>

<ul>
<li>H.264 AVC</li>
<li>MPEG-4 SP (Simple Profile)</li>
</ul>


<p>Profile</p>

<p>To address various applications ranging from low-quality, low-resolution surveillance cameras to high definition TV broadcasting and DVDs, many video standards group features into profiles and levels. MPEG-4 Part 2 has approximately 21 profiles, including profiles called Simple, Advanced Simple, Main, Core, Advanced Coding Efficiency, Advanced Real Time Simple, etc. The most commonly deployed profiles are Advanced Simple and Simple, which is a subset of Advanced Simple.</p>

<h2>Reference:</h2>

<p><a href="https://en.wikipedia.org/wiki/Audio_file_format">Audio file format</a><br/>
<a href="https://en.wikipedia.org/wiki/Video_file_format">Video file format</a><br/>
iOS Technology Overview<br/>
<a href="https://developer.android.com/guide/appendix/media-formats.html">Supported Media Formats</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android开发问题汇总(二)]]></title>
    <link href="http://DamianSheldon.github.io/blog/problems-of-android-development-part-2.html"/>
    <updated>2016-10-14T08:59:43+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/problems-of-android-development-part-2</id>
    <content type="html"><![CDATA[<h3>1.Error running app: Default Activity not found</h3>

<p>A: 问题的原因是 AndroidManifest.xml 文件配置的有问题。正确的样例如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>package="edu.self.buildexample"&gt;
</span><span class='line'>
</span><span class='line'>&lt;application
</span><span class='line'>android:allowBackup="true"
</span><span class='line'>android:icon="@mipmap/ic_launcher"
</span><span class='line'>android:label="@string/app_name"
</span><span class='line'>android:supportsRtl="true"
</span><span class='line'>android:theme="@style/AppTheme"&gt;
</span><span class='line'>
</span><span class='line'>&lt;activity android:name=".BuildExampleActivity"&gt;
</span><span class='line'>&lt;intent-filter&gt;
</span><span class='line'>&lt;action android:name="android.intent.action.MAIN" /&gt;
</span><span class='line'>
</span><span class='line'>&lt;category android:name="android.intent.category.LAUNCHER" /&gt;
</span><span class='line'>&lt;/intent-filter&gt;
</span><span class='line'>&lt;/activity&gt;
</span><span class='line'>&lt;/application&gt;
</span><span class='line'>&lt;/manifest&gt;</span></code></pre></td></tr></table></div></figure>


<h3>2. How to rename java package in Android Studio?</h3>

<p>A:<a href="http://stackoverflow.com/questions/16804093/android-studio-rename-package">Android Studio Rename Package</a></p>

<h3>3.No service of type Factory available in ProjectScopeServices</h3>

<p>A:Change maven gradle plugin version to 1.4.1 in project build.gradle file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dependencies {
</span><span class='line'>    classpath 'com.android.tools.build:gradle:2.2.2'
</span><span class='line'>        classpath 'com.github.dcendents:android-maven-gradle-plugin:1.4.1'
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference<a href="http://stackoverflow.com/questions/38825451/no-service-of-type-factory-available-in-projectscopeservices">No service of type Factory available in ProjectScopeServices</a></p>

<h3>4.Android Gradle cannot find symbol class Gson</h3>

<p>A:In my case, I just added this line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>compile 'com.google.code.gson:gson:2.7'</span></code></pre></td></tr></table></div></figure>


<p>on my app build.gradle file.</p>

<p>By now 2.7 is last current available version according to: <a href="https://mvnrepository.com/artifact/com.google.code.gson/gson">https://mvnrepository.com/artifact/com.google.code.gson/gson</a></p>

<p>Please check this repository to be sure you are using last available version.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/17913704/android-gradle-cannot-find-symbol-class-gson">Android Gradle cannot find symbol class Gson</a></p>

<!--more-->


<h3>5.Gradle sync failed: The SDK Build Tools revision (19.0.0) is too low for project &lsquo;:app&rsquo;. Minimum required is 19.1.0</h3>

<p>A:设置更新版本的Build Tools:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Step 1
</span><span class='line'>File &gt; Project Structure ... &gt; Modules(Select your module, eg:app) &gt; Properties &gt; Build Tools Version &gt; 25.0.0
</span><span class='line'>
</span><span class='line'>// Step 2:
</span><span class='line'>Module build.gradle
</span><span class='line'>
</span><span class='line'>android {
</span><span class='line'>    ...
</span><span class='line'>    buildToolsVersion "25.0.0"
</span><span class='line'>    ...
</span><span class='line'>} </span></code></pre></td></tr></table></div></figure>


<h3>6.Gradle sync failed: Could not find method android() for arguments [build_5v1bwdgcgpex8ek4ayinac3qa$_run_closure3@6518ea53] on root project &lsquo;ActionBarDemo&rsquo; of type org.gradle.api.Project.</h3>

<p>A:Root project gradle hasn&rsquo;t method android(), so remove it and setting in module gradle.</p>

<h3>7.Failed to resolve: junit:junit:4.12</h3>

<p>A:It happens HTTPS is blocked by proxy, so we have to disable proxy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Step 1
</span><span class='line'>Android Studio &gt; Preferences... &gt; System Settings &gt; HTTP Proxy &gt; No Proxy
</span><span class='line'>
</span><span class='line'>// Step 2: Uncomment http proxy settings in gradle.properties
</span><span class='line'>#systemProp.http.proxyHost=mirrors.neusoft.edu.cn
</span><span class='line'>#systemProp.http.proxyPort=80
</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/32519219/error23-17-failed-to-resolve-junitjunit4-12">Failed to resolve: junit:junit:4.12</a></p>

<h3>7.Error:Please select Android SDK</h3>

<p>A:应用的Run 标红，打开弹出的对话底部提示error please select Android SDK.工程是从 eclipse 迁移过来的，target SDK 一开始是没安装的，安装之后标红依然没有消失。File > Project Structure&hellip; > Properties > Compile SDK Version 选择一个之前安装好的版本，工程构建之后标红消息，之后再选择刚安装的 target SDK 作为Compile SDK Version, 工程自动重新构建成功，标红消息。应该是安装 SDK
版本之后没有立即生效，连带 android.app 包都找不到。</p>

<h3>8.unknown attr app:popuptheme</h3>

<p>A:The reason is miss relate name space:xmlns:app=&ldquo;<a href="http://schemas.android.com/apk/res-auto">http://schemas.android.com/apk/res-auto</a>&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Before
</span><span class='line'>&lt;android.support.v7.widget.Toolbar
</span><span class='line'>android:id="@+id/my_toolbar"
</span><span class='line'>android:layout_width="match_parent"
</span><span class='line'>android:layout_height="?attr/actionBarSize"
</span><span class='line'>android:background="?attr/colorPrimary"
</span><span class='line'>android:elevation="4dp"
</span><span class='line'>android:theme="@style/ThemeOverlay.AppCompat.ActionBar"
</span><span class='line'>app:popupTheme="@style/ThemeOverlay.AppCompat.Light"/&gt;
</span><span class='line'>
</span><span class='line'>// After
</span><span class='line'>&lt;android.support.v7.widget.Toolbar
</span><span class='line'>xmlns:app="http://schemas.android.com/apk/res-auto"
</span><span class='line'>android:id="@+id/my_toolbar"
</span><span class='line'>android:layout_width="match_parent"
</span><span class='line'>android:layout_height="?attr/actionBarSize"
</span><span class='line'>android:background="?attr/colorPrimary"
</span><span class='line'>android:elevation="4dp"
</span><span class='line'>android:theme="@style/ThemeOverlay.AppCompat.ActionBar"
</span><span class='line'>app:popupTheme="@style/ThemeOverlay.AppCompat.Light"/&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>9.How to get Activity&rsquo;s content view?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>this.getWindow().getDecorView().findViewById(android.R.id.content)
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>this.findViewById(android.R.id.content)
</span><span class='line'>or
</span><span class='line'>
</span><span class='line'>this.findViewById(android.R.id.content).getRootView()</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/5273436/how-to-get-activitys-content-view">How to get Activity&rsquo;s content view?</a></p>

<h3>10.Conversion to Dalvik format failed with error 1</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Dx 
</span><span class='line'>UNEXPECTED TOP-LEVEL EXCEPTION:
</span><span class='line'>    java.lang.RuntimeException: Exception parsing classes
</span><span class='line'>    at com.android.dx.command.dexer.Main.processClass(Main.java:752)
</span><span class='line'>    at com.android.dx.command.dexer.Main.processFileBytes(Main.java:718)
</span><span class='line'>    at com.android.dx.command.dexer.Main.access$1200(Main.java:85)
</span><span class='line'>    at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1645)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:170)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processDirectory(ClassPathOpener.java:229)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:158)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processDirectory(ClassPathOpener.java:229)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:158)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processDirectory(ClassPathOpener.java:229)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:158)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processDirectory(ClassPathOpener.java:229)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:158)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processDirectory(ClassPathOpener.java:229)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:158)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processDirectory(ClassPathOpener.java:229)
</span><span class='line'>    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:158)
</span><span class='line'>at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>A:This android project dependent on serveral java projects, when I change these java project&rsquo;s jre from 1.8 to 1.6, it works. The deep reason isn&rsquo;t clear.</p>

<h3>11.Make the Input Box Fill in the Screen Width</h3>

<p>A: Setting the width to zero (0dp) improves layout performance because using &ldquo;wrap_content&rdquo; as the width requires the system to calculate a width that is ultimately irrelevant because the weight value requires another width calculation to fill the remaining space.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;EditText android:id="@+id/edit_message"
</span><span class='line'>    android:layout_weight="1"
</span><span class='line'>    android:layout_width="0dp"
</span><span class='line'>    android:layout_height="wrap_content"
</span><span class='line'>    android:hint="@string/edit_message" /&gt;</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="https://developer.android.google.cn/training/basics/firstapp/building-ui.html">Building a Simple User Interface</a></p>

<h3>12. TabHost.TabSpec is not an enclosing class.</h3>

<p>A:TabHost.TabSpec is not static so it requires an instance of the outer class.Using TabHost&rsquo;s newTabSpec method instead of new TabHost.TabSpec.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/20252727/is-not-an-enclosing-class-java">Is not an enclosing class Java</a></p>

<h3>13. com.android.ide.common.process.ProcessException: Failed to execute aapt</h3>

<p>A: The reason is buildToolsVersion doesn&rsquo;t match compileSdkVersion, correct it in module gradle fix problem.</p>

<p>Reference:<a href="http://www.bokezhi.com/490.html">解决com.android.ide.common.process.ProcessException: Failed to execute aapt</a></p>

<h3>14. What is the difference between android:gravity and android:layout_gravity?</h3>

<p>A: The difference between android:gravity and android:layout_gravity is that android:gravity positions the contents of that view (i.e. what’s inside the view), whereas android:layout_gravity positions the view with respect to its parent (i.e. what the view is contained in).</p>

<p>Reference:<br/>
<a href="https://thinkandroid.wordpress.com/2010/01/14/how-to-position-views-properly-in-layouts/">How to Position Views Properly in Layouts</a></p>

<h3>15. Expected Resource of type ID</h3>

<p>A:It is a editor validation error as this is not a common way to deal with ids. So if your app supporting API 17 or higher, you can call View.generateViewId as</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>titleView.setId(View.generateViewId());</span></code></pre></td></tr></table></div></figure>


<p>and for API &lt; 17</p>

<ol>
<li>Open your project&rsquo;s res/values/ folder;</li>
<li>Create an xml filed called ids.xml with following content:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;resources&gt;
</span><span class='line'>    &lt;item name="titleId" type="id" /&gt;
</span><span class='line'>    &lt;item name="svId" type="id" /&gt;
</span><span class='line'>&lt;/resources&gt;</span></code></pre></td></tr></table></div></figure>


<p>then in your code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>titleView.setId(R.id.titleId);
</span><span class='line'>
</span><span class='line'>sv.setId(R.id.svId);</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/29696879/android-expected-resource-of-type-id">Android - Expected Resource of type ID</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS Technical Interview Part 4]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-technical-interview-part-4.html"/>
    <updated>2016-08-30T10:43:36+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-technical-interview-part-4</id>
    <content type="html"><![CDATA[<h3>1.熟悉 CocoaPods 么？能大概讲一下工作原理么？</h3>

<p>A:熟悉，项目中的 Podfile 文件指定了使用的第三方库，根据它可以找到对应的 podspec 。 podspec 文件存储着第三方库的基本信息：包含哪些文件，静态库，资源文件，信赖哪些其他第三方库、系统框架，之后 pod 会创建一个工程，把这个库以 target 的形式包含进来，应用则依赖这个 pod 工程。</p>

<h3>2.最常用的版本控制工具是什么，能大概讲讲原理么？</h3>

<p>A: Git</p>

<h3>3.你一般是怎么用 Instruments 的？</h3>

<p>A:根据想要分析的问题，选择对应的　instruments　，同时参考　Instruments　User　Guide．</p>

<h3>4.你一般是如何调试 Bug 的</h3>

<p>A:复现 bug，之后单步调试定位。</p>

<h3>5.你在你的项目中用到了哪些设计模式？</h3>

<p>A:</p>

<pre><code>* 单例
* 委托
* Target-Action
* MVC
* 观察者
* 工厂方法
* 信息流
* 类簇
</code></pre>

<!-- more -->


<h3>6.如何实现单例，单例会有什么弊端？</h3>

<p>A：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (instancetype)sharedInstance
</span><span class='line'>{
</span><span class='line'>    static dispatch_once_t once;
</span><span class='line'>    static id sharedInstance;
</span><span class='line'>    dispatch_once(&once, ^{
</span><span class='line'>        sharedInstance = [[self alloc] init];
</span><span class='line'>    });
</span><span class='line'>    return sharedInstance;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>单例相当于全局变量，因此存在强藕合，不利于扩展和应对变化；</li>
<li>单例违背单一设计原则；</li>
</ul>


<h3>7.如何把一个包含自定义对象的数组序列化到磁盘？</h3>

<p>A:自定义对象需要实现 NSCoding 协议，然后可以调用 NSKeyedArchiver 的<code>+ (BOOL)archiveRootObject:(id)rootObject toFile:(NSString *)path</code>方法将它序列化到磁盘。</p>

<h3>8.iOS 的沙盒目录结构是怎样的？ App Bundle 里面都有什么？</h3>

<p>A:</p>

<p>App Bundle 里面有 Info.plist, Executeable, Resource files and Other support files.</p>

<h3>9.iOS 7的多任务添加了哪两个新的 API? 各自的使用场景是什么？</h3>

<p>A:</p>

<ul>
<li>Apps that regularly update their content by contacting a server can register with the system and be launched periodically to retrieve that content in the background. To register, include the UIBackgroundModes key with the fetch value in your app’s Info.plist file. Then, when your app is launched, call the setMinimumBackgroundFetchInterval: method to determine how often it receives update messages. Finally, you must also implement the application:performFetchWithCompletionHandler: method in your app delegate.</li>
<li>Apps that use push notifications to notify the user that new content is available can fetch the content in the background. To support this mode, include the UIBackgroundModes key with the remote-notification value in your app’s Info.plist file. You must also implement the application:didReceiveRemoteNotification:fetchCompletionHandler: method in your app delegate.</li>
</ul>


<p>Reference: What&rsquo;s New in iOS</p>

<h3>10.Objective-C 的 class 是如何实现的？Selector 是如何被转化为 C 语言的函数调用的？</h3>

<p>A:</p>

<p>[receiver message]</p>

<p>=> objc_msgSend(receiver, selector);</p>

<h3>11.UIScrollView 大概是如何实现的，它是如何捕捉、响应手势的？</h3>

<h3>12.Objective-C 如何对已有的方法，添加自己的功能代码以实现类似记录日志这样的功能？</h3>

<p>A: Method Swizzle.</p>

<h3>13.<code>+load</code> 和 <code>+initialize</code> 的区别是什么？</h3>

<p>A:</p>

<ul>
<li>load:Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading.</li>
<li>initialize:Initializes the class before it receives its first message.</li>
</ul>


<h3>14.NSOperation 相比于 GCD 有哪些优势？</h3>

<p>A:</p>

<ul>
<li>可以取消操作；</li>
<li>可以添加依赖；</li>
<li>可以 KVO 属性;</li>
<li>可以添加优先级;</li>
<li>可以复用;</li>
</ul>


<h3>15.strong / weak / unsafe_unretained 的区别</h3>

<p>A:</p>

<ul>
<li>strong:对象的引用计数加一;</li>
<li>weak:对象的引用计数不变，对象销毁时 weak 属性自动置为nil;</li>
<li>unsafe_unretained:对象的引用计数不变，对象销毁时 unsafe_unretained 属性成为野指针;</li>
</ul>


<p>你可能会奇怪，有了 weak 还要 unsafe_unretained 干什么？ 原因是 weak 是 iOS 5 才可用的，所以当你要兼容 iOS 5, 或者将 iOS 5 时代之前 MRC 代码迁移到 ARC 时会用它，除些之外我们应该使用 weak.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/15968198/what-is-the-use-of-unsafe-unretained-attribute">http://stackoverflow.com/questions/15968198/what-is-the-use-of-unsafe-unretained-attribute</a></p>

<h3>16.Objective-C 中，meta-class 指的是什么</h3>

<p>A:类对象的类称为 meta-class.</p>

<h3>17.UIView 和 CALayer 之间的关系？</h3>

<p>A: UIView 会持有至少一个 CALayer 实例，CALayer 是 UIView 的骨架，它将 UIView 的内容绘制出来并提供动画支持。</p>

<h3>18.<code>+[UIView animateWithDuration:animations:completion:]</code> 内部大概是如何实现的？</h3>

<p>A:我觉得<code>+[UIView animateWithDuration:animations:completion:]</code> 内部应该是先使能 CALayer 实例的隐式动画，之后对 UIView animatable properties 的设置会传递到 CALayer 对应属性的 setter 方法，CALayer 的 setter 方法会触发对应的隐式动画，最后禁止 CALayer 实例的隐式动画。</p>

<p>Reference:</p>

<ul>
<li><a href="https://www.quora.com/How-is-UIViews-+animateWithDuration-animations-implemented">https://www.quora.com/How-is-UIViews-+animateWithDuration-animations-implemented</a></li>
<li><a href="http://stackoverflow.com/questions/15175750/how-uiview-animations-with-blocks-work-under-the-hood">http://stackoverflow.com/questions/15175750/how-uiview-animations-with-blocks-work-under-the-hood</a></li>
</ul>


<h3>19.什么时候会发生「隐式动画」？</h3>

<p>A: CALayer 的实例是支持隐式动画的，所以修改 CALayer Animatable Properties 里面的属性都可以触发隐式动画。UIView 默认禁止了 CALayer 的隐式动画，在动画块中又使能了，所以和 UIView 关联的 CALayer 实例只能在动画块中修改 Animatable UIView properties 里的属性也可以触发隐式动画。</p>

<p>Reference:<a href="http://stackoverflow.com/questions/4749343/when-exactly-do-implicit-animations-take-place-in-ios">http://stackoverflow.com/questions/4749343/when-exactly-do-implicit-animations-take-place-in-ios</a></p>

<h3>20.如何把一张大图缩小为1/4大小的缩略图？</h3>

<p>A:</p>

<ul>
<li>UIGraphicsBeginImageContextWithOptions &amp; UIImage -drawInRect:(UIKit)</li>
<li>CGBitmapContextCreate &amp; CGContextDrawImage(Core Graphics)</li>
<li>CGImageSourceCreateThumbnailAtIndex(Image IO)</li>
<li>Lanczos Resampling with Core Image(Core Image)</li>
<li>vImage in Accelerate(vImage)</li>
</ul>


<p>Reference:<a href="http://nshipster.com/image-resizing/">http://nshipster.com/image-resizing/</a></p>

<h3>21.Toll-Free Bridging 是什么？什么情况下会使用？</h3>

<p>A:</p>

<blockquote><p>There are a number of data types in the Core Foundation framework and the Foundation framework that can be used interchangeably. Data types that can be used interchangeably are also referred to as toll-free bridged data types. This means that you can use the same data structure as the argument to a Core Foundation function call or as the receiver of an Objective-C message invocation.</p></blockquote>

<h3>22.当系统出现内存警告时会发生什么？</h3>

<p>A:系统会杀死后台内存占用量大的应用释放内存给当前运行的应用，当前的应用也会收到内存警告的通知。</p>

<h3>23.什么是 Protocol，Delegate 一般是怎么用的？</h3>

<p>A:Protocol是一份消息合约。Delegate 是我们改变一个对象行为方式，这种方式不需要对类做继承。</p>

<h3>24.UIWebView 有哪些性能问题？有没有可替代的方案。</h3>

<p>A:</p>

<ul>
<li><strong>线程阻塞问题</strong>&ndash;当在 native 层调用 stringByEvaluatingJavaScriptFromString 方法时，可能由于 javascript 是单线程的原因，会阻塞原有 js 代码的执行。这里我们的解决办法是在 js 端用 defer 将 iframe 的插入延后执行。</li>
<li><strong>主线程的问题</strong>&ndash;UIWebView 的 stringByEvaluatingJavaScriptFromString 方法必须是主线程中执行，而主线程的执行时间过长就会 block UI 的更新。所以我们应该尽量让 stringByEvaluatingJavaScriptFromString 方法执行的时间短。</li>
</ul>


<p>Reference:<a href="http://blog.devtang.com/2012/03/24/talk-about-uiwebview-and-phonegap/">关于UIWebView的总结</a></p>

<h3>25.为什么 NotificationCenter 要 removeObserver? 如何实现自动 remove?</h3>

<p>A:因为之后产生了 Observer 感兴趣的通知 NotificationCenter 会调用 Observer 对应的处理方法，如果 Observer 销毁之后不从 NotificationCenter remove,那么会导致应用崩溃。</p>

<p>想要实现自动 remove，如果 NotificationCenter 对 Observer 的引用在 Observer 销毁后能自动置为 nil，类似 weak 的效果，那么问题就解决了。我们不能去修改 NotificationCenter 的内部实现，所以只能用其他的办法。有一个想法是在 Observer 销毁时调用 remove，可以利用 Objective-C 的 runtime 来帮助我们实现。具体思路是混写 addObserver 的方法，在这个混写方法中创建一个对象和 Observer 的生命周期关联起来，然后在这个关联对象的销毁方法中调用 removeObserver。</p>

<p>Reference:<a href="http://merowing.info/2012/03/automatic-removal-of-nsnotificationcenter-or-kvo-observers/">Automatic removal of NSNotificationCenter or KVO observers</a></p>

<h3>26.当 TableView 的 Cell 改变时，如何让这些改变以动画的形式呈现？</h3>

<p>A:You can also use beginUpdates method followed by the endUpdates method to animate the change in the row heights without reloading the cell.</p>

<h3>27.什么是 Method Swizzle，什么情况下会使用？</h3>

<p>A:Method Swizzle 是一种改变已存在方法实现的技术。当我们有改变已存在方法实现的需求是使用。</p>

<h3>28.为什么当 Core Animation 完成时，layer 又会恢复到原先的状态？</h3>

<p>A: Layer 有两个独立的图层: 1.modelLayer;2.presentationLayer. 动画是在 presentationLayer 上，所以当动画完成时， layer 又恢复到原先的状态。</p>

<h3>29.你会如何存储用户的一些敏感信息，如登录的 token。</h3>

<p>A:KeyChain services</p>

<h3>30.什么时候会使用 Core Graphics，有什么注意事项么？</h3>

<p>A:当需要绘制的内容不能用 UIKit 实现时，会使用 Core Graphics。</p>

<p>注意事项：</p>

<pre><code>* 坐标系统
* 线条的宽度尽量使用整数
* 缓存代价昂贵的数据
</code></pre>

<h3>31.使用 Block 时需要注意哪些问题？</h3>

<p>A:</p>

<ul>
<li>循环引用</li>
<li>对象的生命周期会延长</li>
</ul>


<h3>32.performSelector:withObject:afterDelay: 内部大概是怎么实现的，有什么注意事项么？</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)eoc_performSelector:(SEL)aSelector
</span><span class='line'>withObject:(id)anArgument
</span><span class='line'>afterDelay:(NSTimeInterval)delay
</span><span class='line'>{
</span><span class='line'>    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delay * NSEC_PER_SEC)), dispatch_get_global_queue(QOS_CLASS_UTILITY, 0), ^{
</span><span class='line'>            typedef void (*send_type)(id, SEL, id);
</span><span class='line'>
</span><span class='line'>            send_type func = (send_type)objc_msgSend;
</span><span class='line'>            func(self, aSelector, anArgument);
</span><span class='line'>            });
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>注意事项：
可能会导致内存泄露。因为不确定调用的方法，所以编译器不能插入合适的内存管理方法调用。例如newObject，copy之类的方法调用就会导致内存泄露。</p>

<h3>33.如何播放 GIF 图片，有什么优化方案么？</h3>

<p>A: 用 ImageIO 框架为每一帧动画创建一个 UIImage 对象，把这些对象聚合成一个 animatedImages 赋给 UIImageView，然后根据 GIF 的文件信息设置好 animationDuration 和 animationRepeatCount，最后调用 startAnimating。</p>

<p>优化方案：</p>

<ul>
<li>variable frame delays &ndash; One approach to support variable frame delays with UIImageView is to find the greatest common divisor of all frame delays and slot longer frames multiple times in a row into the animatedImages array.</li>
<li>memory implications &ndash; Whenever memory is the constraint, instead of storing the solution to a problem one has to recalculate it. In our case we needed a way to load and decode the frames just in time before they were displayed, and to purge the ones that were no longer on screen.</li>
</ul>


<p>Reference:</p>

<ul>
<li><a href="http://engineering.flipboard.com/2014/05/animated-gif/">How FlipBoard Play Animated GIFs On iOS</a></li>
</ul>


<h3>34.有哪几种方式可以对图片进行缩放，使用 CoreGraphics 缩放时有什么注意事项？</h3>

<p>A:</p>

<ul>
<li>UIGraphicsBeginImageContextWithOptions &amp; UIImage -drawInRect:(UIKit)</li>
<li>CGBitmapContextCreate &amp; CGContextDrawImage(Core Graphics)</li>
<li>CGImageSourceCreateThumbnailAtIndex(Image IO)</li>
<li>Lanczos Resampling with Core Image(Core Image)</li>
<li>vImage in Accelerate(vImage)</li>
</ul>


<h3>35.哪些途径可以让 ViewController 瘦下来？</h3>

<p>A: 我们的 App 基本都是使用类 MVC 架构，要想让 ViewController 瘦下来，基本的想法肯定是把和 ViewController 弱相关的代码移出去，移到哪？要么是称多 MV 中， 要么移到一个辅助对象中。所以基本做法应该是把弱业务代码移到 Model 中，和 View 相关的代码移到 View 中；甚至引入一个辅助对象来分担可以分离出去的职责。</p>

<p>Reference: <a href="https://objccn.io/issue-1-1/">更轻量的 View Controllers</a></p>

<h3>36.有哪些常见的 Crash 场景？</h3>

<p>A:</p>

<ul>
<li>数组越界</li>
<li>向数组或字典中插入的对象为 nil</li>
<li>向已经销毁的对象发送消息</li>
<li>内存管理出错</li>
<li>调用一个对象不支持的方法</li>
<li>看门狗超时</li>
<li>在非主线程操作 UI</li>
</ul>


<h3>37.设计一套大文件（如上百M的视频）下载方案。</h3>

<p>A:
<a href="https://github.com/thibaultcha/TCBlobDownload">TCBlobDownload</a></p>

<h3>38.如果让你来实现 dispatch_once，你会怎么做？</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void SpinlockOnce(dispatch_once_t *predicate, dispatch_block_t block) {
</span><span class='line'>        static OSSpinLock lock = OS_SPINLOCK_INIT;
</span><span class='line'>
</span><span class='line'>        OSSpinLockLock(&lock);
</span><span class='line'>        if(!*predicate) {
</span><span class='line'>            block();
</span><span class='line'>            *predicate = 1;
</span><span class='line'>        }
</span><span class='line'>        OSSpinLockUnlock(&lock);
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>Reference:
<a href="https://www.mikeash.com/pyblog/friday-qa-2014-06-06-secrets-of-dispatch_once.html">Friday Q&amp;A 2014-06-06: Secrets of dispatch_once</a></p>

<p>Reference:<a href="https://github.com/lzyy/iOS-Developer-Interview-Questions">https://github.com/lzyy/iOS-Developer-Interview-Questions</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS App 开发问题汇总（八）]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-development-problems-part-8.html"/>
    <updated>2016-06-24T15:54:30+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-development-problems-part-8</id>
    <content type="html"><![CDATA[<h3>1.Detect hash tags #, mention tags @, in iOS like in Twitter App</h3>

<p>A:You can use <a href="https://github.com/Krelborn/KILabel">https://github.com/Krelborn/KILabel</a> this library. It also detect user taps on hashtags Like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>label.hashtagLinkTapHandler = ^(KILabel *label, NSString *string, NSRange range) {
</span><span class='line'>  NSLog(@"Hashtag tapped %@", string);
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/24359972/detect-hash-tags-mention-tags-in-ios-like-in-twitter-app">http://stackoverflow.com/questions/24359972/detect-hash-tags-mention-tags-in-ios-like-in-twitter-app</a></p>

<h3>2.如何给应用重签名？</h3>

<p>A：利用用途广泛的命令行工具 security快速地显示出你的系统中能用来对代码进行签名的认证的方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ security find-identity -v -p codesigning                       
</span><span class='line'>  1) 01C8E9712E9632E6D84EC533827B4478938A3B15 "iPhone Developer: Thomas Kollbach (7TPNXN7G6K)"</span></code></pre></td></tr></table></div></figure>


<p>用<a href="https://github.com/fastlane/fastlane/tree/master/sigh">sign</a>给应用重签名</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sigh resign ./path/app.ipa --signing_identity "iPhone Distribution: Felix Krause" -p "my.mobileprovision"</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://objccn.io/issue-17-2/">http://objccn.io/issue-17-2/</a></p>

<!--more-->


<h3>3. It report BAD_ACCESS when set delegate for AVAudioPlayer.</h3>

<p>A: The reason is I instance AVAuidoPlayer without content like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>AVAudioPlayer *audioPlayer = [AVAudioPlayer new];
</span><span class='line'>audioPlayer.delegate = self;</span></code></pre></td></tr></table></div></figure>


<p>We should instance it with content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_audioPlayer = [[AVAudioPlayer alloc] initWithData:_audioData error:nil];
</span><span class='line'>[_audioPlayer prepareToPlay];
</span><span class='line'>_audioPlayer.delegate = self;</span></code></pre></td></tr></table></div></figure>


<h3>4.  How can I show my own app icon at the bottom-left corner of iPhone lock screen?</h3>

<p>Solution: 1. This is iOS 8 new feature called Handoff more info <a href="http://www.macrumors.com/2014/06/03/ios-8-apps-quick-access/">here</a>.</p>

<ol>
<li>You can&rsquo;t control what app appears in the bottom-left corner of the lock screen. Neither can you add code to your app to make your app appear there whenever you want. These are called Suggested Apps and it&rsquo;s a feature of iOS.</li>
</ol>


<p>iOS controls what app appears there based on several factors, including your location, the apps on your device, and your history of where &amp; when you use those apps. Together, iOS trys to present you with the app you would most-likely use at a given time, location, and history.</p>

<p>If you don&rsquo;t like this feature, it can be turned off in Settings -> General -> Handoff &amp; Suggested Apps.</p>

<p>Reference:<a href="http://apple.stackexchange.com/questions/166983/how-did-a-calendar-icon-make-it-to-my-lock-screen">http://apple.stackexchange.com/questions/166983/how-did-a-calendar-icon-make-it-to-my-lock-screen</a></p>

<p><a href="http://apple.stackexchange.com/questions/166983/how-did-a-calendar-icon-make-it-to-my-lock-screen">http://apple.stackexchange.com/questions/166983/how-did-a-calendar-icon-make-it-to-my-lock-screen</a></p>

<h3>5.</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> Class AJXorEncryptor is implemented in both /Users/dongmeiliang/Library/Developer/CoreSimulator/Devices/71988A60-BE7B-425A-BDE4-AAE4D098A516/data/Containers/Bundle/Application/051ED3F9-A920-41C8-9D96-41EED06DE618/AJFrameDevApp.app/AJFrameDevApp and /Users/dongmeiliang/Library/Developer/Xcode/DerivedData/AJFrameDevApp-fwmhocnqvmbmzkftzzdryfyigyzs/Build/Products/Debug-iphonesimulator/AJFrameDevApp.app/PlugIns/AJFrameDevAppTests.xctest/AJFrameDevAppTests. One of the two will be used. Which one is undefined.
</span><span class='line'> </span></code></pre></td></tr></table></div></figure>


<p> A:问题的原因是AJFrameDevApp和AJFrameDevAppTests这两个target都链接了一个相同的静态库。
 于是我将Podfile的内容由</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>target 'AJFrameDevApp' do
</span><span class='line'>    pod 'AJFrame', :path =&gt; '../'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>target 'AJFrameDevAppTests' do
</span><span class='line'>    pod 'AJFrame', :path =&gt; '../'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>target 'AJFrameDevApp' do
</span><span class='line'>    pod 'AJFrame', :path =&gt; '../'
</span><span class='line'>    
</span><span class='line'>    target 'AJFrameDevAppTests' do
</span><span class='line'>        inherit! :search_paths
</span><span class='line'>        
</span><span class='line'>    end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/30581884/class-is-implemented-in-both-one-of-the-two-will-be-used/30582486">http://stackoverflow.com/questions/30581884/class-is-implemented-in-both-one-of-the-two-will-be-used/30582486</a></p>

<h3>6. 如何调用私有类的私有方法？真实的场景是开发了一个库，库中A持有一个私有类的属性，那么如何对私有类进行相应的单元测试呢？</h3>

<p>A：Objective-C的runtime可以帮我们做到，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;objc/message.h&gt;
</span><span class='line'>
</span><span class='line'>NSString *originalString = @"testEncryptMethod";
</span><span class='line'>    
</span><span class='line'>NSData *originalData = [originalString dataUsingEncoding:NSUTF8StringEncoding];
</span><span class='line'>    
</span><span class='line'>AJBinaryChannel *binaryChannel = [AJBinaryChannel new];
</span><span class='line'>binaryChannel.encryptKey = @"xorkey";
</span><span class='line'>    
</span><span class='line'>id wrapperEncryptor = (id)(binaryChannel.encryptor);
</span><span class='line'>    
</span><span class='line'>typedef NSData* (*send_type)(id, SEL, id);
</span><span class='line'>    
</span><span class='line'>send_type func = (send_type)objc_msgSend;
</span><span class='line'>    
</span><span class='line'>NSData *encryptData = func(wrapperEncryptor, @selector(encrypt:), originalData);
</span><span class='line'>    
</span><span class='line'>NSString *encryptString = [[NSString alloc] initWithData:encryptData encoding:NSUTF8StringEncoding];
</span><span class='line'>
</span><span class='line'>XCTAssertNotEqualObjects(originalString, encryptString);
</span><span class='line'>    
</span><span class='line'>NSData *decryptData = func(wrapperEncryptor, @selector(decrypt:), encryptData);
</span><span class='line'>    
</span><span class='line'>NSString *decryptString = [[NSString alloc] initWithData:decryptData encoding:NSUTF8StringEncoding];
</span><span class='line'>
</span><span class='line'>XCTAssertEqualObjects(originalString, decryptString);</span></code></pre></td></tr></table></div></figure>


<h3>7.Too many arguments to function call, expected 0, have 3</h3>

<p>A:The answer is you need to strong type objc_msgSend for the compiler to build it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef void (*send_type)(void*, SEL, void*);
</span><span class='line'>send_type func = (send_type)objc_msgSend;
</span><span class='line'>func(anItem.callback_object, NSSelectorFromString(anItem.selector), dict);</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/24922913/too-many-arguments-to-function-call-expected-0-have-3">http://stackoverflow.com/questions/24922913/too-many-arguments-to-function-call-expected-0-have-3</a></p>

<h3>8. Why do we need Base64?</h3>

<p>A:Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation.
A binary-to-text encoding is encoding of data in plain text. More precisely, it is an encoding of binary data in a sequence of characters. <strong>These encodings are necessary for transmission of data when the channel does not allow binary data (such as email or NNTP) or is not 8-bit clean.</strong></p>

<p>Reference:<a href="https://en.wikipedia.org/wiki/Base64">https://en.wikipedia.org/wiki/Base64</a>
<a href="https://en.wikipedia.org/wiki/Binary-to-text_encoding">https://en.wikipedia.org/wiki/Binary-to-text_encoding</a></p>

<h3>9. 360° panorama libraries for ios</h3>

<p>A:<a href="https://code.google.com/archive/p/panoramagl/">panoramagl</a></p>

<p>Reference:<a href="http://stackoverflow.com/questions/3763978/360-panorama-libraries-for-ios">http://stackoverflow.com/questions/3763978/360-panorama-libraries-for-ios</a></p>

<h3>10. When should we use macro in iOS?</h3>

<p>A: As we known, macro has many disatanges:1.lack type info;2.can be redfine. Since its a keyword in C, when should we use it?</p>

<p>There are occasions where macros provide functionality not available through other means.</p>

<p>For example, I have a simple macro I sometimes use when debugging Objective-C to log when certain methods are called. This can be done like so:</p>

<p><code>NSLog(@"%@: %@", NSStringFromClass([self class]), NSStringFromSelector(_cmd));</code>
This can’t be moved into an Objective-C method because it will always log the name of that method. (Obviously it can’t be moved into a C method, as there is no self and no _cmd variables available.) Creating a macro for this is straightforward, however:</p>

<p><code>#define LOG_SELECTOR()  NSLog(@"%@: %@", NSStringFromClass([self class]), NSStringFromSelector(_cmd));</code></p>

<p>Reference:<a href="http://weblog.highorderbit.com/post/11656225202/appropriate-use-of-c-macros-for-objective-c">Appropriate Use of C Macros for Objective-C Developers</a></p>

<h3>11.Open Source VoIP/SIP Objective-C Code?</h3>

<p>A:siphon (<a href="http://code.google.com/p/siphon/">http://code.google.com/p/siphon/</a>).</p>

<blockquote><p>Home of the World&rsquo;s first free SIP/VoIP application for iPhone and iPod Touch 1 and 2.</p>

<p>Siphon SIP/VoIP project is the first in his category that works on iPhone and iPod Touch 2 with headset for all SIP providers. It is a nat>ive application approved running on 2.X using internal micro/speaker and headset.</p>

<p>The Application supports the SIP standard, preserving compatibility with hundreds of SIP providers and offers a GUI which preserves the ap>>ple design of native iPhone applications.</p></blockquote>

<p>Reference:<a href="http://stackoverflow.com/questions/1493050/ios-open-source-voip-sip-objective-c-code">iOS: Open Source VoIP/SIP Objective-C Code</a></p>

<h3>12. How to show a search icon in indexed table view?</h3>

<p>A:UITableViewIndexSearch.</p>

<blockquote><p>If the data source includes this constant string in the array of strings it returns in sectionIndexTitlesForTableView:, the section index displays a magnifying glass icon at the corresponding index location. This location should generally be the first title in the index.</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSArray *)sectionIndexTitles
</span><span class='line'>{
</span><span class='line'>    if (!_sectionIndexTitles) {
</span><span class='line'>        NSArray *titles = [UILocalizedIndexedCollation currentCollation].sectionIndexTitles;
</span><span class='line'>
</span><span class='line'>        NSMutableArray *tmpArray = [NSMutableArray arrayWithCapacity:titles.count + 1];
</span><span class='line'>        [tmpArray addObject:UITableViewIndexSearch];
</span><span class='line'>
</span><span class='line'>        for (NSString *title in titles) {
</span><span class='line'>            [tmpArray addObject:title];
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        _sectionIndexTitles = tmpArray.copy;
</span><span class='line'>    }
</span><span class='line'>    return _sectionIndexTitles;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (NSArray *)sectionIndexTitlesForTableView:(UITableView *)tableView {
</span><span class='line'>        return self.sectionIndexTitles;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>How to implement a function that active search bar when user tap magnifying glass icon?</p>

<p>First, add support for indexed table view;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Create the search results controller and store a reference to it.
</span><span class='line'>MySearchResultsController* resultsController = [[MySearchResultsController alloc] init];
</span><span class='line'>self.searchController = [[UISearchController alloc] initWithSearchResultsController:resultsController];
</span><span class='line'> 
</span><span class='line'> // Use the current view controller to update the search results.
</span><span class='line'> self.searchController.searchResultsUpdater = self;
</span><span class='line'>  
</span><span class='line'>  // Install the search bar as the table header.
</span><span class='line'>  self.tableView.tableHeaderView = self.searchController.searchBar;
</span><span class='line'>   
</span><span class='line'>   // It is usually good to set the presentation context.
</span><span class='line'>   self.definesPresentationContext = YES;</span></code></pre></td></tr></table></div></figure>


<p>Note: set navigation bar to translucent via Interface Builder or Programatically <code>   self.navigationController.navigationBar.translucent = YES;</code>, otherwise search bar will animate out table view.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/26222671/uisearchcontroller-searchbar-in-tableheaderview-animating-out-of-the-screen">UISearchController searchBar in tableHeaderView animating out of the screen</a></p>

<p>Second, hack tableView:sectionForSectionIndexTitle:atIndex: method.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSInteger)tableView:(UITableView *)tableView sectionForSectionIndexTitle:(NSString *)title atIndex:(NSInteger)index {
</span><span class='line'>    if (!index) {
</span><span class='line'>        self.searchController.active = YES;
</span><span class='line'>    }
</span><span class='line'>    return [self.collation sectionForSectionIndexTitleAtIndex:index];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/26149526/making-uitableviewindexsearch-jump-to-tableheaderview-instead-of-section-0">Making UITableViewIndexSearch jump to tableHeaderView instead of section 0</a></p>

<h3>13.Transparent UIToolbar</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[self.toolbar setBackgroundImage:[UIImage new]
</span><span class='line'>forToolbarPosition:UIBarPositionAny
</span><span class='line'>barMetrics:UIBarMetricsDefault];
</span><span class='line'>[self.toolbar setShadowImage:[UIImage new]
</span><span class='line'>forToolbarPosition:UIBarPositionAny];</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/18969248/how-to-draw-a-transparent-uitoolbar-or-uinavigationbar-in-ios7">How to draw a transparent UIToolbar or UINavigationBar in iOS7</a></p>

<h3>14.App Transport Security Dictionary Details</h3>

<p>A:Information Property List Key Reference.</p>

<h3>15.How do i get Weekday and/or name of month from a NSDate variable?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSDateFormatter *dateFormatter = [[NSDateFormatter alloc] init];
</span><span class='line'>dateFormatter.dateFormat = @"yyyyMMdd";
</span><span class='line'>NSDate *date = [dateFormatter dateFromString:@"20111010"];
</span><span class='line'>
</span><span class='line'>// set swedish locale
</span><span class='line'>dateFormatter.locale=[[NSLocale alloc] initWithLocaleIdentifier:@"sv_SE"];
</span><span class='line'>
</span><span class='line'>dateFormatter.dateFormat=@"MMMM";
</span><span class='line'>NSString *monthString = [[dateFormatter stringFromDate:date] capitalizedString];
</span><span class='line'>NSLog(@"month: %@", monthString);
</span><span class='line'>
</span><span class='line'>dateFormatter.dateFormat=@"EEEE";
</span><span class='line'>NSString *dayString = [[dateFormatter stringFromDate:date] capitalizedString];
</span><span class='line'>NSLog(@"day: %@", dayString);</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>month: Oktober
</span><span class='line'>day: Måndag</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/5591612/how-do-i-get-weekday-and-or-name-of-month-from-a-nsdate-variable">How do i get Weekday and/or name of month from a NSDate variable?</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS App 开发问题汇总（七）]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-development-problems-part-7.html"/>
    <updated>2016-05-03T17:00:04+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-development-problems-part-7</id>
    <content type="html"><![CDATA[<h3>1.如何设置透明的导航栏并且去掉其底部灰色的分隔线？</h3>

<p>A:可以通过设置导航栏的背景图和阴隐图为透明的图片来实现。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewDidAppear:(BOOL)animated
</span><span class='line'>{
</span><span class='line'>    [super viewDidAppear:animated];
</span><span class='line'>    
</span><span class='line'>    self.translucent = self.navigationController.navigationBar.isTranslucent;
</span><span class='line'>    self.navigationController.navigationBar.translucent = YES;
</span><span class='line'>    
</span><span class='line'>    self.previousImage = [self.navigationController.navigationBar backgroundImageForBarMetrics:UIBarMetricsDefault];
</span><span class='line'>    
</span><span class='line'>    UIImage *newImage = [UIImage imageNamed:@"TransparentPixel"];
</span><span class='line'>    [self.navigationController.navigationBar setBackgroundImage:newImage forBarMetrics:UIBarMetricsDefault];
</span><span class='line'>    
</span><span class='line'>    self.previousShadowImage = self.navigationController.navigationBar.shadowImage;
</span><span class='line'>    self.navigationController.navigationBar.shadowImage = newImage;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)viewWillDisappear:(BOOL)animated
</span><span class='line'>{
</span><span class='line'>    [super viewWillDisappear:animated];
</span><span class='line'>    
</span><span class='line'>    self.navigationController.navigationBar.translucent = self.translucent;
</span><span class='line'>    
</span><span class='line'>    [self.navigationController.navigationBar setBackgroundImage:self.previousImage forBarMetrics:UIBarMetricsDefault];
</span><span class='line'>    self.navigationController.navigationBar.shadowImage = self.previousShadowImage;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:Apple&rsquo;s sample code Customizing UINavigationBar<br/>
<a href="http://stackoverflow.com/questions/18921082/separator-between-navigation-bar-and-view-ios-7">http://stackoverflow.com/questions/18921082/separator-between-navigation-bar-and-view-ios-7</a></p>

<!-- more -->


<h3>2. 自定义的View设置cornerRadius不生效</h3>

<h3>3. CocoaPods 升级到1.0，Xcode 一直报 header file not found.</h3>

<p>A: 仔细查看了 Xcode 的编译过程，头文件的路径是包含了的，于是怀疑是Xcode的自身可能存在问题。经过实验，可以用下面的方法解决：</p>

<ol>
<li>Clean project</li>
<li>Window > Projects > Your Project > Delete Derived Data</li>
<li>Build</li>
</ol>


<h3>4. No codesigning identities (i.e. certificate and private key pairs) that match the team ID: xxx</h3>

<p>A:</p>

<ul>
<li>Go to Xcode preferences, view details of the Apple ID, and delete the provisioning file that&rsquo;s complaining, redownload.</li>
<li>Go to the Keychain Access, and delete the development certificate that&rsquo;s related to the provisioning file you just deleted.</li>
</ul>


<p>Reference:<a href="http://stackoverflow.com/questions/19197497/ios-7-0-no-code-signing-identities-found">http://stackoverflow.com/questions/19197497/ios-7-0-no-code-signing-identities-found</a></p>

<h3>5. How to load image from CocoaPods resource bundle ?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  s.resource_bundles = {
</span><span class='line'>    'DMLSelector' =&gt; ['DMLSelector/Assets/*.png']
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  NSBundle *bundle = [NSBundle bundleForClass:[self class]];
</span><span class='line'>  self.imageView.image = [UIImage imageNamed:@"DMLSelector.bundle/Checked" inBundle:bundle compatibleWithTraitCollection:nil];</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/23835052/load-image-from-cocoapods-resource-bundle">http://stackoverflow.com/questions/23835052/load-image-from-cocoapods-resource-bundle</a></p>

<h3>6. How to specify NSLineBreakMode in boundingRectWithSize?</h3>

<p>A: Use NSParagraphStyleAttributeName &amp; NSParagraphStyle:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSMutableParagraphStyle *paragraph = [[NSMutableParagraphStyle alloc] init];
</span><span class='line'>paragraph.lineBreakMode = NSLineBreakByWordWrapping; //e.g.
</span><span class='line'>
</span><span class='line'>CGSize size = [label.text boundingRectWithSize: constrainedSize options:NSStringDrawingUsesLineFragmentOrigin attributes: @{ NSFontAttributeName: label.font, NSParagraphStyleAttributeName: paragraph } context: nil].size;</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/20631464/how-to-specify-nslinebreakmode-in-boundingrectwithsize">http://stackoverflow.com/questions/20631464/how-to-specify-nslinebreakmode-in-boundingrectwithsize</a></p>

<h3>7.</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO [2016-06-01 15:42:30.78]: ---------------------------------------------------------------------
</span><span class='line'>INFO [2016-06-01 15:42:30.78]: --- Step: fir p ../BBCApp.ipa -T token ---
</span><span class='line'>INFO [2016-06-01 15:42:30.78]: ---------------------------------------------------------------------
</span><span class='line'>INFO [2016-06-01 15:42:30.78]: $ fir p ../BBCApp.ipa -T c977500277789d01cc67d82750057858
</span><span class='line'>INFO [2016-06-01 15:42:34.31]: ▸ /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/2.0.0/rubygems/dependency.rb:296:in `to_specs': Could not find 'fir-cli' (&gt;= 0) among 206 total gem(s) (Gem::LoadError)
</span><span class='line'>INFO [2016-06-01 15:42:34.31]: ▸ from /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/2.0.0/rubygems/dependency.rb:307:in `to_spec'
</span><span class='line'>INFO [2016-06-01 15:42:34.31]: ▸ from /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/2.0.0/rubygems/core_ext/kernel_gem.rb:47:in `gem'
</span><span class='line'>INFO [2016-06-01 15:42:34.31]: ▸ from /usr/local/bin/fir:22:in `&lt;main&gt;'</span></code></pre></td></tr></table></div></figure>


<p>A: 问题的原因是找不到fir这个命令，可以直接指定绝对路径解决。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sh "/Library/Ruby/Gems/2.0.0/gems/fir-cli-1.5.0/bin/fir p ../BBCApp.ipa -T token"</span></code></pre></td></tr></table></div></figure>


<h3>8. 怎么获取iPhone上已安装App的ipa文件？</h3>

<p>A: 可以利用iTunes下载已购的功能。</p>

<p>You can redownload apps on your iPhone or iPod touch, iPad, Mac or PC, or Apple TV (4th generation). You can also redownload some in-app purchases.</p>

<p>On a Mac or PC
From iTunes
1. Open iTunes.
2. Click Sign In, and then enter your Apple ID and password.
3. Click your name and select Purchased from the menu.
4. From the upper-right corner of the screen, click Apps.
5. Click &ldquo;Not in My Library&rdquo; to view purchased content that isn&rsquo;t on your computer.
6. Scroll to find the item that you want to download.
7. Click the Download icon  in the upper-right corner of the item that you want to download. Your app downloads to your library.</p>

<p>下载需要点时间，所以点开My Apps tab面不能马上看到刚下载的App,右上角有个下载进度提示，点击可以看详情。</p>

<p>Reference:<a href="https://support.apple.com/en-qa/HT201272">https://support.apple.com/en-qa/HT201272</a></p>

<h3>9. UICollectionView&rsquo;s cellForItemAtIndexPath is not being called</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.automaticallyAdjustsScrollViewInsets = NO;</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/14668781/uicollectionviews-cellforitematindexpath-is-not-being-called?rq=1">http://stackoverflow.com/questions/14668781/uicollectionviews-cellforitematindexpath-is-not-being-called?rq=1</a></p>

<h3>10. iOS supported audio formats?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@"aac",@"adts",@"ac3",@"aif",@"aiff",@"aifc",@"caf",@"mp3",@"mp4",@"m4a",@"snd",@"au",@"sd2",@"wav"</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/1761460/supported-audio-file-formats-in-iphone">http://stackoverflow.com/questions/1761460/supported-audio-file-formats-in-iphone</a>
<a href="https://www.raywenderlich.com/69365/audio-tutorial-ios-file-data-formats-2014-edition">https://www.raywenderlich.com/69365/audio-tutorial-ios-file-data-formats-2014-edition</a></p>

<h3>11. How do I put the image on the right side of the text in a UIButton?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CGFloat spacing          = 3;
</span><span class='line'>    CGFloat insetAmount      = 0.5 * spacing;
</span><span class='line'>
</span><span class='line'>    // First set overall size of the button:
</span><span class='line'>    button.contentEdgeInsets = UIEdgeInsetsMake(0, insetAmount, 0, insetAmount);
</span><span class='line'>    [button sizeToFit];
</span><span class='line'>
</span><span class='line'>    // Then adjust title and image insets so image is flipped to the right and there is spacing between title and image:
</span><span class='line'>    button.titleEdgeInsets   = UIEdgeInsetsMake(0, -button.imageView.frame.size.width - insetAmount, 0,  button.imageView.frame.size.width  + insetAmount);
</span><span class='line'>    button.imageEdgeInsets   = UIEdgeInsetsMake(0, button.titleLabel.frame.size.width + insetAmount, 0, -button.titleLabel.frame.size.width - insetAmount);</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/7100976/how-do-i-put-the-image-on-the-right-side-of-the-text-in-a-uibutton">http://stackoverflow.com/questions/7100976/how-do-i-put-the-image-on-the-right-side-of-the-text-in-a-uibutton</a></p>

<p>extension:How to position image top title bottom in a UIButton?
A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Objc
</span><span class='line'>-(void)imageTopTitleBottom:(UIButton *)button
</span><span class='line'>{
</span><span class='line'>    // the space between the image and text
</span><span class='line'>    CGFloat spacing = 3.0;
</span><span class='line'>
</span><span class='line'>    // lower the text and push it left so it appears centered
</span><span class='line'>    //  below the image
</span><span class='line'>    CGSize imageSize = button.imageView.image.size;
</span><span class='line'>    button.titleEdgeInsets = UIEdgeInsetsMake(0.0, - imageSize.width, - (imageSize.height + spacing), 0.0);
</span><span class='line'>
</span><span class='line'>    // raise the image and push it right so it appears centered
</span><span class='line'>    //  above the text
</span><span class='line'>    CGSize titleSize = [button.titleLabel.text sizeWithAttributes:@{NSFontAttributeName: button.titleLabel.font}];
</span><span class='line'>    button.imageEdgeInsets = UIEdgeInsetsMake(- (titleSize.height + spacing), 0.0, 0.0, - titleSize.width);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// Swift
</span><span class='line'>func imageTopTitleBottom() -&gt; Void {
</span><span class='line'>    if let buttonImage = self.image(for: .normal), let title = self.title(for: .normal) {
</span><span class='line'>        let spacing: CGFloat = 2.0
</span><span class='line'>
</span><span class='line'>            let imageSize = buttonImage.size
</span><span class='line'>
</span><span class='line'>            self.titleEdgeInsets = UIEdgeInsetsMake(0, -imageSize.width, -(imageSize.height + spacing), 0)
</span><span class='line'>
</span><span class='line'>            let titleString = title as NSString
</span><span class='line'>
</span><span class='line'>            let stringSize = titleString.size(attributes: [NSFontAttributeName: self.titleLabel!.font])
</span><span class='line'>
</span><span class='line'>            self.imageEdgeInsets = UIEdgeInsetsMake(-(stringSize.height + spacing), 0, 0, -stringSize.width)
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>12. duplicate symbol _iToastDuration</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>enum iToastDuration {
</span><span class='line'>  iToastDurationLong = 10000,
</span><span class='line'>  iToastDurationShort = 1000,
</span><span class='line'>  iToastDurationNormal = 3000
</span><span class='line'>}iToastDuration;</span></code></pre></td></tr></table></div></figure>


<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef enum iToastDuration {
</span><span class='line'>  iToastDurationLong = 10000,
</span><span class='line'>  iToastDurationShort = 1000,
</span><span class='line'>  iToastDurationNormal = 3000
</span><span class='line'>}iToastDuration;</span></code></pre></td></tr></table></div></figure>


<h3>13. Detecting taps on attributed text in a UITextView in iOS</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import UIKit
</span><span class='line'>class ViewController: UIViewController, UIGestureRecognizerDelegate {
</span><span class='line'>
</span><span class='line'>    @IBOutlet weak var textView: UITextView!
</span><span class='line'>
</span><span class='line'>    override func viewDidLoad() {
</span><span class='line'>        super.viewDidLoad()
</span><span class='line'>
</span><span class='line'>        // Create an attributed string
</span><span class='line'>        let myString = NSMutableAttributedString(string: "Swift attributed text")
</span><span class='line'>
</span><span class='line'>        // Set an attribute on part of the string
</span><span class='line'>        let myRange = NSRange(location: 0, length: 5) // range of "Swift"
</span><span class='line'>        let myCustomAttribute = [ "MyCustomAttributeName": "some value"]
</span><span class='line'>        myString.addAttributes(myCustomAttribute, range: myRange)
</span><span class='line'>
</span><span class='line'>        textView.attributedText = myString
</span><span class='line'>
</span><span class='line'>        // Add tap gesture recognizer to Text View
</span><span class='line'>        let tap = UITapGestureRecognizer(target: self, action: #selector(myMethodToHandleTap(_:)))
</span><span class='line'>        tap.delegate = self
</span><span class='line'>        textView.addGestureRecognizer(tap)
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    func myMethodToHandleTap(sender: UITapGestureRecognizer) {
</span><span class='line'>
</span><span class='line'>        let myTextView = sender.view as! UITextView
</span><span class='line'>        let layoutManager = myTextView.layoutManager
</span><span class='line'>
</span><span class='line'>        // location of tap in myTextView coordinates and taking the inset into account
</span><span class='line'>        var location = sender.locationInView(myTextView)
</span><span class='line'>        location.x -= myTextView.textContainerInset.left;
</span><span class='line'>        location.y -= myTextView.textContainerInset.top;
</span><span class='line'>
</span><span class='line'>        // character index at tap location
</span><span class='line'>        let characterIndex = layoutManager.characterIndexForPoint(location, inTextContainer: myTextView.textContainer, fractionOfDistanceBetweenInsertionPoints: nil)
</span><span class='line'>
</span><span class='line'>        // if index is valid then do something.
</span><span class='line'>        if characterIndex &lt; myTextView.textStorage.length {
</span><span class='line'>
</span><span class='line'>            // print the character index
</span><span class='line'>            print("character index: \(characterIndex)")
</span><span class='line'>
</span><span class='line'>            // print the character at the index
</span><span class='line'>            let myRange = NSRange(location: characterIndex, length: 1)
</span><span class='line'>            let substring = (myTextView.attributedText.string as NSString).substringWithRange(myRange)
</span><span class='line'>            print("character at index: \(substring)")
</span><span class='line'>
</span><span class='line'>            // check if the tap location has a certain attribute
</span><span class='line'>            let attributeName = "MyCustomAttributeName"
</span><span class='line'>            let attributeValue = myTextView.attributedText.attribute(attributeName, atIndex: characterIndex, effectiveRange: nil) as? String
</span><span class='line'>            if let value = attributeValue {
</span><span class='line'>               print("You tapped on \(attributeName) and the value is: \(value)")
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/19332283/detecting-taps-on-attributed-text-in-a-uitextview-in-ios?rq=1">http://stackoverflow.com/questions/19332283/detecting-taps-on-attributed-text-in-a-uitextview-in-ios?rq=1</a></p>

<h3>14. iOS 开发中如何获取农历？</h3>

<p>A: iOS 8 以后 Apple 内置了农历支持，可以得到类似<strong>2016丙申年五月十七星期二</strong>的信息，如果你只需要这些信息就够了，那使用内置的农历就可以了。如果还想获取类似<strong>壬辰年癸卯月庚辰日</strong>，那可以用<a href="https://github.com/autopear/LunarCalendar">LunarCalendar</a>。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSCalendar *chineseCalendar = [[NSCalendar alloc] initWithCalendarIdentifier:NSCalendarIdentifierChinese];
</span><span class='line'>
</span><span class='line'>NSDateFormatter *dateFormatter = [NSDateFormatter new];
</span><span class='line'>dateFormatter.locale = [NSLocale localeWithLocaleIdentifier:@"zh_Hans_CN"];
</span><span class='line'>dateFormatter.dateStyle = NSDateFormatterFullStyle;
</span><span class='line'>dateFormatter.calendar = chineseCalendar;
</span><span class='line'>
</span><span class='line'>NSLog(@"%@", [dateFormatter stringFromDate:[NSDate date]]);
</span><span class='line'>
</span><span class='line'>// Output:2016丙申年五月十七星期二</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="https://www.quora.com/What-does-Apple-mean-when-it-says-iOS-8-will-include-lunar-calendar-support">https://www.quora.com/What-does-Apple-mean-when-it-says-iOS-8-will-include-lunar-calendar-support</a>
<a href="http://stackoverflow.com/questions/27878696/nscalendaridentifierrepublicofchina-vs-nscalendaridentifierchinese">http://stackoverflow.com/questions/27878696/nscalendaridentifierrepublicofchina-vs-nscalendaridentifierchinese</a></p>

<h3>15. How to fix tableView&rsquo;s tableHeaderView overlap first cell?</h3>

<p>A: The core of solution is when you change the frame of tableHeaderView, you need reassign it to tableView.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UIView *headerView = self.tableHeaderView;
</span><span class='line'>
</span><span class='line'>[headerView setNeedsLayout];
</span><span class='line'>[headerView layoutIfNeeded];
</span><span class='line'>CGFloat height = [headerView systemLayoutSizeFittingSize:UILayoutFittingCompressedSize].height;
</span><span class='line'>
</span><span class='line'>headerView.frame = ({
</span><span class='line'>    CGRect headerFrame = headerView.frame;
</span><span class='line'>    headerFrame.size.height = height;
</span><span class='line'>    headerFrame;
</span><span class='line'>});
</span><span class='line'>
</span><span class='line'>self.tableHeaderView = headerView;</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/28782319/tableheaderview-on-top-of-first-cell">http://stackoverflow.com/questions/28782319/tableheaderview-on-top-of-first-cell</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS App 开发问题汇总（六）]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-development-problems-part-6.html"/>
    <updated>2016-03-28T20:14:53+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-development-problems-part-6</id>
    <content type="html"><![CDATA[<h3>1. The data couldn’t be read because it isn’t in the correct format.</h3>

<p>A:项目是2014年开发的，打包导出 Ad-hoc 时报上面的错误，Build Setting > Enable Bitcode > NO 之后再试成功了。</p>

<p>Reference:<a href="http://stackoverflow.com/questions/33995769/ipatool-fails-to-build-with-bitcode-xcode-7-1-1">http://stackoverflow.com/questions/33995769/ipatool-fails-to-build-with-bitcode-xcode-7-1-1</a></p>

<h3>2.setNeedsLayout vs. setNeedsUpdateConstraints and layoutIfNeeded vs updateConstraintsIfNeeded</h3>

<p>A:</p>

<ul>
<li>If you manipulated constraints directly, call setNeedsLayout.</li>
<li>If you changed some conditions (like offsets or smth) which would change constraints in your overridden updateConstraints method (a recommended way to change constraints, btw), call setNeedsUpdateConstraints, and most of the time, setNeedsLayout after that.</li>
<li>If you need any of the actions above to have immediate effect—e.g. when your need to learn new frame height after a layout pass—append it with a layoutIfNeeded.</li>
</ul>


<p>Reference:<a href="http://stackoverflow.com/questions/20609206/setneedslayout-vs-setneedsupdateconstraints-and-layoutifneeded-vs-updateconstra">http://stackoverflow.com/questions/20609206/setneedslayout-vs-setneedsupdateconstraints-and-layoutifneeded-vs-updateconstra</a></p>

<h3>3.父类如何关联子类通过nib初始化的属性？</h3>

<p>A: Select xib > Show Utilities > Show The Connection In Inspector > + > Connect to View</p>

<!-- more -->


<h3>4. Failed to load test bundle from file</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Failed to load test bundle from file:///Users/dongmeiliang/Library/Developer/Xcode/DerivedData/JSQMessages-axyqhmblkssajpgcyzizcquhltft/Build/Products/Debug-iphonesimulator/JSQMessages.app/PlugIns/JSQMessagesTests.xctest/../JSQMessagesTests.xctest/: Error Domain=NSCocoaErrorDomain Code=4 "The bundle “$(PRODUCT_NAME)” couldn’t be loaded because its executable couldn’t be located." UserInfo={NSLocalizedFailureReason=The bundle’s executable couldn’t be located., NSLocalizedRecoverySuggestion=Try reinstalling the bundle., NSBundlePath=/Users/dongmeiliang/Library/Developer/Xcode/DerivedData/JSQMessages-axyqhmblkssajpgcyzizcquhltft/Build/Products/Debug-iphonesimulator/JSQMessages.app/PlugIns/JSQMessagesTests.xctest, NSLocalizedDescription=The bundle “$(PRODUCT_NAME)” couldn’t be loaded because its executable couldn’t be located.}</span></code></pre></td></tr></table></div></figure>


<p>A:Tests target > info.plist > delete the row <code>Bundle name $(PRODUCT_NAME)</code>;</p>

<h3>5. pathForResource:ofType:inDirectory:方法有时找不到图片？</h3>

<p>A:原因是这个方法必须要指定完整的名字，比如图片的名称为fail_indicator@2x.png，放在JSQMessagesAssets.bundle的images目录下，那可以用如下代码来获取这张图片：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSBundle *)jsq_messagesBundle
</span><span class='line'>{
</span><span class='line'>    return [NSBundle bundleForClass:[JSQMessagesViewController class]];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>+ (NSBundle *)jsq_messagesAssetBundle
</span><span class='line'>{
</span><span class='line'>    NSString *bundleResourcePath = [NSBundle jsq_messagesBundle].resourcePath;
</span><span class='line'>    NSString *assetPath = [bundleResourcePath stringByAppendingPathComponent:@"JSQMessagesAssets.bundle"];
</span><span class='line'>    return [NSBundle bundleWithPath:assetPath];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>+ (UIImage *)jsq_imageFromMessagesAssetBundleWithName:(NSString *)name
</span><span class='line'>{
</span><span class='line'>    NSBundle *bundle = [NSBundle jsq_messagesAssetBundle];
</span><span class='line'>    NSString *path = [bundle pathForResource:name ofType:@"png" inDirectory:@"Images"];
</span><span class='line'>    return [UIImage imageWithContentsOfFile:path];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>[UIImage jsq_imageFromMessagesAssetBundleWithName:@"fail_indicator@2x"];</span></code></pre></td></tr></table></div></figure>


<h3>6.自动布局的视图加上遮罩不生效而且视图上UIImageView的图片也不显示了,具体方法如下：</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)jsq_maskView:(UIView *)view withImage:(UIImage *)image
</span><span class='line'>{
</span><span class='line'>    NSParameterAssert(view != nil);
</span><span class='line'>    NSParameterAssert(image != nil);
</span><span class='line'>    
</span><span class='line'>    UIImageView *imageViewMask = [[UIImageView alloc] initWithImage:image];
</span><span class='line'>    imageViewMask.frame = CGRectInset(view.frame, 2.0f, 2.0f);
</span><span class='line'>    
</span><span class='line'>    view.layer.mask = imageViewMask.layer;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>A:先设置视图的frame。</p>

<h3>7. 设置视图的frame后，视图最终的坐标和设置的坐标不一致</h3>

<p>A:问题的原因是将translatesAutoresizingMaskIntoConstraints设置NO，然后再去设置视图的坐标，这样修改的坐标不会生效，解决办法就是使用坐标是不要将translatesAutoresizingMaskIntoConstraints设置为NO.</p>

<h3>8.设置视图遮罩时，遮罩以宿主视图的origin为原点，所以当宿主视图的origin不是(0, 0)时，设置遮罩的frame时要考虑将宿主视图的origin设置为(0, 0)之后再进行伸缩，最终得到遮罩的frame。</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)jsq_maskView:(UIView *)view withImage:(UIImage *)image
</span><span class='line'>{
</span><span class='line'>    NSParameterAssert(view != nil);
</span><span class='line'>    NSParameterAssert(image != nil);
</span><span class='line'>    
</span><span class='line'>    CGRect baseFrameForMask = view.frame;
</span><span class='line'>    baseFrameForMask.origin = CGPointZero;
</span><span class='line'>    
</span><span class='line'>    UIImageView *imageViewMask = [[UIImageView alloc] initWithImage:image];
</span><span class='line'>    imageViewMask.frame = CGRectInset(baseFrameForMask, 2.0f, 2.0f);
</span><span class='line'>
</span><span class='line'>    view.layer.mask = imageViewMask.layer;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>9.先调用方法二，然后调用方法一，最终的得到图片并没有水平翻转。</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1.
</span><span class='line'>- (UIImage *)jsq_imageMaskedWithColor:(UIColor *)maskColor
</span><span class='line'>{
</span><span class='line'>    NSParameterAssert(maskColor != nil);
</span><span class='line'>    
</span><span class='line'>    CGRect imageRect = CGRectMake(0.0f, 0.0f, self.size.width, self.size.height);
</span><span class='line'>    UIImage *newImage = nil;
</span><span class='line'>    
</span><span class='line'>    UIGraphicsBeginImageContextWithOptions(imageRect.size, NO, self.scale);
</span><span class='line'>    {
</span><span class='line'>        CGContextRef context = UIGraphicsGetCurrentContext();
</span><span class='line'>        
</span><span class='line'>        CGContextScaleCTM(context, 1.0f, -1.0f);
</span><span class='line'>        CGContextTranslateCTM(context, 0.0f, -(imageRect.size.height));
</span><span class='line'>        
</span><span class='line'>        CGContextClipToMask(context, imageRect, self.CGImage);
</span><span class='line'>        CGContextSetFillColorWithColor(context, maskColor.CGColor);
</span><span class='line'>        CGContextFillRect(context, imageRect);
</span><span class='line'>        
</span><span class='line'>        newImage = UIGraphicsGetImageFromCurrentImageContext();
</span><span class='line'>    }
</span><span class='line'>    UIGraphicsEndImageContext();
</span><span class='line'>    
</span><span class='line'>    return newImage;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// 2.
</span><span class='line'>+ (UIImage *)imageWithCGImage:(CGImageRef)imageRef
</span><span class='line'>                        scale:(CGFloat)scale
</span><span class='line'>                  orientation:(UIImageOrientation)orientation</span></code></pre></td></tr></table></div></figure>


<p>Code Listing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UIImage *originImage = /* Get origin image*/
</span><span class='line'>
</span><span class='line'>UIImage *upMirroredImage = [UIImage imageWithCGImage:originImage.CGImage scale:originImage.scale orientation:UIImageOrientationUpMirrored];
</span><span class='line'>
</span><span class='line'>UIImage *upMirroredImageWithMaskedColor = [upMirroredImage jsq_imageMaskedWithColor:[UIColor grayColor]];</span></code></pre></td></tr></table></div></figure>


<p>A:调试中发现<code>+ (UIImage *)imageWithCGImage:(CGImageRef)imageRef scale:(CGFloat)scale orientation:(UIImageOrientation)orientation</code> 方法应该没有直接操作图片，而是更改了图片的metadata, 然后<code>- (UIImage *)jsq_imageMaskedWithColor:(UIColor *)maskColor</code>是直接操作图片时没有考虑图片的metadata,于是最终得到是原图加上指定颜色遮罩的图片。</p>

<h3>10. How to determine if an NSDate is today(Prior iOS 8)?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSDate *today = nil;
</span><span class='line'>NSDate *beginningOfOtherDate = nil;
</span><span class='line'>
</span><span class='line'>NSDate *now = [NSDate date];
</span><span class='line'>[[NSCalendar currentCalendar] rangeOfUnit:NSDayCalendarUnit startDate:&today interval:NULL forDate:now];
</span><span class='line'>[[NSCalendar currentCalendar] rangeOfUnit:NSDayCalendarUnit startDate:&beginningOfOtherDate interval:NULL forDate:otherDate];
</span><span class='line'>
</span><span class='line'>if([today compare:beginningOfOtherDate] == NSOrderedSame) {
</span><span class='line'>    //otherDate is a date in the current day
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/2331129/how-to-determine-if-an-nsdate-is-today">http://stackoverflow.com/questions/2331129/how-to-determine-if-an-nsdate-is-today</a></p>

<h3>11. How do you resize an image?</h3>

<p>A:</p>

<ul>
<li>UIKit, Core Graphics, and Image I/O all perform well for scaling operations on most images.</li>
<li>Core Image is outperformed for image scaling operations. In fact, it is specifically recommended in the Performance Best Practices section of the Core Image Programming Guide to use Core Graphics or Image I/O functions to crop or downsample images beforehand.</li>
<li>For general image scaling without any additional functionality, UIGraphicsBeginImageContextWithOptions is probably the best option.</li>
<li>If image quality is a consideration, consider using CGBitmapContextCreate in combination with CGContextSetInterpolationQuality.</li>
<li>When scaling images with the intent purpose of displaying thumbnails, CGImageSourceCreateThumbnailAtIndex offers a compelling solution for both rendering and caching.</li>
<li>Unless you’re already working with vImage, the extra work to use the low-level Accelerate framework for resizing doesn’t pay off.</li>
</ul>


<p>Reference:<a href="http://nshipster.com/image-resizing/">http://nshipster.com/image-resizing/</a></p>

<h3>12. How can I deal with this warning: hash mismatch?</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>warning: hash mismatch: this object file was built against a different version of the module /Users/dongmeiliang/Library/Developer/Xcode/DerivedData/ModuleCache/1ZNHC044GWHJS/SystemConfiguration-1U17T3939DDG.pcm
</span></code></pre></td></tr></table></div></figure>


<p>A:Clean > Build
Reference:<a href="http://stackoverflow.com/questions/36467348/how-can-i-deal-with-this-warning-hash-mismatch">http://stackoverflow.com/questions/36467348/how-can-i-deal-with-this-warning-hash-mismatch</a></p>

<h3>13. Cocoa Coding Style Enforcement</h3>

<p>A:<a href="http://emlyn.net/posts/cocoa-coding-style-enforcement/">http://emlyn.net/posts/cocoa-coding-style-enforcement/</a></p>

<h3>14. Importing Swift into Objective-C Within the Same App Target</h3>

<p>A:</p>

<blockquote><p>When you import Swift code into Objective-C, you rely on an Xcode-generated header file to expose those files to Objective-C. This automatically generated file is an Objective-C header that declares the Swift interfaces in your target. It can be thought of as an umbrella header for your Swift code. The name of this header is your product module name followed by adding &ldquo;-Swift.h&rdquo;. (You’ll learn more about the product module name later, in Naming Your Product Module.)</p></blockquote>

<p>在同一个 App Target 中， 导入 Swift 到 Objective-C 只需要 <code>#import "ProductModuleName-Swift.h"</code>, 需要注意 ProductModuleName-Swift.h 是 Xcode 生成的文件，所以在工程中看不到，只需要在用到 Swift 的 Objective-C 文件中引用这个文件就好了。</p>

<p>Reference:<a href="https://developer.apple.com/library/ios/documentation/Swift/Conceptual/BuildingCocoaApps/MixandMatch.html#//apple_ref/doc/uid/TP40014216-CH10-ID138">https://developer.apple.com/library/ios/documentation/Swift/Conceptual/BuildingCocoaApps/MixandMatch.html#//apple_ref/doc/uid/TP40014216-CH10-ID138</a></p>

<h3>15. Swift 中对应 Objectie-C 中的class 类方法</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tableView.registerClass(UITableViewCell.self, forCellReuseIdentifier: cellIdentifier)</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Notes Of Using Debian]]></title>
    <link href="http://DamianSheldon.github.io/blog/notes-of-using-debian.html"/>
    <updated>2016-02-29T21:46:20+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/notes-of-using-debian</id>
    <content type="html"><![CDATA[<h3>1. Install pear on Debian</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://pear.php.net/go-pear.phar
</span><span class='line'>$ sudo php go-pear.phar
</span><span class='line'>
</span><span class='line'>Below is a suggested file layout for your new PEAR installation.  To
</span><span class='line'>change individual locations, type the number in front of the
</span><span class='line'>directory.  Type 'all' to change all of them or simply press Enter to
</span><span class='line'>accept these locations.
</span><span class='line'>
</span><span class='line'> 1. Installation base ($prefix)                   : /home/meiliang/pear
</span><span class='line'> 2. Temporary directory for processing            : /tmp/pear/install
</span><span class='line'> 3. Temporary directory for downloads             : /tmp/pear/install
</span><span class='line'> 4. Binaries directory                            : /home/meiliang/pear/bin
</span><span class='line'> 5. PHP code directory ($php_dir)                 : /home/meiliang/pear/share/pear
</span><span class='line'> 6. Documentation directory                       : /home/meiliang/pear/docs
</span><span class='line'> 7. Data directory                                : /home/meiliang/pear/data
</span><span class='line'> 8. User-modifiable configuration files directory : /home/meiliang/pear/cfg
</span><span class='line'> 9. Public Web Files directory                    : /home/meiliang/pear/www
</span><span class='line'>10. System manual pages directory                 : /home/meiliang/pear/man
</span><span class='line'>11. Tests directory                               : /home/meiliang/pear/tests
</span><span class='line'>12. Name of configuration file                    : /home/meiliang/.pearrc
</span><span class='line'>
</span><span class='line'>1-12, 'all' or Enter to continue: 1
</span><span class='line'>(Use $prefix as a shortcut for '/home/meiliang/pear', etc.)
</span><span class='line'>Installation base ($prefix) [/home/meiliang/pear] : /usr/local/bin/pear
</span><span class='line'>
</span><span class='line'>$ vim .bashrc
</span><span class='line'># Append the /usr/local/bin/pear directory in the user's home directory onto the PATH environment variable
</span><span class='line'>export PATH=$PATH:/usr/local/bin/pear/bin
</span><span class='line'>
</span><span class='line'>// Reload bash configure file
</span><span class='line'>$ source .bashrc
</span><span class='line'>
</span><span class='line'>$ echo $PATH
</span><span class='line'>/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/local/bin/pear/bin
</span><span class='line'>
</span><span class='line'>// Check wether it works
</span><span class='line'>$ pear version
</span><span class='line'>PEAR Version: 1.10.1
</span><span class='line'>PHP Version: 5.6.17-0+deb8u1
</span><span class='line'>Zend Engine Version: 2.6.0
</span><span class='line'>Running on: Linux Debian 3.16.0-4-amd64 #1 SMP Debian 3.16.7-ckt11-1 (2015-05-24) x86_64</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h3>2. Install PHP GD extension on Debian</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo aptitude install php5-gd
</span><span class='line'>
</span><span class='line'>// How do I verify that php5-gd support loaded or not?
</span><span class='line'>// Type the following command at a shell prompt:
</span><span class='line'>$ php5 -m | grep -i gd
</span><span class='line'>
</span><span class='line'>Sample outputs:
</span><span class='line'>
</span><span class='line'>gd</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://www.cyberciti.biz/faq/ubuntu-linux-install-or-add-php-gd-support-to-apache/">http://www.cyberciti.biz/faq/ubuntu-linux-install-or-add-php-gd-support-to-apache/</a></p>

<h3>3. Install PHP cURL extension on Debian</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo aptitude install php5-curl</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/20073676/how-do-i-install-php-curl-on-linux-debian">http://stackoverflow.com/questions/20073676/how-do-i-install-php-curl-on-linux-debian</a></p>

<h3>4. Install PHP mCrypt extension on Debian</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aptitude search mCrypt
</span><span class='line'>p   libmcrypt-dev                                                                    - De-/Encryption Library development files
</span><span class='line'>p   libmcrypt4                                                                       - De-/Encryption Library
</span><span class='line'>p   libtomcrypt-dev                                                                  - static library, header files and documentation for libtomcrypt
</span><span class='line'>p   libtomcrypt0                                                                     - public domain open source cryptographic toolkit
</span><span class='line'>p   mcrypt                                                                           - Replacement for old unix crypt(1)
</span><span class='line'>p   php5-mcrypt                                                                      - MCrypt module for php5
</span><span class='line'>
</span><span class='line'>$ sudo aptitude install php5-mcrypt
</span><span class='line'>$ sudo service apache2 restart</span></code></pre></td></tr></table></div></figure>


<h3>5. Default installation layouts for Apache HTTPD on Debian</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ServerRoot              ::      /etc/apache2
</span><span class='line'>DocumentRoot            ::      /var/www
</span><span class='line'>Apache Config Files     ::      /etc/apache2/apache2.conf
</span><span class='line'>                        ::      /etc/apache2/ports.conf
</span><span class='line'>Default VHost Config    ::      /etc/apache2/sites-available/default, /etc/apache2/sites-enabled/000-default
</span><span class='line'>Module Locations        ::      /etc/apache2/mods-available, /etc/apache2/mods-enabled
</span><span class='line'>ErrorLog                ::      /var/log/apache2/error.log
</span><span class='line'>AccessLog               ::      /var/log/apache2/access.log
</span><span class='line'>cgi-bin                 ::      /usr/lib/cgi-bin
</span><span class='line'>binaries (apachectl)    ::      /usr/sbin
</span><span class='line'>start/stop              ::      /etc/init.d/apache2 (start|stop|restart|reload|force-reload|start-htcacheclean|stop-htcacheclean)</span></code></pre></td></tr></table></div></figure>


<p>Notes:</p>

<ol>
<li>The Debian/Ubuntu layout is fully documented in /usr/share/doc/apache2/README.Debian</li>
<li>Debian/Ubuntu use symlinks to configure vhosts and load modules. Configuration files are created in their respective sites-available and mods-available directories. To activate vhosts and modules, symlinks are created in the respective sites-enabled and mods-enabled directories to the config files in either sites-available and mods-available. Debian provides scripts to handle this process called &lsquo;a2ensite&rsquo; and &lsquo;a2enmod&rsquo; which activates vhosts and modules.</li>
<li>The default vhost is defined in /etc/apache2/sites-available/default, and overrides the DocumentRoot set in the server context.</li>
</ol>


<p>Reference:<a href="http://wiki.apache.org/httpd/DistrosDefaultLayout#Debian.2C_Ubuntu_.28Apache_httpd_2.x.29:">http://wiki.apache.org/httpd/DistrosDefaultLayout#Debian.2C_Ubuntu_.28Apache_httpd_2.x.29:</a></p>

<h3>6. Can&rsquo;t connect to PPTP VPN with ufw enabled on Debian 3.16.7-ckt11-1 with kernel 3.16.0-4-amd64</h3>

<p>A: Allow Port 1723 on UFW</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ufw allow 1723</span></code></pre></td></tr></table></div></figure>


<p>This is caused by a change for security reason in kernel 3.18 [1]. There are two ways to fix this.</p>

<p>First approach is adding this rule to the file /etc/ufw/before.rules before the line # drop INVALID packets &hellip;</p>

<p>-A ufw-before-input -p 47 -j ACCEPT
Second approach is manually loading the nf_conntrack_pptp module. You can do this by running</p>

<p>sudo modprobe nf_conntrack_pptp
To load this module on every boot on Ubuntu, add it to the file /etc/modules.</p>

<p>Reference:<a href="http://askubuntu.com/questions/572497/cant-connect-to-pptp-vpn-with-ufw-enabled-on-ubuntu-14-04-with-kernel-3-18">http://askubuntu.com/questions/572497/cant-connect-to-pptp-vpn-with-ufw-enabled-on-ubuntu-14-04-with-kernel-3-18</a></p>

<p><a href="http://silverlinux.blogspot.com/2012/05/how-to-pptp-vpn-on-ubuntu-1204-pptpd.html">http://silverlinux.blogspot.com/2012/05/how-to-pptp-vpn-on-ubuntu-1204-pptpd.html</a></p>

<h2>7.OpenVPN server configure correct, but client can&rsquo;t brower web site block by GTW.</h2>

<p>A:There is a crue the the log of VPN client issue client DNS be used. So I think this may be the problem. YES, client can brower all web site after remove all client DNS settings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.8.1
</span><span class='line'>202.103.96.112
</span><span class='line'>8.8.8.8
</span><span class='line'>208.67.222.222
</span><span class='line'>208.67.220.220</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-debian-8">https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-debian-8</a>
<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-14-04#step-5---installing-the-client-profile">https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-14-04#step-5---installing-the-client-profile</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS Technical Interview Part 3]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-technical-interview-part-3.html"/>
    <updated>2016-02-25T18:43:44+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-technical-interview-part-3</id>
    <content type="html"><![CDATA[<h3>1.Difference between categories and extensions?</h3>

<p>A:There are two difference beween categories and extensions:</p>

<ol>
<li>The extension has no name;</li>
<li>The implementation of the extension must be in the main @implementation block of the file.</li>
</ol>


<p>Reference:<a href="http://stackoverflow.com/questions/3499704/difference-between-category-and-class-extension">http://stackoverflow.com/questions/3499704/difference-between-category-and-class-extension</a></p>

<h3>2.What is advantage of category?</h3>

<p>A:</p>

<ul>
<li>You can add method to existing class even to that class whose source is not available to you.</li>
<li>You can extend functionality of a class without subclassing.</li>
<li>You can split implementation in multiple classes.</li>
</ul>


<p>Reference:<a href="http://psri13.blogspot.com/2014/07/what-is-advantage-of-categories-what-is.html">http://psri13.blogspot.com/2014/07/what-is-advantage-of-categories-what-is.html</a></p>

<h3>3.What are KVO and KVC?</h3>

<p>A:</p>

<blockquote><p>Key-value observing is a mechanism that enables an object to be notified directly when a property of another object changes.
Key-value coding is a mechanism for indirectly accessing an object’s attributes and relationships using string identifiers.</p></blockquote>

<p>Reference:Cocoa Core Competencies</p>

<!-- more -->


<h3>4.Difference between shallow copy and deep copy?</h3>

<p>A:
The difference between shallow and deep copying is only relevant for compound objects (objects that contain other objects, like lists or class instances):</p>

<p>A shallow copy constructs a new compound object and then (to the extent possible) inserts references into it to the objects found in the original.
A deep copy constructs a new compound object and then, recursively, inserts copies into it of the objects found in the original.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/17246693/what-exactly-is-the-difference-between-shallow-copy-deepcopy-and-normal-assignm">http://stackoverflow.com/questions/17246693/what-exactly-is-the-difference-between-shallow-copy-deepcopy-and-normal-assignm</a></p>

<h3>5.When retain count increase?</h3>

<p>A:</p>

<ul>
<li>When you create an object;</li>
<li>When you send an object retain message;</li>
</ul>


<p>Reference:<a href="http://stackoverflow.com/questions/4254346/conditions-in-which-retaincount-increases-or-decreases">http://stackoverflow.com/questions/4254346/conditions-in-which-retaincount-increases-or-decreases</a></p>

<h3>6.If we don’t create any autorelease pool in our application then is there any autorelease pool already provided to us?</h3>

<p>A: Yes, there is a autorelease pool already provided to us.</p>

<h3>7.When you will create an autorelease pool in your application?</h3>

<p>A:There are three occasions when you might use your own autorelease pool blocks:</p>

<ul>
<li>If you are writing a program that is not based on a UI framework, such as a command-line tool.</li>
<li><p>If you write a loop that creates many temporary objects.
You may use an autorelease pool block inside the loop to dispose of those objects   before the next iteration. Using an autorelease pool block in the loop helps to  reduce the maximum memory footprint of the application.</p></li>
<li><p>If you spawn a secondary thread.
You must create your own autorelease pool block as soon as the thread begins executing; otherwise, your application will leak objects.</p></li>
</ul>


<h3>8.How many autorelease pool you can create in your application? Is there any limit?</h3>

<p>A: You can create autorelease pool as much as possible, there is no limit.</p>

<h3>9.What is purpose of delegates?</h3>

<p>A:Delegation is a simple and powerful pattern in which one object in a program acts on behalf of, or in coordination with, another object.</p>

<h3>10.What is difference between NSNotification and protocol?</h3>

<p>A:</p>

<ul>
<li>Protocol is To-one Relationships; NSNotification is To-many Relationships.</li>
<li>Protocol support bidirectional data-transfer between two classes.</li>
</ul>


<h3>11.Polymorphism？</h3>

<p>A: The ability of different objects to respond, each in its own way, to identical messages is called polymorphism.</p>

<h3>12.Singleton?</h3>

<p>A:A singleton class returns the same instance no matter how many times an application requests it.</p>

<h3>13.Give us example of what are delegate methods and what are data source methods of UITableView?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Delegate methods
</span><span class='line'>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions;
</span><span class='line'>- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex;
</span><span class='line'>- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex;
</span><span class='line'>
</span><span class='line'> // Data source methods
</span><span class='line'> - (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView;
</span><span class='line'> - (NSInteger)tableView:(UITalbleView *)tableView numberOfRowsInSections:(NSInteger)section;
</span><span class='line'> - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath;
</span></code></pre></td></tr></table></div></figure>


<h3>14.What are mutable and immutable types in Objective C?</h3>

<p>A:A mutable object can be mutated or changed. An immutable object cannot.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/7071096/what-is-difference-between-mutable-and-immutable">http://stackoverflow.com/questions/7071096/what-is-difference-between-mutable-and-immutable</a></p>

<h3>15.When to use NSMutableArray and when to use NSArray?</h3>

<p>A:When collection will mutable you should use NSMutableArray, otherwise use NSArray.</p>

<h3>16.What is convenience constructor?</h3>

<p>A:A convenience constructor is one that performs object allocation &amp; initialization in one step &amp; returns an autoreleased object to the caller.</p>

<p>Reference:<a href="https://www.quora.com/Objective-C-programming-language/What-is-a-convenience-constructor">https://www.quora.com/Objective-C-programming-language/What-is-a-convenience-constructor</a></p>

<h3>17.What is responder chain?</h3>

<p>A:The responder chain is a series of linked responder objects.</p>

<h3>18.What is push notification?</h3>

<p>A:Apple Push Notification service (APNs for short) is the centerpiece of the remote notifications feature. It is a robust and highly efficient service for propagating information to iOS and OS X devices. Each device establishes an accredited and encrypted IP connection with the service and receives notifications over this persistent connection. If a notification for an app arrives when that app is not running, the device alerts the user that the app has data waiting for it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS Technical Interview Part 2]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-technical-interview-part-2.html"/>
    <updated>2016-02-25T16:54:55+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-technical-interview-part-2</id>
    <content type="html"><![CDATA[<ol>
<li><p>@property中有哪些属性关键字？/ @property 后面可以有哪些修饰符？<br/>
 A:</p>

<ul>
<li>Write Serialization(not general thread safety): nonatomic atomic (default)</li>
<li>Mutability: readonly readwrite (default)</li>
<li>API Contron :getter = methodname setter = mehtodname:</li>
<li>Memory Management: copy strong (default) weak unsafe_unretained assign</li>
</ul>
</li>
<li><p>ARC下，不显式指定任何属性关键字时，默认的关键字都有哪些？<br/>
 A:</p>

<ul>
<li>Write Serialization: atomic</li>
<li>Mutability: readwrite</li>
<li>Memory Management: assign(non-object) strong(object)</li>
</ul>
</li>
<li><p>什么情况使用 weak 关键字，相比 assign 有什么不同？<br/>
 A:
 什么情况使用 weak 关键字？</p>

<ul>
<li>强引用关系的对象会发生循环引用时用weak关键字；</li>
<li>已经被强引用的对象，如Interface Builder创建的视图被声明为weak。</li>
</ul>


<p> weak 相比 assign 有什么不同？</p>

<ul>
<li>weak 必须修饰对象，assign还可以修饰非对象；</li>
<li>weak 修饰的属性所指向的对象销毁后，该属性会被置为nil，而assign修改的属性所指向的对象销毁后，属性仍然指向对象分配的内存地址成为野指针。</li>
</ul>
</li>
</ol>


<!-- more -->


<ol>
<li><p>weak属性需要在dealloc中置nil么？<br/>
 A: 不需要，因为 weak 属性不影响对象的引用计数。</p></li>
<li><p>用@property声明的NSString（或NSArray，NSDictionary）经常使用copy关键字，为什么？如果改用strong关键字，可能造成什么问题？</p>

<ul>
<li>对非集合类对象的copy操作</li>
<li>集合类对象的copy与mutableCopy</li>
</ul>


<p> A:
 为什么？
 因为父类指针可以指向子类对象,而使用 copy 可以让本对象的属性不受外界影响,无论给我传入是一个可变对象还是不可对象,我本身持有的就是一个不可变的副本.</p>

<p> 如果改用strong关键字，可能造成什么问题？
 如果我们使用是 strong ,那么这个属性就有可能指向一个可变对象,如果这个可变对象在外部被修改了,那么会影响该属性.</p>

<p> 非集合类对象的copy与mutableCopy：
 对 immutable 对象进行 copy 操作，是指针复制，mutableCopy 操作时内容复制；对 mutable 对象进行 copy 和 mutableCopy 都是内容复制。用代码简单表示如下：</p>

<pre><code class="`"> [immutableObject copy] // 浅复制
 [immutableObject mutableCopy] //深复制
 [mutableObject copy] //深复制
 [mutableObject mutableCopy] //深复制
</code></pre>

<p> 实例验证：</p>

<pre><code class="`"> NSMutableString *string = [NSMutableString stringWithString:@"origin"];//copy
 NSString *stringCopy = [string copy];

 // 查看内存，会发现 string、stringCopy 内存地址都不一样，说明此时都是做内容拷贝、深拷贝。即使你进行如下操作：
 [string appendString:@"origion!"]

 // stringCopy 的值也不会因此改变，但是如果不使用 copy，stringCopy 的值就会被改变。
</code></pre>

<p> 集合类对象的copy与mutableCopy:
 对 immutable 对象进行 copy，是指针复制， mutableCopy 是内容复制；对 mutable 对象进行 copy 和 mutableCopy 都是内容复制。但是：集合对象的内容复制仅限于对象本身，对象元素仍然是指针复制。用代码简单表示如下：</p>

<pre><code class="`"> [immutableObject copy] // 浅复制
 [immutableObject mutableCopy] //单层深复制
 [mutableObject copy] //单层深复制
 [mutableObject mutableCopy] //单层深复制
</code></pre>

<p> 实例验证：</p>

<pre><code class="`"> // 下面先看集合类immutable对象使用 copy 和 mutableCopy 的一个例子：
 NSArray *array = @[@[@"a", @"b"], @[@"c", @"d"]];
 NSArray *copyArray = [array copy];
 NSMutableArray *mCopyArray = [array mutableCopy];
 // 查看内容，可以看到 copyArray 和 array 的地址是一样的，而 mCopyArray 和 array 的地址   是不同的。说明 copy 操作进行了指针拷贝，mutableCopy 进行了内容拷贝。但需要强调的是：此处的内   容拷贝，仅仅是拷贝 array 这个对象，array 集合内部的元素仍然是指针拷贝。这和上面的非集合    immutable 对象的拷贝还是挺相似的，那么mutable对象的拷贝会不会类似呢？我们继续往下，看     mutable 对象拷贝的例子：

 NSMutableArray *array = [NSMutableArray arrayWithObjects:[NSMutableString   stringWithString:@"a"],@"b",@"c",nil];
 NSArray *copyArray = [array copy];
 NSMutableArray *mCopyArray = [array mutableCopy];

 // 查看内存，如我们所料，copyArray、mCopyArray和 array 的内存地址都不一样，说明    copyArray、mCopyArray 都对 array 进行了内容拷贝。
</code></pre></li>
<li><p>这个写法会出什么问题： @property (copy) NSMutableArray *array?<br/>
 A:问题一：由于属性声明为 copy, 所以它最终指向的是一个 NSArray，对它调用 NSMutableArray 中定义的方法会导致应用奔溃；
 问题二：如果是开发 iOS 程序，这会影响性能。</p></li>
<li><p>怎么用 copy 关键字？<br/>
 A:声明为属性的类遵守 NSCopying 协议，而且我们希望设置新值时保存一份自己的拷贝。</p></li>
<li><p>如何让自己的类用 copy 修饰符？如何重写带 copy 关键字的 setter？<br/>
 A:</p>

<blockquote><p>Any object that you wish to set for a copy property must support NSCopying, which means that it should conform to the NSCopying protocol.
Only classes that define an “immutable vs. mutable” distinction should adopt this protocol.</p></blockquote></li>
<li><p>protocol 和 category 中如何使用 @property?<br/>
 A:</p>

<ul>
<li>protocol 使用 property 和 class 类似，只是 protocol 的 property 只会生成相应 getter 和 setter 方法声明，遵守协议的类需要实现相应的 getter 和 setter 方法；</li>
<li>category 使用 property 和 class 有点区别，主要原因是 category 不支持添加实例变量，所以 category 中可以声明组合已有类 property 的 readonly 修饰的便捷 property；或者通过关联引用来辅助实现 getter 和 setter 方法。</li>
</ul>
</li>
<li><p>@property 的本质是什么？ivar、getter、setter 是如何生成并添加到这个类中的?<br/>
A:@property 的本质是什么？
    @property = ivar + getter + setter;</p>

<p>ivar、getter、setter 是如何生成并添加到这个类中的?
“自动合成”( autosynthesis)
完成属性定义后，编译器会自动编写访问这些属性所需的方法，此过程叫做“自动合成”(autosynthesis)。需要强调的是，这个过程由编译器在编译期执行，所以编辑器里看不到这些“合成方法”(synthesized method)的源代码。除了生成方法代码 getter、setter 之外，编译器还要自动向类中添加适当类型的实例变量，并且在属性名前面加下划线，以此作为实例变量的名字。</p></li>
<li><p>@synthesize和@dynamic分别有什么作用？<br/>
A:</p>

<ul>
<li>@synthesize 是告诉编译器怎么去合成相应属性的 getter 和 setter 方法；</li>
<li>@dynamic 告诉编译器属性的 setter 与 getter 方法由用户自己实现，不自动合成。</li>
</ul>
</li>
<li><p>在有了自动合成属性实例变量之后，@synthesize还有哪些使用场景？<br/>
A:</p>

<ul>
<li>自定义自动合成的实例变量的名称；</li>
<li>自动合成协议中声明 getter 和 setter 方法。</li>
</ul>
</li>
<li><p>@synthesize合成实例变量的规则是什么？假如property名为foo，存在一个名为<em>foo的实例变量，那么还会自动合成新变量么？<br/>
A:
@synthesize合成实例变量的规则是什么？
假设声明了propertyname的属性，默认会合成</em>propertyname的实例变量，也可以自定义合成实例变量的名称，如果目标合成实例变量已经存在则不再合成。</p>

<p>假如property名为foo，存在一个名为_foo的实例变量，那么还会自动合成新变量么？
不会。</p></li>
<li><p>ARC通过什么方式帮助开发者管理内存？<br/>
A:</p>

<blockquote><p>ARC works by adding code at compile time to ensure that objects live as long as necessary, but no longer.</p></blockquote></li>
<li><p>objc使用什么机制管理对象内存？<br/>
A: 引用计数机制。</p></li>
<li><p>不手动指定autoreleasepool的前提下，一个autorealese对象在什么时刻释放？（比如在一个vc的viewDidLoad中创建）<br/>
A: Autorelease对象出了作用域之后，会被添加到最近一次创建的自动释放池中，并会在当前的 runloop 迭代结束时释放。如果在一个vc的viewDidLoad中创建一个 Autorelease对象，那么该对象会在 viewDidAppear 方法执行前就被销毁了。</p></li>
<li><p>苹果是如何实现autoreleasepool的?<br/>
A:</p></li>
<li><p>使用block时什么情况会发生引用循环，如何解决？<br/>
A:一个对象中强引用了block，在block中又使用了该对象，就会发生循环引用。
解决方法是将该对象使用<code>__weak</code>或者<code>__block</code>修饰符修饰之后再在block中使用。</p>

<ul>
<li>id weak weakSelf = self，或者 weak __typeof(self)weakSelf = self</li>
<li>id __block weakSelf = self;</li>
</ul>
</li>
<li><p>在block内如何修改block外部变量？<br/>
A:使用 _block 存储类型修饰外部变量。</p></li>
<li><p>使用系统的某些block api（如UIView的block版本写动画时），是否也考虑引用循环问题？
A:使用系统的block api要不要考虑引用循环问题取决于它会不会造成引用循环，如果不会造成引用循环则不需要考虑，反之则需要考虑。UIView的block版本写动画时不需要考虑引用循环问题。</p></li>
<li><p>IBOutlet连出来的视图属性为什么可以被设置成weak?<br/>
A:IBOutlet 连出来的视图是视图层级的组成部分，对它已经有一个强引用，所以它可以被设置为 weak。</p></li>
<li><p>IB中User Defined Runtime Attributes如何使用？<br/>
A:</p>

<blockquote><p>Add initialization of custom runtime attributes to objects that do not have a corresponding Interface Builder inspector.</p></blockquote></li>
<li><p>若一个类有实例变量 NSString *<em>foo ，调用setValue:forKey:时，可以以foo还是 </em>foo 作为key？<br/>
A:都可以。</p></li>
<li><p>KVC的keyPath中的集合运算符如何使用？<br/>
A:</p>

<ul>
<li>必须是集合对象</li>
<li>KVC支持的集合运算符</li>
<li>正确的  Operator key path 格式</li>
</ul>
</li>
<li><p>KVC和KVO的keyPath一定是属性么？<br/>
A:KVO支持实例变量。</p></li>
<li><p>addObserver:forKeyPath:options:context:各个参数的作用分别是什么，observer中需要实现哪个方法才能获得KVO回调？<br/>
A:</p>

<table>
<thead>
<tr>
<th> Parameter </th>
<th> Function </th>
</tr>
</thead>
<tbody>
<tr>
<td> anObserver </td>
<td> The object to register for KVO notifications. The observer must implement the key-value observing method observeValueForKeyPath:ofObject:change:context:. </td>
</tr>
<tr>
<td> keyPath </td>
<td> The key path, relative to the receiver, of the property to observe. This value must not be nil. </td>
</tr>
<tr>
<td> options </td>
<td> A combination of the NSKeyValueObservingOptions values that specifies what is included in observation notifications. For possible values, see NSKeyValueObservingOptions. </td>
</tr>
<tr>
<td> context </td>
<td> Arbitrary data that is passed to anObserver in observeValueForKeyPath:ofObject:change:context:. </td>
</tr>
</tbody>
</table>
</li>
</ol>


<p>observer中需要实现- observeValueForKeyPath:ofObject:change:context:才能获得KVO回调。</p>

<ol>
<li><p>如何手动触发一个value的KVO?<br/>
A:改变值之前调用 willChangeValueForKey:，改变值之后调用 didChangeValueForKey:。</p></li>
<li><p>如何关闭默认的KVO的默认实现，并进入自定义的KVO实现？<br/>
A:</p>

<ul>
<li>A class that implements manual notification must override the NSObject implementation of automaticallyNotifiesObserversForKey:.For properties that perform manual notification, the subclass implementation of automaticallyNotifiesObserversForKey: should return NO.</li>
<li>To implement manual observer notification, you invoke willChangeValueForKey: before changing the value, and didChangeValueForKey: after changing the value.</li>
</ul>
</li>
<li><p>apple用什么方式实现对一个对象的KVO？<br/>
A:</p>

<blockquote><p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p></blockquote></li>
<li><p>GCD的队列（dispatch_queue_t）分哪两种类型？<br/>
A:</p>

<ul>
<li>DISPATCH_QUEUE_SERIAL</li>
<li>DISPATCH_QUEUE_CONCURRENT</li>
</ul>
</li>
<li><p>如何用GCD同步若干个异步调用？（如根据若干个url异步加载多张图片，然后在都下载完成后合成一张整图）<br/>
A:</p>

<blockquote><p>Dispatch groups are a way to block a thread until one or more tasks finish executing.</p></blockquote>

<pre><code>    dispatch_queue_t queue =        dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    dispatch_group_t group = dispatch_group_create();
    dispatch_group_async(group, queue, ^{ /*加载图片1 */ });
    dispatch_group_async(group, queue, ^{ /*加载图片2 */ });
    dispatch_group_async(group, queue, ^{ /*加载图片3 */ }); 
    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
            // 合并图片
    });
</code></pre></li>
<li><p>dispatch_barrier_async的作用是什么？<br/>
A:</p>

<blockquote><p>Submits a barrier block for asynchronous execution and returns immediately.
A dispatch barrier allows you to create a synchronization point within a concurrent dispatch queue. When it encounters a barrier, a concurrent queue delays the execution of the barrier block (or any further blocks) until all blocks submitted before the barrier finish executing. At that point, the barrier block executes by itself. Upon completion, the queue resumes its normal execution behavior.</p></blockquote></li>
<li><p>苹果为什么要废弃dispatch_get_current_queue？<br/>
A:dispatch_get_current_queue 容易造成死锁。</p></li>
<li><p>以下代码运行结果如何？</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewDidLoad
</span><span class='line'>{
</span><span class='line'>  [super viewDidLoad];
</span><span class='line'>  NSLog(@"1");
</span><span class='line'>  dispatch_sync(dispatch_get_main_queue(), ^{
</span><span class='line'>      NSLog(@"2");
</span><span class='line'>  });
</span><span class='line'>  NSLog(@"3");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>A: 只输出：1 。发生主线程锁死。</p>

<ol>
<li><p>runloop和线程有什么关系？<br/>
A:</p>

<blockquote><p>Run loops are intended for situations where you want more interactivity with the thread.</p></blockquote>

<p>当我们和线程有很多交互时，可以为线程配置一个 RunLoop.</p>

<pre><code>- (void)networkRunLoopThreadEntry
// This thread runs all of our network operation run loop callbacks.
{
assert( ! [NSThread isMainThread] );
while (YES) {
    NSAutoreleasePool * pool;

    pool = [[NSAutoreleasePool alloc] init];
    assert(pool != nil);

    [[NSRunLoop currentRunLoop] run];

    [pool drain];
}
assert(NO);
}
</code></pre></li>
<li><p>runloop的mode作用是什么？<br/>
A:</p>

<blockquote><p>A run loop mode is a collection of input sources and timers to be monitored and a collection of run loop observers to be notified.
Each time you run your run loop, you specify (either explicitly or implicitly) a particular “mode” in which to run. During that pass of the run loop, only sources associated with that mode are monitored and allowed to deliver their events. (Similarly, only observers associated with that mode are notified of the run loop’s progress.) Sources associated with other modes hold on to any new events until subsequent passes through the loop in the appropriate mode.</p></blockquote></li>
</ol>


<p>mode的作用是设置好需要监控的 input sources 和 timers，以及需要通知的 run loop observers。</p>

<ol>
<li>以+ scheduledTimerWithTimeInterval&hellip;的方式触发的timer，在滑动页面上的列表时，timer会暂定回调，为什么？如何解决？<br/>
A:滑动页面的列表时 RunLoop 会从 NSDefaultRunLoopMode 切换到 NSEventTrackingRunLoopMode，而以+ scheduledTimerWithTimeInterval&hellip;的方式触发的timer默认是在 NSDefaultRunLoopMode 下被监控，所以会出现暂停回调。</li>
</ol>


<p>如何解决？
解决办法自然是希望 timer 触发的事件不被限制，也就是说在 NSEventTrackingRunLoopMode 下也能被监控，可以通过把 timer 加入到 NSRunLoopCommonModes 中，因为关联到它的 timer 也会被相应关联到 NSEventTrackingRunLoopMode 中。</p>

<blockquote><p>NSRunLoopCommonModes (Cocoa)
kCFRunLoopCommonModes (Core Foundation)
This is a configurable group of commonly used modes. Associating an input source with this mode also associates it with each of the modes in the group. For Cocoa applications, this set includes the default, modal, and event tracking modes by default. Core Foundation includes just the default mode initially. You can add custom modes to the set using the CFRunLoopAddCommonMode function.</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//将timer添加到NSDefaultRunLoopMode中
</span><span class='line'>[NSTimer scheduledTimerWithTimeInterval:1.0
</span><span class='line'>     target:self
</span><span class='line'>     selector:@selector(timerTick:)
</span><span class='line'>     userInfo:nil
</span><span class='line'>     repeats:YES];
</span><span class='line'>//然后再添加到NSRunLoopCommonModes里
</span><span class='line'>NSTimer *timer = [NSTimer timerWithTimeInterval:1.0
</span><span class='line'>     target:self
</span><span class='line'>     selector:@selector(timerTick:)
</span><span class='line'>     userInfo:nil
</span><span class='line'>     repeats:YES];
</span><span class='line'>[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>猜想runloop内部是如何实现的？<br/>
A:</p>

<blockquote><p>It is a loop your thread enters and uses to run event handlers in response to incoming events.</p></blockquote></li>
<li><p>runtime 如何实现 weak 属性?/runtime如何实现weak变量的自动置nil？<br/>
A:runtime 对注册的类， 会进行布局，对于 weak 对象会放入一个 hash 表中。 用 weak 指向的对象内存地址作为 key，当此对象的引用计数为0的时候会 dealloc，假如 weak 指向的对象内存地址是a，那么就会以a为键， 在这个 weak 表中搜索，找到所有以a为键的 weak 对象，从而设置为 nil。</p></li>
<li><p>objc中向一个对象发送消息[obj foo]和objc_msgSend()函数之间有什么关系？<br/>
A:</p>

<blockquote><p>In Objective-C, messages aren’t bound to method implementations until runtime.
The compiler converts a message expression,</p></blockquote></li>
</ol>


<blockquote><p>[receiver message]
into a call on a messaging function, objc_msgSend.</p></blockquote>

<p>编译器会把向一个对象发送的消息转化成一次objc_msgSend()函数调用。</p>

<ol>
<li><p>objc中向一个nil对象发送消息将会发生什么？<br/>
A:</p>

<ul>
<li>如果一个方法返回值是一个对象，那么发送给nil的消息将返回nil;</li>
<li>如果方法返回值为指针类型，其指针大小为小于或者等于sizeof(void*)，float，double，long double 或者 long long 的整型标量，发送给 nil 的消息将返回0;</li>
<li>如果方法返回值为结构体,发送给 nil 的消息将返回0。结构体中各个字段的值将都是0</li>
<li>如果方法的返回值不是上述提到的几种情况，那么发送给 nil 的消息的返回值将是未定义的</li>
</ul>
</li>
<li><p><em>objc_msgForward 函数是做什么的，直接调用它将会发生什么？<br/>
A:当向一个对象发送一条消息，但它并没有实现的时候，</em>objc_msgForward会尝试做消息转发。直接调用_objc_msgForward是非常危险的事，如果用不好会直接导致程序Crash，但是如果用得好，能做很多非常酷的事。</p></li>
<li><p>能否向编译后得到的类中增加实例变量？能否向运行时创建的类中添加实例变量？为什么？<br/>
A:</p>

<ul>
<li>不能向编译后得到的类中增加实例变量；</li>
<li>能向运行时创建的类中添加实例变量；</li>
</ul>
</li>
</ol>


<p>解释:</p>

<pre><code>* 因为编译后的类已经注册在 runtime 中，类结构体中的 objc_ivar_list 实例变量的链表 和 instance_size 实例变量的内存大小已经确定，同时runtime 会调用 class_setIvarLayout 或 class_setWeakIvarLayout 来处理 strong weak 引用。所以不能向存在的类中添加实例变量；
* 运行时创建的类是可以添加实例变量，调用 class_addIvar 函数。但是得在调用 objc_allocateClassPair 之后，objc_registerClassPair 之前，原因同上。
</code></pre>

<ol>
<li><p>一个objc对象如何进行内存布局？（考虑有父类的情况）<br/>
A:
Objective-C 对象的结构图
ISA指针
根类的实例变量
倒数第二层父类的实例变量
&hellip;
父类的实例变量
类的实例变量</p></li>
<li><p>一个objc对象的isa的指针指向什么？有什么作用？<br/>
A:</p>

<blockquote><p>The isa pointer, as the name suggests, points to the object&rsquo;s class which maintains a dispatch table.</p></blockquote></li>
</ol>


<p>指向对象的类。</p>

<ol>
<li>下面的代码输出什么？</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@implementation Son : Father
</span><span class='line'>- (id)init
</span><span class='line'>{
</span><span class='line'>    self = [super init];
</span><span class='line'>    if (self) {
</span><span class='line'>        NSLog(@"%@", NSStringFromClass([self class]));
</span><span class='line'>        NSLog(@"%@", NSStringFromClass([super class]));
</span><span class='line'>    }
</span><span class='line'>    return self;
</span><span class='line'>}
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p>A:都输出 Son.
super 是一个 Magic Keyword， 它本质是一个编译器标示符，和 self 是指向的同一个消息接受者！他们两个的不同点在于：super 会告诉编译器，调用 class 这个方法时，要去父类的方法，而不是本类里的。</p>

<ol>
<li><p>什么时候会报unrecognized selector的异常？<br/>
A:当调用该对象上某个方法,而该对象上没有实现这个方法的时候。</p></li>
<li><p>BAD_ACCESS在什么情况下出现？<br/>
A:</p>

<ul>
<li>访问了野指针，比如对一个已经释放的对象执行了release、访问已经释放对象的成员变量或者发消息。</li>
<li>死循环</li>
</ul>
</li>
<li><p>如何调试BAD_ACCESS错误?<br/>
A:</p>

<ul>
<li>Enable Zombie Objects</li>
<li>Enable Address Sanitizer</li>
<li>重写object的respondsToSelector方法，显示出现EXEC_BAD_ACCESS前访问的最后一个object</li>
</ul>
</li>
<li><p>lldb（gdb）常用的调试命令？<br/>
A:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lldb po
</span><span class='line'>lldb p
</span><span class='line'>lldb expression
</span><span class='line'>lldb bt
</span><span class='line'>lldb c</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>使用runtime Associate方法关联的对象，需要在主对象dealloc的时候释放么？<br/>
A:不需要。</p></li>
<li><p>runtime如何通过selector找到对应的IMP地址？（分别考虑类方法和实例方法）<br/>
A:每一个类对象或对象中有一个方法列表,方法列表中记录着方法的名称,方法实现,以及参数类型,其实selector本质就是方法名称,通过这个方法名称就可以在方法列表中找到对应的方法实现.</p></li>
<li><p>objc中的类方法和实例方法有什么本质区别和联系？<br/>
A:
类方法：</p></li>
</ol>


<p>类方法是属于类对象的
类方法只能通过类对象调用
类方法中的self是类对象
类方法可以调用其他的类方法
类方法中不能访问成员变量
类方法中不定直接调用对象方法</p>

<p>实例方法：</p>

<p>实例方法是属于实例对象的
实例方法只能通过实例对象调用
实例方法中的self是实例对象
实例方法中可以访问成员变量
实例方法中直接调用实例方法
实例方法中也可以调用类方法(通过类名)</p>

<p>扩展阅读：<br/>
o <a href="http://onevcat.com/2013/04/ios-interview/">上级向的十个iOS面试问题</a><br/>
o <a href="http://studentdeng.github.io/blog/2014/02/11/baidu-interview/">百度面试</a></p>

<p>Reference:<br/>
o <a href="http://blog.sunnyxx.com/2015/07/04/ios-interview/">http://blog.sunnyxx.com/2015/07/04/ios-interview/</a><br/>
o <a href="https://github.com/ChenYilong/iOSInterviewQuestions">https://github.com/ChenYilong/iOSInterviewQuestions</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Notes Of Using OpenCart]]></title>
    <link href="http://DamianSheldon.github.io/blog/notes-of-using-opencart.html"/>
    <updated>2016-02-21T17:50:35+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/notes-of-using-opencart</id>
    <content type="html"><![CDATA[<h3>1. opencart 安装中文语言包</h3>

<p>A:</p>

<ul>
<li>[下载中文语言包](<a href="http://www.opencart.cn/thread-9982-1-1.html%EF%BC%89">http://www.opencart.cn/thread-9982-1-1.html%EF%BC%89</a></li>
<li>解压压缩包，里面有两个文件夹，admin是后台语言包，catalog文件是前台语言包</li>
<li>把文件上传到对应的目录下</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/Downloads/
</span><span class='line'>$ tar -xzvf OpenCart_SimplifiedChinese_language_v2.0.3.1.zip
</span><span class='line'>$ cp -R OpenCart_SimplifiedChinese_language_v2.0.3.1/upload/catalog/language/zh-CN  ~/Sites/upload/catalog/language/
</span><span class='line'>$ cp -R OpenCart_SimplifiedChinese_language_v2.0.3.1/upload/admin/language/zh-CN ~/Sites/upload/admin/language/</span></code></pre></td></tr></table></div></figure>


<ul>
<li>System > Localisation > languages > + > Chinese(Language Name) > Code(select zh-CN) > Save</li>
<li>System > Settings > Your Store > Edit > Local > Language (Chinese) > Administration Language (Chinese) > Save</li>
</ul>


<h3>2. opencart如何增加人民币？</h3>

<p>A:</p>

<ul>
<li><p>系统设置 > 参数设置 > 货币设置 > +</p>

<ul>
<li>货币名称 人民币</li>
<li>货币代码 CNY</li>
<li>左符号 ¥</li>
<li>右符号</li>
<li>小数位 2</li>
<li>汇率 1.00000</li>
<li>状态 启用</li>
</ul>
</li>
<li><p>系统设置 > 网店设置 > 选择你的网店 > 编辑 > 本地化设置 > 货币设置 > 人民币 > 保存</p></li>
</ul>


<p>Reference:<a href="http://www.opencart-extension.com/opencart-add-renminbi.html">http://www.opencart-extension.com/opencart-add-renminbi.html</a></p>

<h3>3. 如何添加推荐商品？</h3>

<p>A: 扩展功能 > 模块配置 > 推荐商品 > Home Page > Product Name</p>

<h3>4. 如何设置幻灯片？</h3>

<p>A: 设计 > 横幅 > Home Page Slideshow > Edit</p>

<h3>5. OpenCart迁移到新的服务器后布局不正常显示</h3>

<p>A:打开Chrome的Developer Tool,报了很多Failed to load resource: <a href="http://localhost/~meiliang/upload/catalog/view/javascript/jquery/jquery-2.1.1.min.js">http://localhost/~meiliang/upload/catalog/view/javascript/jquery/jquery-2.1.1.min.js</a> net::ERR_CONNECTION_REFUSED之类的错误，所以我估计错误是 CSS 和 js 没有正确加载，于是修改public_html/upload/config.php</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define('HTTP_SERVER', 'http://ip/~meiliang/upload/');
</span><span class='line'>define('HTTPS_SERVER', 'http://ip/~meiliang/upload/');</span></code></pre></td></tr></table></div></figure>


<h3>6. 增加语言后，语言图标不显示</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp public_html/upload/image/flags/cn.png public_html/upload/catalog/language/zh-CN/zh-CN.png</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS Unit Testing With OCMock]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-unit-testing-with-ocmock.html"/>
    <updated>2016-01-22T14:19:12+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-unit-testing-with-ocmock</id>
    <content type="html"><![CDATA[<p>单元测试是我们保障代码质量的重要手段， Apple 对此也十分重视，这点可以从 Xcode 新建工程时会自动创建单元测试的 Target 看出来。单元测试牵涉的内容很多，这篇文章是目前我对单元测试的理解。</p>

<p>既然是单元测试，那么什么是单元呢？我没有去考证，但我是这么理解的：面向对象编程范式里一切皆对象，而对象是由实例变量和方法组成，对象之间通过方法互相作用，我们的应用可以看作是一个对象图，对象图上的对象相互作用来实现我们的需求。这么看来我们的单元应该是对象的方法。</p>

<p>对象的方法在工作的时候可能要依赖其他对象，为了去除依赖对象对测试的影响，我们引入 Mock.</p>

<blockquote><p>Mocks are ‘fake’ objects with pre-defined behavior to stand-in for concrete objects during testing. &ndash; HackaZach</p></blockquote>

<p>引用 Mock 之后，我们在单元测试中如何使用它呢？</p>

<blockquote><p>The general recipe for using mocks in unit-tests is:</p>

<ol>
<li>Create the mock object</li>
<li>Specify the expected invocations and return values</li>
<li>Associate the mock object with the code under test</li>
<li>Execute the code under test</li>
<li>Validate that your assertions are correct</li>
</ol>
</blockquote>

<!-- more -->


<h3>Create the mock object</h3>

<p>OCMock 中创建 Mock 对象的方法如下：</p>

<table>
<thead>
<tr>
<th> Factory Method </th>
<th> Description </th>
</tr>
</thead>
<tbody>
<tr>
<td> +mockForClass: </td>
<td> Create a mock based on the given class </td>
</tr>
<tr>
<td> +mockForProtocol: </td>
<td> Create a mock based on the given protocol </td>
</tr>
<tr>
<td> +niceMockForClass: </td>
<td> Create a &ldquo;nice&rdquo; mock based on the given class </td>
</tr>
<tr>
<td> +niceMockForProtocol: </td>
<td> Create a &ldquo;nice&rdquo; mock based on the given protocol </td>
</tr>
<tr>
<td> +partialMockForObject: </td>
<td> Create a mock based on the given object </td>
</tr>
<tr>
<td> +observerMock: </td>
<td> Create a notification observer (more on this later) </td>
</tr>
</tbody>
</table>


<p>Mock 对象是只是一个空壳，只能调用预先定义的方法，调用没有预先定义的方法会抛出异常；
Nice Mock 对象也是一个空壳，只是它会忽略没有预先定义的方法不会抛出异常；
Partial Mock 对象是把一个已有的对象转成 Mock，调用没有预先定义的方法，它会把方法传给已存在的对象；<br/>
Observer Mock 对象是用来观察通知的。</p>

<h3>Specify the expected invocations and return values</h3>

<blockquote><p>Calling either the -expect or -stub method will return an object that you can use to setup your expectations.</p></blockquote>

<ul>
<li><p>Specify the expected invocations</p>

<ol>
<li>不带参数的方法</li>
</ol>
</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>- (void)testInit {
</span><span class='line'>  id mockService = [OCMockObject mockForProtocol:@protocol(AVQuoteService)];
</span><span class='line'>  [[mockService expect] initiateConnection];
</span><span class='line'>  
</span><span class='line'>  AVStockPortfolio *portfolio = [[AVStockPortfolio alloc] initWithService:mockService];
</span><span class='line'>  
</span><span class='line'>  [mockService verify];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p></br>
    2. 带参数的方法</p>

<blockquote><p>You can use any of the following OCMArg class methods in place of a real argument when setting up your method expectations:</p></blockquote>

<table>
<thead>
<tr>
<th> OCMArg method </th>
<th> Description </th>
</tr>
</thead>
<tbody>
<tr>
<td> +any </td>
<td> Any argument is accepted. </td>
</tr>
<tr>
<td> +anyPointer </td>
<td> Accepts any pointer </td>
</tr>
<tr>
<td> +isNil     </td>
<td> The given argument must be nil </td>
</tr>
<tr>
<td> +isNotNil  </td>
<td> The given argument must not be nil </td>
</tr>
<tr>
<td> +isNotEqual:   </td>
<td> Given argument is not object-equivalent with expectation </td>
</tr>
<tr>
<td> +checkWithSelector: </td>
<td> onObject:   Check the argument with the given action/target pair </td>
</tr>
<tr>
<td> +checkWithBlock: </td>
<td> Check the argument with the given block (OS X 10.6 or iOS 4) </td>
</tr>
</tbody>
</table>


<blockquote><p>OCMock also provides a few handy macros for argument matching:</p></blockquote>

<table>
<thead>
<tr>
<th> Macro </th>
<th> Description </th>
</tr>
</thead>
<tbody>
<tr>
<td> OCMOCK_ANY()   </td>
<td> Equivalent to [OCMArg any] </td>
</tr>
<tr>
<td> OCMOCK_VALUE(value) </td>
<td> A quick way to match a non-object argument </td>
</tr>
<tr>
<td> CONSTRAINT(selector) </td>
<td> Validate with a given selector on self </td>
</tr>
<tr>
<td> CONSTRAINTV(selector,value) </td>
<td>     Validate with a given selector on self and an additional argument </td>
</tr>
</tbody>
</table>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>id classMock = OCMClassMock([SomeClass class]);
</span><span class='line'>OCMExpect([classMock someMethodWithArgument:[OCMArg isNotNil]]);
</span><span class='line'>
</span><span class='line'>/* run code under test, which is assumed to call someMethod */
</span><span class='line'>
</span><span class='line'>OCMVerifyAll(classMock)</span></code></pre></td></tr></table></div></figure>


<p></br>
    3. 通知</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)testSellSharesInStock {
</span><span class='line'>  id mock = [OCMockObject observerMock];
</span><span class='line'>  // OCMock adds a custom methods to NSNotificationCenter via a category
</span><span class='line'>  [[NSNotificationCenter defaultCenter] addMockObserver:mock
</span><span class='line'>                                                   name:AVStockSoldNotification
</span><span class='line'>                                                 object:nil];
</span><span class='line'>                                               
</span><span class='line'>  [[mock expect] notificationWithName:AVStockSoldNotification object:[OCMArg any]];
</span><span class='line'>
</span><span class='line'>  AVPortfolio *portfolio = [self createPortfolio]; // made-up factory method
</span><span class='line'>  [portfolio sellShares:100 inStock:@"AAPL"];
</span><span class='line'>
</span><span class='line'>  [mock verify];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Specify the return values</li>
</ul>


<blockquote><p>If methods on your mocks need to return values, you have a variety of methods to call on the object returned by -expect or -stub.</p></blockquote>

<table>
<thead>
<tr>
<th> Method </th>
<th> Explanation </th>
</tr>
</thead>
<tbody>
<tr>
<td> -andReturn: </td>
<td> Return the given object </td>
</tr>
<tr>
<td> -andReturnValue: </td>
<td> Return a non-object value (wrapped in a NSValue) </td>
</tr>
<tr>
<td> -andThrow: </td>
<td> Throw the given exception </td>
</tr>
<tr>
<td> -andPost: </td>
<td>   Post the given notification </td>
</tr>
<tr>
<td> -andCall:onObject: </td>
<td> Call the selector on the given object </td>
</tr>
<tr>
<td> -andDo: </td>
<td> Invoke the given block (only on OS X 10.6 or iOS 4) </td>
</tr>
</tbody>
</table>


<h3>Execution &amp; Validation</h3>

<ul>
<li>Associate the mock object with the code under test</li>
<li>Execute the code under test</li>
<li>Validate that your assertions are correct</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)testSellSharesInStock {
</span><span class='line'>  id quoteService = [[OCMockObject] mockForProtocol:@protocol(AVQuoteService)];
</span><span class='line'>  [[[quoteService expect] andDo:^(NSInvocation *invocation) {
</span><span class='line'>    // validate arguments, set return value on the invocation object
</span><span class='line'>  }] priceForStock:@"AAPL"];
</span><span class='line'>  
</span><span class='line'>  // Associate the mock object with the code under test
</span><span class='line'>  AVStockPortfolio *portfolio = [[AVStockPortfolio alloc] initWithService:quoteService];
</span><span class='line'>  // Execute the code under test
</span><span class='line'>  [portfolio sellShares:100 inStock:@"AAPL"];
</span><span class='line'>  
</span><span class='line'>  // Validate that your assertions are correct
</span><span class='line'>  
</span><span class='line'>  [quoteService verify];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Q:How to mocking singleton?
A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// we can replace it with a mock object
</span><span class='line'>id mockManager = [OCMockObject mockForClass:[ArticleManager class]];
</span><span class='line'>[ArticleManager setSharedInstance:mockManager];
</span><span class='line'>// we can reset it so that it returns the actual ArticleManager
</span><span class='line'>[ArticleManager setSharedInstance:nil];
</span><span class='line'>
</span><span class='line'>// Objective-C Singleton Pattern Updated For Testability
</span><span class='line'>@implementation ArticleManager
</span><span class='line'>
</span><span class='line'>static ArticleManager *_sharedInstance = nil;
</span><span class='line'>static dispatch_once_t once_token = 0;
</span><span class='line'>
</span><span class='line'>+(instancetype)sharedInstance {
</span><span class='line'>    dispatch_once(&once_token, ^{
</span><span class='line'>        if (_sharedInstance == nil) {
</span><span class='line'>            _sharedInstance = [[ArticleManager alloc] init];
</span><span class='line'>        }
</span><span class='line'>    });
</span><span class='line'>    return _sharedInstance;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>+(void)setSharedInstance:(ArticleManager *)instance {
</span><span class='line'>    once_token = 0; // resets the once_token so dispatch_once will run again
</span><span class='line'>    _sharedInstance = instance;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://twobitlabs.com/2013/01/objective-c-singleton-pattern-unit-testing/">Objective-C Singleton Pattern Updated For Testability</a></p>

<h2>Reference:</h2>

<p><a href="http://ocmock.org">OCMock</a><br/>
<a href="http://www.archive.alexvollmer.com/posts/2010/06/28/making-fun-of-things-with-ocmock/">Making Fun of Things with OCMock</a><br/>
<a href="http://hackazach.net/code/2014/03/03/effective-testing-with-ocmock/">OCMock Test Origami</a><br/>
<a href="http://engineering.aweber.com/improving-ios-unit-tests-with-ocmock/">IMPROVING IOS UNIT TESTS WITH OCMOCK</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS App 开发问题汇总（五）]]></title>
    <link href="http://DamianSheldon.github.io/blog/ios-development-problems-part-5.html"/>
    <updated>2016-01-08T21:32:22+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/ios-development-problems-part-5</id>
    <content type="html"><![CDATA[<h3>1.On iOS 7 and later, how do I take a snapshot of my view and save the result in a UIImage?</h3>

<p>Solution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (UIImage *)snapshot:(UIView *)view
</span><span class='line'>{
</span><span class='line'>    UIGraphicsBeginImageContextWithOptions(view.bounds.size, YES, 0);
</span><span class='line'>    [view drawViewHierarchyInRect:view.bounds afterScreenUpdates:YES];
</span><span class='line'>    UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
</span><span class='line'>    UIGraphicsEndImageContext();
</span><span class='line'>    
</span><span class='line'>    return image;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="https://developer.apple.com/library/ios/qa/qa1817/_index.html">https://developer.apple.com/library/ios/qa/qa1817/_index.html</a></p>

<h3>2.How to present a view controller on iOS7 without the status bar overlapping?</h3>

<p>Solution:The easiest workaround I&rsquo;ve found is to wrap the view controller you want to present inside a navigation controller, and then present that navigation controller.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MyViewController *vc = [MyViewController new];
</span><span class='line'>UINavigationController *nvc = [[UINavigationController alloc] 
</span><span class='line'>    initWithRootViewController:vc];
</span><span class='line'>[self presentViewController:nvc animated:YES completion:nil];</span></code></pre></td></tr></table></div></figure>


<h3>3.代码创建 UITableView 时如何使用各种系统样式的 UITableViewCell?</h3>

<p>Solution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
</span><span class='line'>{
</span><span class='line'>    static NSString *sCellID = @"CellID";
</span><span class='line'>
</span><span class='line'>    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:sCellID];
</span><span class='line'>    if (!cell) {
</span><span class='line'>        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:sCellID];
</span><span class='line'>    }
</span><span class='line'>    // Configure the cell...
</span><span class='line'>    
</span><span class='line'>    return cell;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h3>4.Settings bundle not showing up in iPhone settings</h3>

<p>Solution:iOS 9.0.x - 9.2 Settings App Bug, Using the App Switch UI (double-press Home button) to kill the Settings App.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/2683793/settings-bundle-not-showing-up-in-iphone-settings">http://stackoverflow.com/questions/2683793/settings-bundle-not-showing-up-in-iphone-settings</a></p>

<h3>5.单元测试的 Target 在测试导航栏里是灰色的不能点击测试。</h3>

<p>Solution: Edit Scheme &hellip; > Test > + > Select your test target.</p>

<h3>6.How to change UITableViewCell Image to Circle in UITableView</h3>

<p>Solution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Subclass UITableViewCell override layoutSubviews method
</span><span class='line'>
</span><span class='line'>- (void)layoutSubviews
</span><span class='line'>{
</span><span class='line'>    [super layoutSubviews];
</span><span class='line'>    
</span><span class='line'>    self.imageView.layer.cornerRadius = CGRectGetHeight(self.imageView.frame) * 0.5;
</span><span class='line'>    self.imageView.layer.masksToBounds = YES;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/23350728/how-to-change-uitableviewcell-image-to-circle-in-uitableview">http://stackoverflow.com/questions/23350728/how-to-change-uitableviewcell-image-to-circle-in-uitableview</a></p>

<h3>7.How to downgrading Cocoapods?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// First you can figure out which version of Cocoapods you are on with the command:
</span><span class='line'>$ pod --version
</span><span class='line'>
</span><span class='line'>// You can also see all the version of Cocoapods you have installed with this command:
</span><span class='line'>$ sudo gem list cocoapods
</span><span class='line'>
</span><span class='line'>// Next uninstall Cocoapods. If you have multiple version, you will have the choice of uninstalling all or a specific version.
</span><span class='line'>$ sudo gem uninstall cocoapods
</span><span class='line'>
</span><span class='line'>// Finally you can install the specific version with this command:
</span><span class='line'>$ sudo gem install cocoapods -v 0.39.0</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="https://diego.org/2015/09/24/downgrading-cocoapods/">https://diego.org/2015/09/24/downgrading-cocoapods/</a></p>

<h3>8.How to get UISearchDisplayController to search only after search button is pressed？</h3>

<p>A:Setup a delegate for the search bar and implement the searchBarSearchButtonClicked: method. Do your searching from that method. Just return NO from the shouldReloadTableForSearchString method.</p>

<p>Reference:<a href="http://stackoverflow.com/questions/18563529/how-to-get-uisearchdisplaycontroller-to-search-only-after-search-button-is-press">http://stackoverflow.com/questions/18563529/how-to-get-uisearchdisplaycontroller-to-search-only-after-search-button-is-press</a></p>

<h3>9.Warning: the running version of Bundler is older than the version that created the lockfile. We suggest you upgrade to the latest version of Bundler by running <code>gem install bundler</code>.</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo gem install bundler
</span><span class='line'>$ bundle install
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>An error occurred while installing git (1.2.9.1), and Bundler cannot continue.
</span><span class='line'>Make sure that `gem install git -v '1.2.9.1'` succeeds before bundling.
</span><span class='line'>
</span><span class='line'>$ sudo gem install git -v '1.2.9.1'
</span><span class='line'>$ sudo gem install lowdown -v '0.0.5' --verbose
</span><span class='line'>...
</span><span class='line'>ERROR:  Error installing lowdown:
</span><span class='line'>  lowdown requires Ruby version &gt;= 2.1.0.
</span><span class='line'>  
</span><span class='line'>$ ruby --version
</span><span class='line'>ruby 2.0.0p645 (2015-04-13 revision 50299) [universal.x86_64-darwin15]
</span><span class='line'>// On OS X machines, you can use third-party tools (rbenv and RVM).
</span><span class='line'>// Install RVM:
</span><span class='line'>$ \curl -sSL https://get.rvm.io | bash -s stable --ruby=2.1.8
</span><span class='line'>
</span><span class='line'>* To start using RVM you need to run `source /Users/dongmeiliang/.rvm/scripts/rvm`
</span><span class='line'>    in all your open shell windows, in rare cases you need to reopen all shell windows.
</span><span class='line'>$ source /Users/dongmeiliang/.rvm/scripts/rvm
</span><span class='line'>
</span><span class='line'>// Check rvm has been installed successfully
</span><span class='line'>$ rvm --help
</span><span class='line'>
</span><span class='line'>$ bundle install
</span><span class='line'>/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/2.0.0/rubygems/dependency.rb:296:in `to_specs': Could not find 'bundler' (&gt;= 0) among 13 total gem(s) (Gem::LoadError)
</span><span class='line'>  from /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/2.0.0/rubygems/dependency.rb:307:in `to_spec'
</span><span class='line'>  from /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/2.0.0/rubygems/core_ext/kernel_gem.rb:47:in `gem'
</span><span class='line'>  from /usr/local/bin/bundle:22:in `&lt;main&gt;'
</span><span class='line'>  
</span><span class='line'>We need reinstall bundler after update ruby:
</span><span class='line'>$ gem install bundler
</span><span class='line'>Fetching: bundler-1.11.2.gem (100%)
</span><span class='line'>Successfully installed bundler-1.11.2
</span><span class='line'>Parsing documentation for bundler-1.11.2
</span><span class='line'>Installing ri documentation for bundler-1.11.2
</span><span class='line'>Done installing documentation for bundler after 6 seconds
</span><span class='line'>1 gem installed
</span><span class='line'>
</span><span class='line'>//bundle - Ruby Dependency Management
</span><span class='line'>//gem -- RubyGems program, RubyGems is a sophisticated package manager for Ruby.
</span><span class='line'>//rvm - The Ruby Version Manager</span></code></pre></td></tr></table></div></figure>


<h3>10.Attempt to set a non-property-list object</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Attempt to set a non-property-list object &lt;CFBasicHash 0x15809b8d0 [0x19ec23b68]&gt;{type = immutable dict, count = 12,
</span><span class='line'>
</span><span class='line'>entries =&gt;
</span><span class='line'>
</span><span class='line'>  0 : id = &lt;CFNumber 0xb000000000000043 [0x19ec23b68]&gt;{value = +4, type = kCFNumberSInt64Type}
</span><span class='line'>
</span><span class='line'>  1 : &lt;CFString 0x156dda8d0 [0x19ec23b68]&gt;{contents = "allFreeLifeId"} = &lt;CFNull 0x19ec23ea8 [0x19ec23b68]&gt;
</span><span class='line'>
</span><span class='line'>  5 : &lt;CFString 0x156fd04d0 [0x19ec23b68]&gt;{contents = "portraitUri"} = &lt;CFNull 0x19ec23ea8 [0x19ec23b68]&gt;
</span><span class='line'>
</span><span class='line'>  6 : mobile = &lt;CFString 0x156df0dd0 [0x19ec23b68]&gt;{contents = "18670789602"}
</span><span class='line'>
</span><span class='line'>  11 : ryUserId = &lt;CFString 0x156fbef80 [0x19ec23b68]&gt;{contents = "AFL2016020310001627518670789602"}
</span><span class='line'>
</span><span class='line'>  13 : birthDay = &lt;CFNull 0x19ec23ea8 [0x19ec23b68]&gt;
</span><span class='line'>
</span><span class='line'>  14 : signature = &lt;CFString 0x19a51d480 [0x19ec23b68]&gt;{contents = ""}
</span><span class='line'>
</span><span class='line'>  15 : token = &lt;CFString 0x1580a3cc0 [0x19ec23b68]&gt;{contents = "vL9oen0gHgJF7sRMWdaacY9LZ0Y0py8pcDvpcwTzcsCvfbB0kFB1PaDbWZ1c1GGZ8/jRvJ5KfX2oT3Sv+7Wb75r8W7FhoewF9l1Si6GJa2B48Xpc3rElo2a6FVG/X29zQOiOTHRjfiM="}
</span><span class='line'>
</span><span class='line'>  16 : password = &lt;CFString 0x1580d5050 [0x19ec23b68]&gt;{contents = "E10ADC3949BA59ABBE56E057F20F883E"}
</span><span class='line'>
</span><span class='line'>  20 : email = &lt;CFNull 0x19ec23ea8 [0x19ec23b68]&gt;
</span><span class='line'>
</span><span class='line'>  21 : name = Julian
</span><span class='line'>
</span><span class='line'>  22 : gender = &lt;CFNull 0x19ec23ea8 [0x19ec23b68]&gt;
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'> as an NSUserDefaults/CFPreferences value for key UserInfo</span></code></pre></td></tr></table></div></figure>


<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Write
</span><span class='line'>NSData *dataFromUserInfo = [NSKeyedArchiver archivedDataWithRootObject:userInfo];
</span><span class='line'>[[NSUserDefaults standardUserDefaults] setObject:dataFromUserInfo forKey:sUserInfoKey];
</span><span class='line'>
</span><span class='line'>// Read
</span><span class='line'>NSData *dataFromUserInfo = [[NSUserDefaults standardUserDefaults] objectForKey:sUserInfoKey];
</span><span class='line'>NSDictionary *ret = [NSKeyedUnarchiver unarchiveObjectWithData:dataFromUserInfo];</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/19720611/attempt-to-set-a-non-property-list-object-as-an-nsuserdefaults">http://stackoverflow.com/questions/19720611/attempt-to-set-a-non-property-list-object-as-an-nsuserdefaults</a></p>

<h3>11.Missing iOS Distribution signing identity</h3>

<p>A:KeyChain Access > select the System keychain > View > Show Expired Certificates > delete the expired version of the Apple Worldwide Developer Relations Certificate Authority Intermediate certificate (expired on February 14, 2016)</p>

<p>Reference:<a href="http://stackoverflow.com/questions/32821189/xcode-7-error-missing-ios-distribution-signing-identity-for">http://stackoverflow.com/questions/32821189/xcode-7-error-missing-ios-distribution-signing-identity-for</a></p>

<h3>12. FMDB unable to open db under Application Support directory.</h3>

<p>A:Unlike the Documents directory, the Application Support directory does not exist in the app&rsquo;s sandbox by default. You need to create it before you can use it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSURL * ApplicationSupportDirectory()
</span><span class='line'>{
</span><span class='line'>    NSURL *applicationSupportDir = URLOfDirectory(NSApplicationSupportDirectory);
</span><span class='line'>    
</span><span class='line'>    if (applicationSupportDir) {
</span><span class='line'>        // If the directory does not exist, this method creates it.
</span><span class='line'>        // This method is only available in OS X v10.7 and iOS 5.0 or later.
</span><span class='line'>        [[NSFileManager defaultManager] createDirectoryAtURL:applicationSupportDir withIntermediateDirectories:YES attributes:nil error:nil];
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return applicationSupportDir;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/16204988/ios-cant-save-file-to-application-support-folder-but-can-to-documents">http://stackoverflow.com/questions/16204988/ios-cant-save-file-to-application-support-folder-but-can-to-documents</a>
<a href="http://www.cocoawithlove.com/2010/05/finding-or-creating-application-support.html">http://www.cocoawithlove.com/2010/05/finding-or-creating-application-support.html</a></p>

<h3>13.How to NSLog a Call stack when a program is running?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1. Cocoa framework
</span><span class='line'>NSLog(@"%@", [NSThread callStackSymbols]);
</span><span class='line'>
</span><span class='line'>// 2. C API
</span><span class='line'>#include &lt;execinfo.h&gt;
</span><span class='line'>
</span><span class='line'>int size = 256;
</span><span class='line'>void *stack[size];
</span><span class='line'>size = backtrace(stack, size);
</span><span class='line'>
</span><span class='line'>char **syms = backtrace_symbols(stack, size);
</span><span class='line'>for (int i = 0; i &lt; size; i++) {
</span><span class='line'>    printf("Frame #%d: %s\n", i, syms[i]);
</span><span class='line'>}
</span><span class='line'>free(syms);</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/13319551/how-to-nslog-a-call-stack-when-a-program-is-running">http://stackoverflow.com/questions/13319551/how-to-nslog-a-call-stack-when-a-program-is-running</a></p>

<h3>14.How does programmatically construct to-one and to-many relationship in Core Data?</h3>

<p>A:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSRelationshipDescription *department = [NSRelationshipDescription new];
</span><span class='line'>department.name = @"department";
</span><span class='line'>department.deleteRule = NSNullifyDeleteRule;
</span><span class='line'>department.minCount = 0;
</span><span class='line'>department.maxCount = 1;// max = 1 for to-one relationship
</span><span class='line'>    
</span><span class='line'>NSRelationshipDescription *employees = [NSRelationshipDescription new];
</span><span class='line'>employees.name = @"employees";
</span><span class='line'>employees.deleteRule = NSNullifyDeleteRule;
</span><span class='line'>employees.minCount = 0;
</span><span class='line'>employees.maxCount = 0;// max = 0 for to-many relationship</span></code></pre></td></tr></table></div></figure>


<p>Reference:<a href="http://stackoverflow.com/questions/13743242/adding-relationships-in-nsmanagedobjectmodel-to-programmatically-created-nsentit">http://stackoverflow.com/questions/13743242/adding-relationships-in-nsmanagedobjectmodel-to-programmatically-created-nsentit</a></p>

<h3>15.ld: warning: directory not found for option &lsquo;-F/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator9.2.sdk/Developer/Library/Frameworks&rsquo;</h3>

<p>A:Delete entries that generate warnings.</p>

<p>UnitTest > Build Settings > Search Paths > Framework Search Paths ></p>

<p>$(SDKROOT)/Developer/Library/Frameworks
$(DEVELOPER_FRAMEWORKS_DIR)</p>

<p>Reference:<a href="http://stackoverflow.com/questions/30827022/xcode-7-library-search-path-warning/32620919#32620919">http://stackoverflow.com/questions/30827022/xcode-7-library-search-path-warning/32620919#32620919</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Wireshark 抓 iPhone 网络请求的数据包]]></title>
    <link href="http://DamianSheldon.github.io/blog/capturing-iphone-traffic-on-wireshark.html"/>
    <updated>2016-01-04T14:43:00+08:00</updated>
    <id>http://DamianSheldon.github.io/blog/capturing-iphone-traffic-on-wireshark</id>
    <content type="html"><![CDATA[<p>开发过程中经常可能遇到网络问题，这时候我们需要抓包来定位问题所在。那么如何用 Wireshark 抓取 iPhone 真机网络请求的数据包呢？</p>

<blockquote><p>iOS does not support packet tracing directly. However, if you&rsquo;re developing for iOS you can take a packet trace of your app in a number of different ways:</p>

<p>If the problem you&rsquo;re trying to debug occurs on Wi-Fi, you can put your iOS device on a test Wi-Fi network. See Wi-Fi Capture for details.<br/>
If your app uses HTTP, you can configure your iOS device to use a debugging HTTP proxy (such as Charles HTTP Proxy).<br/>
In iOS 5 and later you can use the remote virtual interface facility.</p></blockquote>

<!-- more -->


<p>这里我使用的是第三种方法：remote virtual interface。</p>

<p>iOS 5 added a remote virtual interface (RVI) facility that lets you use OS X packet trace programs to capture traces from an iOS device. The basic strategy is:</p>

<ol>
<li>Connect your iOS device to your Mac via USB.</li>
<li>Set up an RVI for that device. This creates a virtual network interface on your Mac that represents the iOS device&rsquo;s networking stack.</li>
<li>Run your OS X packet trace program, and point it at the RVI created in the previous step.</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ # First get the current list of interfaces.
</span><span class='line'>$ ifconfig -l
</span><span class='line'>lo0 gif0 stf0 en0 en1 p2p0 fw0 ppp0 utun0
</span><span class='line'>$ # Get connected device's UDID follow: Xcode &gt; Window &gt; Devices &gt; Select connected device &gt; identifier
</span><span class='line'>$ # Then run the tool with the UDID of the device.
</span><span class='line'>$ rvictl -s 74bd53c647548234ddcef0ee3abee616005051ed
</span><span class='line'> 
</span><span class='line'>Starting device 74bd53c647548234ddcef0ee3abee616005051ed [SUCCEEDED]
</span><span class='line'> 
</span><span class='line'>$ # Get the list of interfaces again, and you can see the new virtual
</span><span class='line'>$ # network interface, rvi0, added by the previous command.
</span><span class='line'>$ ifconfig -l
</span><span class='line'>lo0 gif0 stf0 en0 en1 p2p0 fw0 ppp0 utun0 rvi0</span></code></pre></td></tr></table></div></figure>


<p>打开 Wireshark, 选择 rvi0 作为待抓包的接口。</p>

<h1>Reference</h1>

<p><a href="https://developer.apple.com/library/mac/qa/qa1176/_index.html">Getting a Packet Trace</a><br/>
<a href="http://stackoverflow.com/questions/9555403/capturing-mobile-phone-traffic-on-wireshark">Capturing mobile phone traffic on wireshark</a></p>
]]></content>
  </entry>
  
</feed>
