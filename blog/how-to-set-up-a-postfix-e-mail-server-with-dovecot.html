
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>如何搭建一个带 Dovecot 的 Postfix 邮件服务器  | Hello World</title>

<meta name="author" content="Sheldon"> 

<meta name="description" content="Sheldon's personal technology blog about iOS development, Android development, Back-end development, Web development and english study."> <meta name="keywords" content="Postfix, Dovecot, E-Mail, debian, jessie">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hello World" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>-->
	<script src="/javascripts/libs/jquery.min.js"></script>
	<script src="/javascripts/libs/jquery-migrate-1.4.1.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">

</head>



<body>
	<header id="header" class="inner"><h1><a href="/">Hello World</a></h1>
<h4>Here's where it all happens for me.</h4>
<nav id="main-nav"><ul>
    <li><a href="/">Blog</a></li>
    <li><a href="/archives">Archive</a></li>
    <li><a href="/ios-development">iOS</a></li>
    <li><a href="/android">Android</a></li>
    <li><a href="/web-development">Web</a></li>
    <li><a href="/english">English</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>

<form class="search" action="http://www.yahoo.com.cn/search" method="get">
    <fieldset role="search">
        <input type="hidden" name="vs" value="http://DamianSheldon.github.io">
        <input class="search" type="text" name="p" results="0" placeholder="Search">
    </fieldset>
</form>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
    <li><a href="/">Blog</a></li>
    <li><a href="/archives">Archive</a></li>
    <li><a href="/ios-development">iOS</a></li>
    <li><a href="/android">Android</a></li>
    <li><a href="/web-development">Web</a></li>
    <li><a href="/english">English</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>

<form class="search" action="http://www.yahoo.com.cn/search" method="get">
    <fieldset role="search">
        <input type="hidden" name="vs" value="http://DamianSheldon.github.io">
        <input class="search" type="text" name="p" results="0" placeholder="Search">
    </fieldset>
</form>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:DamianSheldon.github.io">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">如何搭建一个带 Dovecot 的 Postfix 邮件服务器</h2>
	<div class="entry-content"><p>不知道从什么时候开始，也不知道是什么原因，我一直觉得有个自己域名的邮箱很酷，所以我决定自己动手搭建一个邮件服务器。本文记录了我搭建一个自己域名的邮件服务器，并让这个邮箱可以通过 Mac 和 iPhone 自由收发邮件的过程。</p>

<h2>准备材料</h2>

<ul>
<li>VPS</li>
<li>域名</li>
</ul>


<p>VPS 我用的 DigitalOcean，打个小广告，如果你也想买个他们家的VPS,可以用我的优惠码：<a href="https://m.do.co/c/537dc7bd8a78">https://m.do.co/c/537dc7bd8a78</a></p>

<p>我服务器跑的是 Debian 8 Jessie.</p>

<h2>配置 DNS</h2>

<h3>添加 MX 记录</h3>

<p>添加从域名到 VPS IP 的 MX 记录，它指定了负责处理这个域名邮件收发的服务器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Type    Hostname        Value         TTL
</span><span class='line'>MX      tenneshop.com   1.2.3.4.      1800</span></code></pre></td></tr></table></div></figure>


<h3>验证 DNS</h3>

<p>DNS 需要几个小时才能蔓延到整个互联网，但是在你的 DNS 服务器上几分钟之后就会生效，你可以用 dig 和 host 来验证。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@yourbase] ~# dig MX mydomain.com +short @ns1.digitalocean.com
</span><span class='line'>50 mail.mydomain.com.
</span><span class='line'>[root@yourbase] ~# host mail.mydomain.com ns1.digitalocean.com
</span><span class='line'>Using domain server:
</span><span class='line'>Name: ns1.digitalocean.com
</span><span class='line'>Address: 198.199.120.125#53
</span><span class='line'>Aliases:
</span><span class='line'>
</span><span class='line'>mail.mydomain.com has address 82.196.9.119</span></code></pre></td></tr></table></div></figure>


<!--more-->


<h2>邮件系统是怎么工作</h2>

<p>开始之前我觉得有必要了解下邮件系统是怎么工作的，Dovecot 上有篇文章介绍的很好，值得看下：<a href="http://wiki.dovecot.org/MailServerOverview">Overview of how everything works together</a>,
我简单地说一下我的理解，先看发邮件，以使用 Mac 的 Mail 为例，用户用 Mail 写了封邮件，邮件包含收件人地址和信件内容，然后点击发送，Mail 在这里就是 MUA(Mail User Agent), MUA 把邮件发送到 Mail Server, Mail Server 称之为 MTA(Mail Transfer Agent), MTA 根据收件人地址去查询 DNS 记录，然后把邮件发送到目标MTA, 目标MTA则负责把邮件传送给MDA(Mail Delivery Agent), MDA则负责把邮件存储到邮件服务器上。</p>

<p>再看收邮件，用户打开 Mail 之后会触发收件操作，通常是通过 IMAP 或 POP3 协议去获取 MDA 存储在 Mail Server 上的邮件。</p>

<p>我们这里 MTA 用的 Postfix, IMAP/POP3 Server 用的 Dovecot.</p>

<h2>Postfix</h2>

<h3>安装</h3>

<p>Debian 默认的邮件服务程序是 exim，我们需要卸载它。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo aptitude remove exim4 && aptitude install postfix && postfix stop</span></code></pre></td></tr></table></div></figure>


<h3>配置</h3>

<p>Postfix 有两个主要配置文件 /etc/postfix/main.cf 和 /etc/postfix/master.cf, main.cf 指定配置项；master.cf 指定 postfix 要运行哪些服务。</p>

<p>配置的主要工作自然是编辑 main.cf 这个文件里的配置项，安全起见我们可以先把默认的配置文件做个备份:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp /etc/postfix/main.cf /etc/postfix/main.cf.orig</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置发送邮件使用的域名;</li>
</ul>


<p>我们可能希望别人收到我们的邮件时显示的收件人是user@example.com这种形式而不是user@mail.example.com,这可以通过设置myorigin来实现:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf
</span><span class='line'>myorigin = $mydomain</span></code></pre></td></tr></table></div></figure>


<ul>
<li>希望收到哪些域名的邮件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>domain-wide mail server
</span><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>    mydestination = $myhostname localhost.$mydomain localhost $mydomain
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置哪些终端可以中继邮件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>mynetworks_style = host
</span><span class='line'>mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 </span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置邮件服务器的基本账号，例如 postmaster, 这是必须要有的账号，这样别人才能反馈邮件投递的问题。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/aliases:
</span><span class='line'>mailer-daemon: postmaster
</span><span class='line'>postmaster: root
</span><span class='line'>nobody: root
</span><span class='line'>hostmaster: root
</span><span class='line'>usenet: root
</span><span class='line'>news: root
</span><span class='line'>webmaster: root
</span><span class='line'>www: root
</span><span class='line'>ftp: root
</span><span class='line'>abuse: root
</span><span class='line'>root: yourname</span></code></pre></td></tr></table></div></figure>


<p>更新完了/etc/aliases，还需要运行命令去生效:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ newaliases</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置邮件用户账号</li>
</ul>


<p>Postfix 使用数据库文件来控制权限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>    virtual_alias_maps = hash:/etc/postfix/virtual
</span><span class='line'>
</span><span class='line'>/etc/postfix/virtual:
</span><span class='line'>// Map Mail Addresses to Linux Accounts
</span><span class='line'>contact@example.com sammy
</span><span class='line'>admin@example.com sammy</span></code></pre></td></tr></table></div></figure>


<p>我们可以通过如下命令来让映射生效:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo postmap /etc/postfix/virtual</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置邮件的存储文件格式</li>
</ul>


<blockquote><p>There are two primary storage options of mail in the *NIX world: mbox and Maildir. mbox stores multiple messages - sometimes hundreds or thousands of messages - in a single file. Maildir stores each message a separate file.</p></blockquote>

<p>Postfix 默认是 mbox 的格式，这里我们决定使用 Maildir 的格式，可以用 postconf 命令来配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo postconf -e 'home_mailbox= Maildir/'</span></code></pre></td></tr></table></div></figure>


<p>更新环境变量 MAIL 的值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 'export MAIL=~/Maildir' | sudo tee -a /etc/bash.bashrc | sudo tee -a /etc/profile.d/mail.sh</span></code></pre></td></tr></table></div></figure>


<p>让变量在当前的会话中生效：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source /etc/profile.d/mail.sh</span></code></pre></td></tr></table></div></figure>


<h3>测试</h3>

<p>本地测试之前需要初始化 Maildir 的目录结构，在我们 home 目录中创建 Maildir 目录结构最简单的方法是向我们自己发一封邮件，可以使用 mail 命令:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 安装 mail 命令
</span><span class='line'>$ sudo apt-get install mailutils
</span><span class='line'>
</span><span class='line'>// 发送邮件
</span><span class='line'>$ echo 'init' | mail -s 'init' sammy
</span><span class='line'>
</span><span class='line'>// 确认 Maildir 目录结构初始化好了
</span><span class='line'>$ ls -R ~/Maildir
</span><span class='line'>
</span><span class='line'>// 输出的结果： 
</span><span class='line'>/home/sammy/Maildir/:
</span><span class='line'>cur  new  tmp
</span><span class='line'>
</span><span class='line'>/home/sammy/Maildir/cur:
</span><span class='line'>
</span><span class='line'>/home/sammy/Maildir/new:
</span><span class='line'>1463177269.Vfd01I40e4dM691221.mail.example.com
</span><span class='line'>
</span><span class='line'>/home/sammy/Maildir/tmp:</span></code></pre></td></tr></table></div></figure>


<p>使用 mail 命令发送邮件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mail -s "Hello World" someone@example.com
</span><span class='line'>Cc: 
</span><span class='line'>Hi Peter
</span><span class='line'>How are you
</span><span class='line'>I am fine
</span><span class='line'>Good Bye
</span><span class='line'>&lt;Ctrl+D&gt;</span></code></pre></td></tr></table></div></figure>


<p>使用 mail 命令查看邮件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mail
</span><span class='line'>Heirloom mailx version 12.5 6/20/10.  Type ? for help.
</span><span class='line'>"/var/mail/enlightened": 7 messages 3 unread
</span><span class='line'>O  1 Enlightened        Sat Dec  6 11:33   21/658   This is the subject
</span><span class='line'>O  2 Enlightened        Sat Dec  6 11:34  773/25549 This is the subject
</span><span class='line'>O  3 Enlightened        Sat Dec  6 16:43   20/633   This is the subject
</span><span class='line'>O  4 Enlightened        Sat Dec  6 16:44   20/633   This is the subject
</span><span class='line'>U  5 Mail Delivery Syst Sat Dec  6 16:50   74/2425  Undelivered Mail Returned to Sender
</span><span class='line'>U  6 Enlightened        Sat Dec  6 16:51   19/632   This is mutts subject
</span><span class='line'>U  7 Enlightened        Sat Dec  6 16:52   19/647   This is mutts subject
</span><span class='line'>?</span></code></pre></td></tr></table></div></figure>


<p>我们可以使用 ? 来查看帮助，例如查看下一封邮件是n, 退出是q。</p>

<p>日常生活工作中我们可能不会是通过 mail 来收发邮件，但它在我们配置邮件服务器时很有用，我们可以知道 postfix 是否是正常工作的。</p>

<p>如果postfix并没有按我们预期那样正常工作，我们可以通过查看系统日志和邮件日志来定位问题:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// system log
</span><span class='line'>$ sudo tail -f /var/log/syslog
</span><span class='line'>
</span><span class='line'>// mail log
</span><span class='line'>$ suod tail -f /var/log/mail.log</span></code></pre></td></tr></table></div></figure>


<h2>Dovecot</h2>

<h3>安装</h3>

<p>Dovecot 支持 imap 和 pop3，这里我用的 imap,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aptitude install dovecot-core dovecot-imapd</span></code></pre></td></tr></table></div></figure>


<h3>配置</h3>

<p>Dovecot 的配置文档要比 postfix 好得多，只需要参考它的 Dovecot installation。</p>

<ul>
<li>Checking where mail is delivered to</li>
</ul>


<p>我们的邮件地址是 ~/Maildir, 更新到配置文件中:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/dovecot/conf.d/10-mail.conf:
</span><span class='line'>mail_location = maildir:~/Maildir</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Configuring Dovecot</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Find Dovecot configuration file location using:
</span><span class='line'>$ doveconf -n | head -n1
</span><span class='line'>/etc/dovecot/dovecot.conf
</span><span class='line'>
</span><span class='line'>// Authentication
</span><span class='line'>// 由于我们打算使用虚拟用户，所以我们这里创建一个类似密码的文件:
</span><span class='line'>$ echo "$USER:{PLAIN}password:$UID:$GID::$HOME" &gt; users
</span><span class='line'>$ sudo mv users /etc/dovecot/
</span><span class='line'>
</span><span class='line'>$GID 这个环境变量可能没值，我们可以手动编辑，首先找出gid：
</span><span class='line'>id $USER
</span><span class='line'>
</span><span class='line'>然后把gid 加到对应的字段里面:
</span><span class='line'>$ sudo vim /etc/dovecot/users
</span><span class='line'>
</span><span class='line'>// /etc/dovecot/conf.d/10-auth.conf
</span><span class='line'>// Add '#' to comment out the system user login for now:
</span><span class='line'>    #!include auth-system.conf.ext
</span><span class='line'>
</span><span class='line'>// Remove '#' to use passwd-file:
</span><span class='line'>!include auth-passwdfile.conf.ext
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/auth-passwdfile.conf.ext
</span><span class='line'>passdb {
</span><span class='line'>      driver = passwd-file
</span><span class='line'>        args = scheme=CRYPT username_format=%u /etc/dovecot/users
</span><span class='line'>}
</span><span class='line'>userdb {
</span><span class='line'>      driver = passwd-file
</span><span class='line'>        args = username_format=%u /etc/dovecot/users
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// Verify with doveconf -n passdb userdb that the output looks like above (and there are no other passdbs or userdbs).
</span><span class='line'>
</span><span class='line'>// Plaintext Authentication
</span><span class='line'>To allow any Authentication without SSL, disable SSL in the conf.d/10-ssl.conf file.
</span><span class='line'>/etc/dovecot/conf.d/10-ssl.conf:
</span><span class='line'>ssl = no
</span><span class='line'>
</span><span class='line'>Until SSL is configured, allow plaintext authentication in the conf.d/10-auth.conf file. You probably want to switch this back to "yes" afterward.
</span><span class='line'>/etc/dovecot/conf.d/10-auth.conf:
</span><span class='line'>disable_plaintext_auth = no</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Running Dovecot</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Start Dovecot
</span><span class='line'>$ sudo service dovecot start
</span><span class='line'>
</span><span class='line'>// Stop Dovecot
</span><span class='line'>$sudo service dovecot stop
</span><span class='line'>
</span><span class='line'>// Restart 
</span><span class='line'>$sudo service dovecot restart
</span><span class='line'>
</span><span class='line'>// Verify
</span><span class='line'>$ sudo ps auxw|grep "dovecot"</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Testing that everything works</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Check that it's listening
</span><span class='line'>$ telnet localhost 143
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to localhost.
</span><span class='line'>Escape character is '^]'.
</span><span class='line'>* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE STARTTLS AUTH=PLAIN] Dovecot ready.
</span><span class='line'>
</span><span class='line'>If you got "connection refused", make sure that Dovecot is configured to serve the imap protocol and listening on the expected interfaces/addresses. The simplest way to do that would be using doveconf(1):
</span><span class='line'>$ sudo doveconf protocols listen
</span><span class='line'>protocols = imap pop3 lmtp sieve
</span><span class='line'>listen = *, ::
</span><span class='line'>
</span><span class='line'>Next check that it also works from remote host:
</span><span class='line'>$ telnet imap.example.com 143
</span><span class='line'>Trying 1.2.3.4...
</span><span class='line'>Connected to imap.example.com.
</span><span class='line'>Escape character is '^]'.
</span><span class='line'>* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE STARTTLS AUTH=PLAIN] Dovecot ready.
</span><span class='line'>
</span><span class='line'>Check that it's allowing logins
</span><span class='line'>% telnet localhost 143
</span><span class='line'>a login "username" "password"
</span><span class='line'>a OK Logged in.
</span><span class='line'>
</span><span class='line'>Check that it's allowing remote logins
</span><span class='line'>$ telnet imap.example.com 143
</span><span class='line'>a login "username" "password"
</span><span class='line'>
</span><span class='line'>Check that it finds INBOX
</span><span class='line'>b select inbox
</span><span class='line'>* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
</span><span class='line'>* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
</span><span class='line'>* 1 EXISTS
</span><span class='line'>* 1 RECENT
</span><span class='line'>* OK [UIDVALIDITY 1106186941] UIDs valid
</span><span class='line'>* OK [UIDNEXT 2] Predicted next UID
</span><span class='line'>b OK [READ-WRITE] Select completed.
</span><span class='line'>
</span><span class='line'>Make a graceful exit
</span><span class='line'>e logout
</span><span class='line'>* BYE Logging out
</span><span class='line'>e OK Logout completed.
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Finishing the test installation</li>
</ul>


<p>最后我们要开启 ssl, 关闭明文密码验证, <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>可以提供免费的 SSL 证书:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Enable the Jessie backports repo
</span><span class='line'>For jessie add this line
</span><span class='line'>deb http://ftp.debian.org/debian jessie-backports main
</span><span class='line'>to your source.list(/etc/sources.list)
</span><span class='line'>
</span><span class='line'>Run apt-get update
</span><span class='line'>
</span><span class='line'>// Temporarily stop apache
</span><span class='line'>$ sudo service apache2 stop
</span><span class='line'>
</span><span class='line'>// sudo certbot certonly --standalone -d example.com
</span><span class='line'>
</span><span class='line'>All generated keys and issued certificates can be found in /etc/letsencrypt/live/$domain.
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/10-ssl.conf:
</span><span class='line'>ssl = yes 
</span><span class='line'>
</span><span class='line'>ssl_cert = &lt;/etc/letsencrypt/live/mail.tennshop.com/fullchain.pem
</span><span class='line'>ssl_key = &lt;/etc/letsencrypt/live/mail.tenneshop.com/privkey.pem
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/10-auth.conf:
</span><span class='line'>disable_plaintext_auth = yes 
</span><span class='line'>
</span><span class='line'>Test using imaps port (assuming you haven't disabled imaps port):
</span><span class='line'>$ openssl s_client -connect imap.example.com:993
</span><span class='line'>* OK Dovecot ready.
</span><span class='line'>
</span><span class='line'>Test using imap port and STARTTLS command (works also with imap port):
</span><span class='line'>$ openssl s_client -connect imap.example.com:143 -starttls imap
</span><span class='line'>* OK Dovecot ready.</span></code></pre></td></tr></table></div></figure>


<h2>Mail</h2>

<p>现在我们可以在 Mac 上使用 Mail.app 来收信了，但还是不能发信，postfix 默认不支持外域发信，我们需要一种方法获取内域相同的权限。为了解决这个问题， Postfix 支持 SASL.</p>

<p>Configure SASL authentication in the Postfix SMTP server</p>

<p>由于 SASL 的实现和 Postfix 是分开的，所以在 Postfix SMTP 服务器上配置 SASL 授权会有两个不同的内容：</p>

<ul>
<li>配置 SASL 实现来提供一系列合适的机制来进行 SASL 认证，决定好使用哪个 SASL 实现后，配置认证的后端，它通过系统的密码文件或其他数据库来认证远端的 SMTP 终端；</li>
<li>配置 Postfix SMTP 服务器使能 SASL 认证，去授权终端中继邮件或控制终端可以使用哪些邮件发送地址;</li>
</ul>


<p>Which SASL Implementations are supported?</p>

<p>Currently the Postfix SMTP server supports the Cyrus SASL and Dovecot SASL implementations.</p>

<p>To find out what SASL implementations are compiled into Postfix, use the following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% postconf -a (SASL support in the SMTP server)
</span><span class='line'>% postconf -A (SASL support in the SMTP+LMTP client)</span></code></pre></td></tr></table></div></figure>


<p>Configuring Dovecot SASL</p>

<p>Dovecot 独立地去认证它的 POP/IMAP 终端，Postfix 使用 Dovecot SASL 时会复用这部分配置。</p>

<p>Postfix 到 Dovecot SASL 的通信有两种途径:UNIX-domain socket or TCP socket。从更好的安全性角度出发，我们选择使用 UNIX-domain socket.</p>

<p>The following fragment for Dovecot version 2 assumes that the Postfix queue is under /var/spool/postfix/.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/dovecot/conf.d/10-master.conf:
</span><span class='line'>service auth {
</span><span class='line'>    ...
</span><span class='line'>    unix_listener /var/spool/postfix/private/auth {
</span><span class='line'>        mode = 0660
</span><span class='line'>        # Aussuming the default postfix user and group
</span><span class='line'>        user = postfix
</span><span class='line'>        group = postfix
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/etc/dovecot/conf.d/10-auth.conf
</span><span class='line'>auth_mechanisms = plain login</span></code></pre></td></tr></table></div></figure>


<p>Enabling SASL authentication and authorization in the Postfix SMTP server</p>

<p>默认 postfix 是使用 Cyrus SASL 实现，我们需要改成 dovecot</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_type = dovecot</span></code></pre></td></tr></table></div></figure>


<p>指定 Postfix 怎么和 Dovecot 认证服务器通信, 这里我们使用 UNIX-domain socket:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_path = private/auth</span></code></pre></td></tr></table></div></figure>


<p>开启 SASL 认证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_auth_enable = yes</span></code></pre></td></tr></table></div></figure>


<p>重启下 postfix, 使用 SMTP 命令验证配置是否生效:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% telnet server.example.com 25
</span><span class='line'>...
</span><span class='line'>220 server.example.com ESMTP Postfix
</span><span class='line'>EHLO client.example.com
</span><span class='line'>250-server.example.com
</span><span class='line'>250-PIPELINING
</span><span class='line'>250-SIZE 10240000
</span><span class='line'>250-AUTH DIGEST-MD5 PLAIN CRAM-MD5
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>配置 Postfix SMTP 服务器的安全原则：</p>

<p>Unencrypted SMTP session</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_security_options = noanonymous</span></code></pre></td></tr></table></div></figure>


<p>Encrypted SMTP session</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sasl_tls_security_options = $smtpd_sasl_security_options</span></code></pre></td></tr></table></div></figure>


<p>To offer SASL authentication only after a TLS-encrypted session has been established specify this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_tls_auth_only = yes</span></code></pre></td></tr></table></div></figure>


<p>After the client has authenticated with SASL, the Postfix SMTP server decides what the remote SMTP client will be authorized for. Examples of possible SMTP clients authorizations are:</p>

<ul>
<li>Send a message to a remote recipient.</li>
<li>Use a specific envelope sender in the MAIL FROM command.</li>
</ul>


<p>These permissions are not enabled by default.</p>

<p>Mail relay authorization</p>

<p>With permit_sasl_authenticated the Postfix SMTP server can allow SASL-authenticated SMTP clients to send mail to remote destinations. Examples:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># With Postfix 2.10 and later, the mail relay policy is
</span><span class='line'># preferably specified under smtpd_relay_restrictions.
</span><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_relay_restrictions =
</span><span class='line'>permit_mynetworks
</span><span class='line'>permit_sasl_authenticated
</span><span class='line'>reject_unauth_destination
</span><span class='line'># Older configurations combine relay control and spam control under
</span><span class='line'># smtpd_recipient_restrictions. To use this example with Postfix ≥
</span><span class='line'># 2.10 specify "smtpd_relay_restrictions=".
</span><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_recipient_restrictions =
</span><span class='line'>permit_mynetworks
</span><span class='line'>permit_sasl_authenticated
</span><span class='line'>reject_unauth_destination
</span><span class='line'>...other rules...</span></code></pre></td></tr></table></div></figure>


<p>Envelope sender address authorization</p>

<p>By default an SMTP client may specify any envelope sender address in the MAIL FROM command. That is because the Postfix SMTP server only knows the remote SMTP client hostname and IP address, but not the user who controls the remote SMTP client.</p>

<p>This changes the moment an SMTP client uses SASL authentication. Now, the Postfix SMTP server knows who the sender is. Given a table of envelope sender addresses and SASL login names, the Postfix SMTP server can decide if the SASL authenticated client is allowed to use a particular envelope sender address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/main.cf:
</span><span class='line'>smtpd_sender_login_maps = hash:/etc/postfix/controlled_envelope_senders
</span><span class='line'>
</span><span class='line'>smtpd_recipient_restrictions =
</span><span class='line'>...
</span><span class='line'>reject_sender_login_mismatch
</span><span class='line'>permit_sasl_authenticated
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>The controlled_envelope_senders table specifies the binding between a sender envelope address and the SASL login names that own that address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/postfix/controlled_envelope_senders
</span><span class='line'>    # envelope sender           owners (SASL login names)
</span><span class='line'>john@example.com            john@example.com
</span><span class='line'>helpdesk@example.com        john@example.com, mary@example.com
</span><span class='line'>postmaster                  admin@example.com
</span><span class='line'>@example.net                barney, fred, john@example.com, mary@example.com</span></code></pre></td></tr></table></div></figure>


<p>With this, the reject_sender_login_mismatch restriction above will reject the sender address in the MAIL FROM command if smtpd_sender_login_maps does not specify the SMTP client&rsquo;s login name as an owner of that address.</p>

<p>Testing SASL authentication in the Postfix SMTP server</p>

<p>To test the server side, connect (for example, with telnet) to the Postfix SMTP server port and you should be able to have a conversation as shown below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% telnet server.example.com 25
</span><span class='line'>...
</span><span class='line'>220 server.example.com ESMTP Postfix
</span><span class='line'>EHLO client.example.com
</span><span class='line'>250-server.example.com
</span><span class='line'>250-PIPELINING
</span><span class='line'>250-SIZE 10240000
</span><span class='line'>250-ETRN
</span><span class='line'>250-AUTH DIGEST-MD5 PLAIN CRAM-MD5
</span><span class='line'>250 8BITMIME
</span><span class='line'>AUTH PLAIN AHRlc3QAdGVzdHBhc3M=
</span><span class='line'>235 Authentication successful</span></code></pre></td></tr></table></div></figure>


<p>To test this over a connection that is encrypted with TLS, use openssl s_client instead of telnet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% openssl s_client -connect server.example.com:25 -starttls smtp
</span><span class='line'>...
</span><span class='line'>220 server.example.com ESMTP Postfix
</span><span class='line'>EHLO client.example.com
</span><span class='line'>...see above example for more...</span></code></pre></td></tr></table></div></figure>


<p>PLAIN 的授权方式要求用户名和密码一起base64编码提交， LOGIN 的话则是先提交base64编码的用户名，然后是base64编码的密码, base64编码的话可以找个<a href="https://www.base64encode.org/">在线编码工具</a>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth login 
</span><span class='line'>334 VXNlcm5hbWU6
</span><span class='line'>c2VydmljZUBoZWVwLmNx
</span><span class='line'>334 UGFzc3dvcmQ6
</span><span class='line'>xxxxxxxx
</span><span class='line'>235 Authentication successful</span></code></pre></td></tr></table></div></figure>


<p>SMTP 命令列表如下：</p>

<p>HELO</p>

<p>客户端为标识自己的身份而发送的命令（通常带域名）</p>

<p>EHLO</p>

<p>使服务器可以表明自己支持扩展简单邮件传输协议 (ESMTP) 命令。</p>

<p>MAIL FROM</p>

<p>标识邮件的发件人；以 MAIL FROM: 的形式使用。</p>

<p>RCPT TO</p>

<p>标识邮件的收件人；以 RCPT TO: 的形式使用。</p>

<p>TURN</p>

<p>允许客户端和服务器交换角色，并在相反的方向发送邮件，而不必建立新的连接。</p>

<p>ATRN</p>

<p>ATRN (Authenticated TURN) 命令可以选择将一个或多个域作为参数。如果该会话已通过身份验证，则ATRN 命令一定会被拒绝。</p>

<p>SIZE</p>

<p>提供一种使 SMTP 服务器可以指出所支持的最大邮件大小的机制。兼容的服务器必须提供大小范围，以指出可以接受的最大邮件大小。客户端发送的邮件不应大于服务器所指出的这一大小。</p>

<p>ETRN</p>

<p>SMTP 的扩展。SMTP 服务器可以发送 ETRN 以请求另一台服务器发送它所拥有的任何电子邮件。</p>

<p>PIPELINING</p>

<p>提供发送命令流（而无需在每个命令之后都等待响应）的能力。</p>

<p>CHUNKING</p>

<p>替换 DATA 命令的 ESMTP 命令。该命令使 SMTP 主机不必持续地扫描数据的末尾，它发送带参数的 BDAT 命令，该参数包含邮件的总字节数。接收方服务器计算邮件的字节数，如果邮件大小等于 BDAT 命令发送的值时，则该服务器假定它收到了全部的邮件数据。</p>

<p>DATA</p>

<p>客户端发送的、用于启动邮件内容传输的命令。</p>

<p>DSN</p>

<p>启用传递状态通知的 ESMTP 命令。</p>

<p>RSET</p>

<p>使整个邮件的处理无效，并重置缓冲区。</p>

<p>VRFY</p>

<p>确认在邮件传递过程中可以使用邮箱；例如，vrfy ted 确认在本地服务器上驻留 Ted 的邮箱。该命令在 Exchange 实现中默认关闭。</p>

<p>HELP</p>

<p>返回 SMTP 服务所支持的命令列表。</p>

<p>QUIT</p>

<p>终止会话。</p>

<p>我们可以用 SMTP 命令来测试是否能在外域正常发送邮件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;MAIL FROM: sender@example.com
</span><span class='line'>
</span><span class='line'>&gt;250 sender &lt;sender@example.com&gt; ok
</span><span class='line'>
</span><span class='line'>&gt;RCPT to: recipient@domain.com
</span><span class='line'>
</span><span class='line'>&gt;250 recipient &lt;recipient@domain.com&gt; ok
</span><span class='line'>
</span><span class='line'>&gt;DATA
</span><span class='line'>
</span><span class='line'>&gt;354 go ahead
</span><span class='line'>
</span><span class='line'>&gt;Subject: Hi smtp mail
</span><span class='line'>
</span><span class='line'>&gt;hello mail
</span><span class='line'>
</span><span class='line'>&gt;.
</span><span class='line'>
</span><span class='line'>&gt;250 ok:  Message 1763097690 accepted</span></code></pre></td></tr></table></div></figure>


<p>一切都正常工作之后，我们就可以在 Mac 和 iPhone 上配置 Mail 来收发邮件了，由于我们只让 Dovecot 支持了 IMAP,所以收件服务器我们选择 imap。用户名和密码就是我们为 Dovecot 在 /etc/dovecot/users 中配置的用户名密码。邮件地址则是我们为 Postfix 添加的邮件地址，而且这些邮件邮件地址应该在/etc/postfix/controlled_envelop_senders中和SASL 用户做了关联，这个很好理解，就是登录成功的用户他可以用那几个邮件地址发送邮件。</p>

<h2>Reference:</h2>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-postfix-e-mail-server-with-dovecot#postfix">How To Set Up a Postfix E-Mail Server with Dovecot</a><br/>
<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-16-04#conclusion">How To Install and Configure Postfix on Ubuntu 16.04</a><br/>
<a href="http://www.postfix.org/">Postfix</a><br/>
<a href="http://wiki.dovecot.org/">Dovecot</a><br/>
<a href="http://www.binarytides.com/linux-mail-command-examples/">Linux mail command examples – send mails from command line</a><br/>
<a href="http://www.cnblogs.com/cocowool/archive/2012/03/14/2395390.html">SMTP的相关命令</a></p>
</div>


<div class="meta">
	<div class="date">









  



<time datetime="2017-02-15T16:29:42+08:00" pubdate data-updated="true">15 Feb 2017</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/archivies/'>archivies</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
    
    
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style_24x24">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1395286292635329" charset="utf-8"></script>
<!-- JiaThis Button END -->

<!-- UY BEGIN -->
<!--<div id="uyan_frame"></div>-->
<!--<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js"></script>-->
<!-- UY END -->

<!-- Gitment BEGIN -->
<div id="comments"></div>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
const gitment = new Gitment({
owner: 'DamianSheldon',
repo: 'gitment',
oauth: {
client_id: '534142482825f386df90',
client_secret: '19183fe61a33fcfae35316435bf3f4d516295c38',
},
// ...
// For more available options, check out the documentation below
})

gitment.render('comments')
</script>
<!-- Gitment -->

    
    
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2014 - 2018

    Sheldon

<br>
<p>Powered by <a href="http://octopress.org">Octopress</p>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-52345084-1');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



</body>
</html>
