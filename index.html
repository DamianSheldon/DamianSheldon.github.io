
<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <title>Here's where it all happens for me.  | Hello World</title>

        <meta name="author" content="Sheldon"> 
        
        <meta name="description" content="Sheldon's personal technology blog about iOS, Android, Back-end, Web and English."> <meta name="keywords" content="iOS, Objective-C, Swift, Xcode, Java, Android Studio, Eclipse, Web, HTML, Javascript, CSS, PHP, English">

        <meta name="viewport" content="width=device-width">
        
        
        <link rel="canonical" href="http://DamianSheldon.github.io/index.html">

        <link href="/atom.xml" rel="alternate" title="Hello World" type="application/atom+xml">
        <link href="/favicon.png" rel="icon">
        <link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
        
        <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
        <script src="/javascripts/navigation-toggle.js" type="text/javascript"></script>
        
    </head>



<body>
	<header id="header" class="inner"><h1><a href="/">Hello World</a></h1>
<h4>Here's where it all happens for me.</h4>

<!-- Navigation -->

<nav role="navigation">
    <div class="inner">
        <a href="#nav" class="nav-collapse" id="nav-collapse">Navigation</a>
        <ul class="nav" id="nav">
    <li class="active"><a href="/">Blog</a></li>
    <li><a href="/archives">Archive</a></li>
    <li><a href="/ios-development">iOS</a></li>
    <li><a href="/android">Android</a></li>
    <li><a href="/web-development">Web</a></li>
    <li><a href="/english">English</a></li>
    <li><a href="/about">About</a></li>
    
    <form action="https://www.bing.com/search" method="get" accept-charset="utf-8" target="_blank">
        <input type="text" name="q" maxlength="255" placeholder="Search">
        <input type="hidden" name="q1" value="site:DamianSheldon.github.io">
    </form>
</ul>
    </div>
</nav>

<a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a>
</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/exception-handling-in-spring-mvc.html">
		
			Spring MVC 中的异常处理</a>
	</h2>
        
    <div class="meta">
	   <div class="date">









  



<time datetime="2022-09-30T10:06:54+08:00" pubdate data-updated="true">30 Sep 2022</time></div>
	   

<div class="tags">

	<a class='category' href='/blog/categories/archives/'>archives</a>, <a class='category' href='/blog/categories/web-development/'>web development</a>

</div>


    </div>
        
	<div class="entry-content">
		<p>使用 Spring 来开发 web 应用时很有必要建立一个统一的异常处理体系。想要建立这个体系，我们先要搞清楚 Spring MVC 中的异常处理机制。 Spring MVC 是基于 Servlet，所以它遵循 Servlet 规范。</p>

<p>Servlet 规范中有详细的错误处理说明，简单来说就是 Servlet 在处理请求时可能会抛出异常或者调用 <code>sendError</code> ，这时 Servlet-Container 就要产生相应的错误界面，错误界面是允许自定义的。Spring MVC 的核心之一是 DispatchServlet，它是一个前端控制器，所有的请求处理都由它来驱动，从名字可以看出，它也是一个 Servlet，所以它的错误处理机制自然要遵循 Servlet 规范。从完整性的角度来看，还一种错误处理方法，Servlet 可以自己设置 HTTP 的 status code 和 body，也就是不和 Servlet-Container 联动来处理错误，而是完全自主地处理。</p>

<p>我们先来看 DispatcherServlet 的异常处理机制，Spring 团队将异常处理功能集中到 HandlerExceptionResolver 接口的实现类中，DispatcherServlet 在初始化过程会把 IoC 容器中所有的 HandlerExceptionResolver 的实现类排好序后组装起来用于异常处理。</p>

<p>现在我们使用 Spring 来开发 web 应用时应该都会选择 Spring Boot 来配置 Spring，和异常相关的自动配置类为 ErrorMvcAutoConfiguration 和 WebMvcAutoConfiguration， 它们默认配置两个 HandlerExceptionResolver: DefaultErrorAttributes 和 HandleExceptionResolverComposite。</p>

<p>HandleExceptionResolverComposite 默认包含以下三个 HandlerExceptionResolver:</p>

<blockquote><ul>
<li>ExceptionHandlerExceptionResolver matches uncaught exceptions against suitable @ExceptionHandler methods on both the handler (controller) and on any controller-advices.</li>
<li>ResponseStatusExceptionResolver looks for uncaught exceptions annotated by @ResponseStatus (as described in Section 1)</li>
<li>DefaultHandlerExceptionResolver converts standard Spring exceptions and converts them to HTTP Status Codes (I have not mentioned this above as it is internal to Spring MVC).</li>
</ul>
</blockquote>

<p>Spring 官方博客帮我们总结了 Spring Boot 默认配置的异常处理流程：</p>

<blockquote><ol>
<li>In the event of any unhanded error, Spring Boot forwards internally to /error.</li>
<li>Boot sets up a BasicErrorController to handle any request to /error. The controller adds error information to the internal Model and returns error as the logical view name.</li>
<li>If any view-resolver(s) are configured, they will try to use a corresponding error-view.</li>
<li>Otherwise, a default error page is provided using a dedicated View object (making it independent of any view-resolution system you may be using).</li>
<li>Spring Boot sets up a BeanNameViewResolver so that /error can be mapped to a View of the same name.</li>
<li>If you look in Boot’s ErrorMvcAutoConfiguration class you will see that the defaultErrorView is returned as a bean called error. This is the View bean found by the BeanNameViewResolver.</li>
</ol>
</blockquote>

<p>对于 Servlet-Container 层面的错误处理，Spring 官方博客的介绍如下：</p>

<blockquote><p>Container-Wide Exception Handling</p>

<p>Exceptions thrown outside the Spring Framework, such as from a servlet Filter, are also reported by Spring Boot’s fallback error page.
To do this Spring Boot has to register a default error page for the container. In Servlet 2, there is an <code>&lt;error-page&gt;</code> directive that you can add to your web.xml to do this. Sadly Servlet 3 does not offer a Java API equivalent. Instead Spring Boot does the following:</p>

<ul>
<li>For a Jar application, with an embedded container, it registers a default error page using Container specific API.</li>
<li>For a Spring Boot application deployed as a traditional WAR file, a Servlet Filter is used to catch exceptions raised further down the line and handle it.</li>
</ul>
</blockquote>

<p>我们可以按照上述线索在 Spring Boot 的自动配置代码中找到相关的代码。</p>

<p>当开发 REST API 项目时，我希望业务抛出的异常能契合 Spring Boot 默认配置的异常处理机制，让整个异常体系尽量统一，接口返回给终端统一格式的错误信息，这样终端也能统一处理接口错误。那么我们应该如何做？</p>

<p>我们这里需要的是一个全局的异常处理机制，Spring MVC 提供给我们两种配置全局异常处理的方法：</p>

<ul>
<li>配置 HandlerExceptionResolver</li>
<li>使用 <code>@ControllerAdvice</code> 注解的类</li>
</ul>


<p>相比之下，个人觉得使用 <code>@ControllerAdvice</code> 注解的类会方便一些，能达到感知框架的存在。我们可以定义一个异常处理基类，发布成一个库，然后在需要用到的项目中引入这个库，在项目中继承该基类定义一个 <code>@ControllerAdvice</code> 注解的异常处理类。</p>

<p>选好全局异常处理机制后，那么我们应该如何来设计项目的业务异常类呢?</p>

<p>Spring 官方博客给出了如下建议:</p>

<blockquote><p>As usual, Spring likes to offer you choice, so what should you do? Here are some rules of thumb. However if you have a preference for XML configuration or Annotations, that’s fine too.</p>

<ul>
<li>For exceptions you write, consider adding @ResponseStatus to them.</li>
<li>For all other exceptions implement an @ExceptionHandler method on a @ControllerAdvice class or use an instance of SimpleMappingExceptionResolver. You may well have SimpleMappingExceptionResolver configured for your application already, in which case it may be easier to add new exception classes to it than implement a @ControllerAdvice.</li>
<li>For Controller specific exception handling add @ExceptionHandler methods to your controller.</li>
<li>Warning: Be careful mixing too many of these options in the same application. If the same exception can be handed in more than one way, you may not get the behavior you wanted. @ExceptionHandler methods on the Controller are always selected before those on any @ControllerAdvice instance. It is undefined what order controller-advices are processed.</li>
</ul>
</blockquote>


		
		<a href="/blog/exception-handling-in-spring-mvc.html" class="more-link">继续阅读</a>
	</div>


        
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/web-development-notes-part-five.html">
		
			Web 开发问题汇总(五)</a>
	</h2>
        
    <div class="meta">
	   <div class="date">









  



<time datetime="2022-07-01T09:32:39+08:00" pubdate data-updated="true">01 Jul 2022</time></div>
	   

<div class="tags">

	<a class='category' href='/blog/categories/archives/'>archives</a>, <a class='category' href='/blog/categories/web-development/'>web development</a>

</div>


    </div>
        
	<div class="entry-content">
		<h3>1.</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ jmap -heap 29104
</span><span class='line'>Attaching to process ID 29104, please wait...
</span><span class='line'>ERROR: attach: task_for_pid(29104) failed: '(os/kern) failure' (5)
</span><span class='line'>Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process. Could be caused by an incorrect pid or lack of privileges.
</span><span class='line'>sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process. Could be caused by an incorrect pid or lack of privileges.
</span><span class='line'>  at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal$BsdDebuggerLocalWorkerThread.execute(BsdDebuggerLocal.java:169)
</span><span class='line'>  at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal.attach(BsdDebuggerLocal.java:287)
</span><span class='line'>  at sun.jvm.hotspot.HotSpotAgent.attachDebugger(HotSpotAgent.java:671)
</span><span class='line'>  at sun.jvm.hotspot.HotSpotAgent.setupDebuggerDarwin(HotSpotAgent.java:659)
</span><span class='line'>  at sun.jvm.hotspot.HotSpotAgent.setupDebugger(HotSpotAgent.java:341)
</span><span class='line'>  at sun.jvm.hotspot.HotSpotAgent.go(HotSpotAgent.java:304)
</span><span class='line'>  at sun.jvm.hotspot.HotSpotAgent.attach(HotSpotAgent.java:140)
</span><span class='line'>  at sun.jvm.hotspot.tools.Tool.start(Tool.java:185)
</span><span class='line'>  at sun.jvm.hotspot.tools.Tool.execute(Tool.java:118)
</span><span class='line'>  at sun.jvm.hotspot.tools.HeapSummary.main(HeapSummary.java:49)
</span><span class='line'>  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
</span><span class='line'>  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
</span><span class='line'>  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</span><span class='line'>  at java.lang.reflect.Method.invoke(Method.java:498)
</span><span class='line'>  at sun.tools.jmap.JMap.runTool(JMap.java:201)
</span><span class='line'>  at sun.tools.jmap.JMap.main(JMap.java:130)
</span><span class='line'>Caused by: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process. Could be caused by an incorrect pid or lack of privileges.
</span><span class='line'>  at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal.attach0(Native Method)
</span><span class='line'>  at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal.access$100(BsdDebuggerLocal.java:65)
</span><span class='line'>  at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal$1AttachTask.doit(BsdDebuggerLocal.java:278)
</span><span class='line'>  at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal$BsdDebuggerLocalWorkerThread.run(BsdDebuggerLocal.java:144)</span></code></pre></td></tr></table></div></figure>


<p>A: macOS 上的 java 虚拟机基础工具不能附加到 java 进程上，操作系统环境为:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sw_vers
</span><span class='line'>ProductName:  Mac OS X
</span><span class='line'>ProductVersion:   10.15.7
</span><span class='line'>BuildVersion: 19H1922</span></code></pre></td></tr></table></div></figure>


<p>java 版本:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ java -version
</span><span class='line'>java version "1.8.0_121"
</span><span class='line'>Java(TM) SE Runtime Environment (build 1.8.0_121-b13)
</span><span class='line'>Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</span></code></pre></td></tr></table></div></figure>


<p>google 了一番之后，问题可能是 <a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=8160376">macOS 上的 java 8 部分小版本有问题</a>，于是我打算用虚拟机里面的 RockyLinux 来试下，结果是确定可以。</p>


		
		<a href="/blog/web-development-notes-part-five.html" class="more-link">继续阅读</a>
	</div>


        
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/redis-interview-questions.html">
		
			Redis 面试题</a>
	</h2>
        
    <div class="meta">
	   <div class="date">









  



<time datetime="2022-04-27T14:36:10+08:00" pubdate data-updated="true">27 Apr 2022</time></div>
	   

<div class="tags">

	<a class='category' href='/blog/categories/archives/'>archives</a>, <a class='category' href='/blog/categories/web-development/'>web development</a>

</div>


    </div>
        
	<div class="entry-content">
		<h2>1.什么是 Redis?</h2>

<blockquote><p>Redis is an open source (BSD licensed), in-memory data structure store used as a database, cache, message broker, and streaming engine.</p></blockquote>

<p>Redis是一个开源的内存数据结构存储，被用作数据库、缓存、消息代理和流媒体引擎。</p>

<h2>2.Redis的内存占用量是多少？</h2>

<p>我们看几个例子（都是使用64位实例得到的。</p>

<ul>
<li>一个空的实例使用~3MB的内存。</li>
<li>100万个小键->字符串值对使用~85MB的内存。</li>
<li>100万个键->哈希值，代表一个有5个字段的对象，使用~160 MB的内存。</li>
</ul>


<h2>3.为什么Redis将其整个数据集保存在内存中？</h2>

<p>在过去，Redis的开发者尝试了虚拟内存和其他系统来允许大于RAM的数据集，但最终我们很高兴能做好一件事：数据从内存中提供，磁盘用于存储。所以现在还没有计划为Redis创建一个磁盘上的后端。Redis是当前设计的结果。</p>

<h2>4.你能将Redis与基于磁盘的数据库一起使用吗？</h2>

<p>可以，一个常见的设计模式是在Redis中保存频繁写的小数据（以及你需要Redis数据结构以有效方式为你的问题建模的数据），而大块的数据保存到 SQL或最终一致的磁盘数据库。同样，有时Redis被用来在内存中获取存储在磁盘数据库中的相同数据子集的另一个副本。这看起来类似于缓存，但实际上是一个更高级的模型，因为通常Redis数据集与磁盘数据库数据集一起更新，而不是在缓存错过时刷新。</p>

<h2>5.如何减少Redis的整体内存用量？</h2>

<p>如果可以的话，使用Redis的32位实例。同时善用小的哈希值、列表、排序集和整数集，因为Redis能够在少数元素的特殊情况下以更紧凑的方式表示这些数据类型。</p>

<h2>6.如果Redis的内存用完了会怎样？</h2>

<p>Redis有内置的保护措施，允许用户设置内存使用的最大限制，使用配置文件中的maxmemory选项，对Redis可以使用的内存进行限制。如果达到这个限制，Redis将开始对写命令回复错误（但会继续接受只读命令）。</p>

<p>你也可以配置Redis在达到最大内存限制时驱逐键值。</p>


		
		<a href="/blog/redis-interview-questions.html" class="more-link">继续阅读</a>
	</div>


        
</article>


<nav id="pagenavi">
    
    
        <a href="/posts/2" class="next">Next</a>
    
    
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014 - 2022

    Sheldon

<br>
<p>Powered by <a href="http://octopress.org">Octopress</p>
</footer>
	



<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-52345084-1');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




</body>
</html>
